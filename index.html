<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬</title>
    <style>
        /* 1. ê¸°ë³¸ ì„¤ì • */
        * { box-sizing: border-box; }
        body { 
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif; 
            background-color: #f2f4f6; 
            margin: 0; padding: 0; color: #333; 
        }
        
        .content-wrapper { max-width: 1200px; width: 96%; margin: 0 auto; }

        /* ìƒë‹¨ ê³ ì • í—¤ë” */
        .control-box-bg { 
            background: white; position: sticky; top: 0; z-index: 1000; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
            padding: 15px 0; 
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ (4ê°œë¡œ í™•ì¥) */
        .button-row { display: flex; gap: 8px; width: 100%; margin-bottom: 15px; }
        .button-row button {
            flex: 1; padding: 12px 0; border: none; border-radius: 12px; 
            font-size: 0.9em; font-weight: bold; color: white; cursor: pointer;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1); transition: transform 0.1s;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .button-row button:active { transform: scale(0.96); }
        
        #btn-voice { background: linear-gradient(135deg, #ff7675, #d63031); } 
        #btn-refresh { background: linear-gradient(135deg, #00b894, #00cec9); }
        #btn-add { background: linear-gradient(135deg, #a29bfe, #6c5ce7); } /* ë³´ë¼ìƒ‰ */
        #btn-login { background: linear-gradient(135deg, #0984e3, #74b9ff); } 

        /* ì œëª© ìŠ¤íƒ€ì¼ */
        h1 { margin: 15px 0; font-size: 1.6em; color: #1e272e; text-align: center; font-weight: 800; letter-spacing: -0.5px; }
        
        .input-group { display: flex; gap: 8px; }
        input[type="text"] { 
            flex: 1; padding: 12px 15px; border: 1px solid #dfe6e9; 
            border-radius: 10px; font-size: 16px; background: #f8f9fa; outline: none;
        }
        input[type="text"]:focus { border-color: #0984e3; background: white; }
        #btn-search {
            width: 80px; background: #636e72; color: white; border: none;
            border-radius: 10px; font-weight: bold; cursor: pointer;
        }

        .voice-text { color: #e17055; font-weight: bold; min-height: 20px; margin: 5px 0; font-size: 0.9em; text-align: center;}
        #user-info { text-align: right; font-size: 0.8em; color: #b2bec3; margin-top: 5px; height: 15px;}
        
        /* ìƒíƒœ ë©”ì‹œì§€ ë° ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        #status { text-align: center; margin-top: 30px; color: #636e72; font-size: 1em; font-weight: 500; min-height: 30px; line-height: 1.5; }
        
        /* ğŸ”„ íšŒì „ ì• ë‹ˆë©”ì´ì…˜ */
        .spin-icon { 
            display: inline-block; 
            animation: spin 1.5s linear infinite; 
            font-size: 1.2em; 
            margin-right: 8px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* ë¦¬ìŠ¤íŠ¸ ì˜ì—­ */
        #bid-list { margin-top: 20px; }
        
        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { 
            background: white; padding: 25px; margin-bottom: 15px; 
            border-radius: 16px; border-left: 6px solid #ddd; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.03); 
            transition: transform 0.2s; width: 100%;
        }
        .card:hover { transform: translateY(-3px); }
        .card.urgent { border-left-color: #ff7675; }
        .card.normal { border-left-color: #0984e3; }
        
        .card-header { display: flex; justify-content: space-between; font-size: 0.9em; color: #888; margin-bottom: 10px; font-weight: 600;}
        .card-title { font-size: 1.3em; font-weight: bold; color: #2d3436; text-decoration: none; display: block; margin-bottom: 12px; line-height: 1.4; }
        .d-day { background: #ffeaa7; color: #d35400; padding: 3px 10px; border-radius: 20px; font-size: 0.85em; }
        .card-info { font-size: 1em; color: #636e72; line-height: 1.6; }
        
        /* AI ë¶„ì„ ë°•ìŠ¤ */
        .ai-analysis-box {
            display: none; background-color: #f3e5f5; padding: 15px; 
            margin-top: 15px; border-radius: 10px; font-size: 0.95em; color: #4a148c;
            border: 1px solid #e1bee7; line-height: 1.6;
        }

        .card-footer { display: flex; justify-content: flex-end; gap: 8px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #f1f1f1; }
        .card-footer button, .card-footer a { 
            padding: 10px 20px; border-radius: 8px; border:none; 
            font-size:0.9em; cursor:pointer; font-weight:bold; text-decoration: none; display: inline-block;
        }
        .btn-link { background: #dfe6e9; color: #2d3436; }
        .btn-cal { background: #e3f2fd; color: #0984e3; }
        .btn-ai { background: linear-gradient(135deg, #a29bfe, #6c5ce7); color: white; } 
        
        /* ëª¨ë‹¬ì°½ ìŠ¤íƒ€ì¼ (ë“±ë¡ìš©) */
        #add-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center; }
        .modal-content { background:white; padding:25px; border-radius:15px; width:90%; max-width:500px; }
        textarea { width:100%; height:150px; padding:10px; margin:10px 0; border-radius:8px; border:1px solid #ddd; font-size:14px; font-family: sans-serif; resize: none; }
        .modal-btns { display:flex; justify-content:flex-end; gap:10px; }
        
        /* ìº˜ë¦°ë” ì˜ì—­ */
        .calendar-area { margin-top: 20px; display:none; }
        iframe { width: 100%; height: 600px; border:none; border-radius:16px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

    <div class="control-box-bg">
        <div class="content-wrapper">
            <div class="button-row">
                <button id="btn-voice">ğŸ¤ ìŒì„±</button>
                <button id="btn-refresh">ğŸ”„ ê³µê³ ê²€ìƒ‰</button>
                <button id="btn-add">ğŸ“ ì§ì ‘ë“±ë¡</button> 
                <button id="btn-login">ğŸ“… ë¡œê·¸ì¸</button>
            </div>

            <h1>ğŸ’§ í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬</h1>

            <div class="voice-text" id="voice-result"></div>

            <div class="input-group">
                <input type="text" id="search-input" placeholder="ì˜ˆ: ë‹¤ìŒ ì£¼ ë§ˆê°ë˜ëŠ” ì €ë¥˜ì¡° ê³µê³  ì°¾ì•„ì¤˜">
                <button id="btn-search">ê²€ìƒ‰</button>
            </div>
            <div id="user-info"></div>
        </div>
    </div>

    <div id="status">
        <span class="spin-icon">â³</span> ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...
    </div>
    
    <div id="bid-list" class="content-wrapper"></div>
    
    <div class="calendar-area content-wrapper" id="cal-area">
        <h3 style="text-align:center; color:#2c3e50;">ğŸ“… ì…ì°° ì¼ì •í‘œ</h3>
        <iframe id="cal-frame" src=""></iframe>
    </div>

    <div id="add-modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:#2c3e50;">ğŸ“ ì™¸ë¶€ ê³µê³  ìŠ¤ë§ˆíŠ¸ ë“±ë¡</h3>
            <p style="font-size:0.9em; color:#666; line-height:1.4;">
                ì™¸ë¶€ ì‚¬ì´íŠ¸(ë„¤ì´ë²„/êµ¬ê¸€ ë“±)ì—ì„œ ë³µì‚¬í•œ ê³µê³  ë‚´ìš©ì„ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.<br>
                AIê°€ ìë™ìœ¼ë¡œ ë‚´ìš©ì„ ì •ë¦¬í•´ì„œ ì—‘ì…€ì— ì €ì¥í•´ì¤ë‹ˆë‹¤.
            </p>
            <textarea id="paste-area" placeholder="[ì˜ˆì‹œ]&#13;&#10;ê³µê³ ëª…: ì„œìš¸ì‹œ ë¹—ë¬¼ì €ë¥˜ì¡° ì„¤ì¹˜ê³µì‚¬&#13;&#10;ë§ˆê°ì¼: 2025ë…„ 12ì›” 1ì¼ 18:00&#13;&#10;ë°œì£¼ì²˜: ì„œìš¸íŠ¹ë³„ì‹œì²­&#13;&#10;..."></textarea>
            <div class="modal-btns">
                <button onclick="closeModal()" style="background:#b2bec3; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">ì·¨ì†Œ</button>
                <button onclick="processSmartAdd()" style="background:#6c5ce7; color:white; font-weight:bold; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">âœ¨ AI ë¶„ì„ ë° ì €ì¥</button>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        // ============================================================
        // ğŸ”‘ [1] Gemini API í‚¤
        const GEMINI_API_KEY = 'AIzaSyDaRFQQE-I3lwCnIiKcRWIUYxQLHrrfO1M';
        
        // ğŸ”‘ [2] ìº˜ë¦°ë” ID
        const BID_CALENDAR_ID = 'd51a10e0014dcbd83e98d0da91cda4f52f629c19652c15fc693ee4529bbbab04@group.calendar.google.com'; 

        // ğŸš¨ [3] Apps Script ì£¼ì†Œ
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxi0Bfdty9LuMJyxCGTqTkyJQJrevz3AqRunbhNmePCh68tta-Fu8w1Lw4E_DROWB99zw/exec'; 
        // ============================================================

        const CLIENT_ID = '1049915608396-i3jn8jrm24bc9mkagdtokk3rfa3li513.apps.googleusercontent.com'; 
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events';
        const STORAGE_KEY = 'hksuan_google_token_v2'; 
        
        let allData = [];
        let tokenClient;
        let isLogin = false;

        // 0. ìº˜ë¦°ë” ë·° ì„¤ì •
        function setupCalendarView() {
            const iframe = document.getElementById('cal-frame');
            let calSrc = `https://calendar.google.com/calendar/embed?src=${BID_CALENDAR_ID}&ctz=Asia%2FSeoul&hl=ko`;
            if (BID_CALENDAR_ID === 'primary') calSrc = "https://calendar.google.com/calendar/embed?src=primary&ctz=Asia%2FSeoul&hl=ko";
            iframe.src = calSrc;
        }

        // ---------- ê³µí†µ: Gemini í˜¸ì¶œ í•¨ìˆ˜ ----------
        async function callGemini(prompt) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000); 

            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                        signal: controller.signal
                    }
                );

                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || `HTTP ${response.status}`);
                return data;
            } finally {
                clearTimeout(timeoutId);
            }
        }

        function extractGeminiText(data) {
            const parts = data?.candidates?.[0]?.content?.parts || [];
            let text = parts.map(p => p.text || '').join('\n');
            text = text.replace(/```json/g, '').replace(/```/g, '').trim();
            const jsonMatch = text.match(/\{[\s\S]*\}/);
            if (jsonMatch) text = jsonMatch[0];
            return text;
        }

        // ---------- 1. ë°ì´í„° ë¡œë“œ ----------
        async function loadData() {
            const status = document.getElementById('status');
            status.innerHTML = `<span class="spin-icon">â³</span> ì…ì°° ê³µê³ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...`;
            try {
                // (ì£¼ì˜) Apps Script ë¼ì´ë¸ŒëŸ¬ë¦¬ ì£¼ì†ŒëŠ” GET ìš”ì²­ì´ ì•ˆ ë  ìˆ˜ ìˆìŒ.
                // ë§Œì•½ ì—¬ê¸°ì„œ ì—ëŸ¬ê°€ ë‚˜ë©´ 'ë°°í¬ëœ ì›¹ ì•± URL (execë¡œ ëë‚˜ëŠ” ê²ƒ)'ì„ ì‚¬ìš©í•´ì•¼ í•¨.
                const res = await fetch(SCRIPT_URL);
                
                // ì‘ë‹µì´ HTML ì—ëŸ¬ í˜ì´ì§€ì¸ì§€ í™•ì¸
                const text = await res.text();
                if (text.includes("<!DOCTYPE html>") || text.includes("Google Drive")) {
                     throw new Error("ì˜ëª»ëœ ìŠ¤í¬ë¦½íŠ¸ ì£¼ì†Œì…ë‹ˆë‹¤. 'ì›¹ ì•± URL(exec)'ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
                }

                const json = JSON.parse(text);
                allData = json;
                renderList(allData);
                status.innerHTML = `âœ… ì´ <b>${allData.length}</b>ê±´ì˜ ê³µê³ ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`;
            } catch (e) {
                status.innerHTML = `<span style="color:red">âŒ ì˜¤ë¥˜ ë°œìƒ: ${e.message}</span><br><span style="font-size:0.8em; color:#666;">(Apps Script ì£¼ì†Œë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”)</span>`;
                console.error(e);
            }
        }

        // ğŸ”¥ [ì‹ ê·œ] ëª¨ë‹¬ì°½ ì œì–´
        document.getElementById('btn-add').onclick = () => {
            document.getElementById('add-modal').style.display = 'flex';
        };
        function closeModal() {
            document.getElementById('add-modal').style.display = 'none';
            document.getElementById('paste-area').value = '';
        }

        // ğŸ”¥ [ì‹ ê·œ] ìŠ¤ë§ˆíŠ¸ ë“±ë¡ ê¸°ëŠ¥
        async function processSmartAdd() {
            const text = document.getElementById('paste-area').value;
            if (!text) { alert("ë‚´ìš©ì„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”!"); return; }

            const btn = document.querySelector('#add-modal button:last-child');
            btn.innerText = "ğŸ§  ë¶„ì„ ë° ì €ì¥ ì¤‘...";
            btn.disabled = true;

            const prompt = `
                ì‚¬ìš©ìê°€ ë¶™ì—¬ë„£ì€ ê³µê³  í…ìŠ¤íŠ¸ì•¼. 
                [ê³µê³ ëª…, ê³µê³ ë²ˆí˜¸(ì—†ìœ¼ë©´ 'ì •ë³´ì—†ìŒ'), ê³µê³ ì¼(YYYY-MM-DD), ë§ˆê°ì¼(YYYY-MM-DD HH:mm), ë°œì£¼ì²˜, ë§í¬(ì—†ìœ¼ë©´ '#')]ë¥¼ ì¶”ì¶œí•´ì¤˜.
                ê²°ê³¼ëŠ” ì˜¤ì§ JSONìœ¼ë¡œë§Œ ì¤˜.
                í…ìŠ¤íŠ¸: "${text}"
                JSONí˜•ì‹: {"title": "...", "no": "...", "date": "...", "deadline": "...", "agency": "...", "link": "..."}
            `;
            
            try {
                const aiData = await callGemini(prompt);
                const aiText = extractGeminiText(aiData);
                const result = JSON.parse(aiText);

                const saveUrl = `${SCRIPT_URL}?action=add` + 
                    `&title=${encodeURIComponent(result.title)}` +
                    `&no=${encodeURIComponent(result.no)}` +
                    `&date=${encodeURIComponent(result.date)}` +
                    `&deadline=${encodeURIComponent(result.deadline)}` +
                    `&agency=${encodeURIComponent(result.agency)}` +
                    `&link=${encodeURIComponent(result.link)}`;

                // no-cors ëª¨ë“œë¡œ ì „ì†¡ (Apps Script íŠ¹ì„±ìƒ)
                await fetch(saveUrl, { mode: 'no-cors' }); 
                
                alert(`âœ… ì €ì¥ ìš”ì²­ ì™„ë£Œ!\n[${result.title}]\n(ì ì‹œ í›„ ëª©ë¡ì´ ê°±ì‹ ë©ë‹ˆë‹¤)`);
                closeModal();
                setTimeout(loadData, 2000); 

            } catch (e) {
                alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
            } finally {
                btn.innerText = "âœ¨ AI ë¶„ì„ ë° ì €ì¥";
                btn.disabled = false;
            }
        }

        function renderList(data) {
            const list = document.getElementById('bid-list');
            list.innerHTML = "";
            const query = document.getElementById('search-input').value;

            if(data.length === 0) {
                let html = `
                    <div style='text-align:center; padding:50px 20px; color:#636e72;'>
                        <p style='font-size:3em; margin-bottom:10px;'>ğŸ¤”</p>
                        <p style="font-weight:bold; font-size:1.1em;">ë‚´ë¶€ DBì—ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                `;
                if (query) {
                     html += `
                        <p style="font-size:0.9em; margin-bottom:20px;">ì›¹ ì „ì²´ì—ì„œ ê²€ìƒ‰í•´ ë³´ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                        <div style="display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
                            <button onclick="window.open('https://www.google.com/search?q=${encodeURIComponent(query + ' ì…ì°° ê³µê³ ')}')" 
                                    style="padding:10px 20px; background:#4285F4; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; display:flex; align-items:center; gap:5px;">
                                ğŸŒ êµ¬ê¸€ ê²€ìƒ‰
                            </button>
                            <button onclick="window.open('https://search.naver.com/search.naver?query=${encodeURIComponent(query + ' ì…ì°° ê³µê³ ')}')" 
                                    style="padding:10px 20px; background:#03C75A; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; display:flex; align-items:center; gap:5px;">
                                âœ… ë„¤ì´ë²„ ê²€ìƒ‰
                            </button>
                        </div>
                    `;
                }
                html += `</div>`;
                list.innerHTML = html;
                return;
            }

            data.forEach((item, index) => {
                const today = new Date();
                const end = new Date(item.deadline);
                const diff = Math.ceil((end - today) / (1000*60*60*24));
                let dDay = diff < 0 ? "ë§ˆê°ë¨" : `D-${diff}`;
                if (diff === 0) dDay = "ì˜¤ëŠ˜ë§ˆê°";
                const cardClass = diff <= 3 ? "urgent" : "normal";

                const div = document.createElement('div');
                div.className = `card ${cardClass}`;
                div.innerHTML = `
                    <div class="card-header">
                        <span>ğŸ¢ ${item.agency}</span>
                        <span class="d-day">${dDay}</span>
                    </div>
                    <a href="${item.link}" target="_blank" class="card-title">${item.title}</a>
                    <div class="card-info">
                        ë§ˆê°: <span style="color:#d63031; font-weight:bold">${item.deadline}</span> <br>
                        ìƒíƒœ: ${item.status}
                    </div>
                    <div id="ai-result-${index}" class="ai-analysis-box"></div>
                    <div class="card-footer">
                        <button class="btn-ai" data-index="${index}">ğŸ¤– AI ë¶„ì„</button>
                        <a href="${item.link}" target="_blank" class="btn-link">ğŸ“„ ê³µê³ ë¬¸</a>
                        <button class="btn-cal" data-index="${index}">ğŸ“… ìº˜ë¦°ë”</button>
                    </div>
                `;
                list.appendChild(div);
            });

            // ì´ë²¤íŠ¸ ë°”ì¸ë”©
            document.querySelectorAll('.btn-ai').forEach(btn => {
                btn.onclick = () => {
                    const i = parseInt(btn.dataset.index, 10);
                    analyzeBidWithAI(allData[i].title, allData[i].agency, allData[i].deadline, i);
                };
            });
            document.querySelectorAll('.btn-cal').forEach(btn => {
                btn.onclick = () => {
                    const i = parseInt(btn.dataset.index, 10);
                    addToCal(allData[i].title, allData[i].deadline);
                };
            });
        }

        function simpleSearch(keyword) {
            const q = keyword.toLowerCase();
            const filtered = allData.filter(item => 
                item.title.toLowerCase().includes(q) ||
                item.agency.toLowerCase().includes(q)
            );
            renderList(filtered);
            const status = document.getElementById('status');
            status.innerHTML = filtered.length > 0 
                ? `ğŸ” "<b>${keyword}</b>" ê²€ìƒ‰ ê²°ê³¼: ${filtered.length}ê±´`
                : `ğŸ” "<b>${keyword}</b>" ë‚´ë¶€ DB ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ`;
        }

        async function searchWithAI(query) {
            if (!query) { renderList(allData); return; }
            const status = document.getElementById('status');
            
            const basicFilter = allData.filter(item => item.title.includes(query) || item.agency.includes(query));
            if (basicFilter.length > 0 && !query.match(/(ë‚´ì¼|ëª¨ë ˆ|ì£¼|ë‹¬|ì›”|ë§ˆê°|ì–¸ì œ)/)) {
                 renderList(basicFilter);
                 status.innerHTML = `ğŸ” "<b>${query}</b>" ê²€ìƒ‰ ê²°ê³¼: ${basicFilter.length}ê±´`;
                 return;
            }

            status.innerHTML = `<span class="spin-icon">ğŸ§ </span> AIê°€ ê²€ìƒ‰ ì¡°ê±´ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...`;

            const today = new Date().toISOString().split('T')[0];
            const prompt = `
                Today is ${today}. Analyze user input: "${query}"
                Extract keywords and date ranges.
                Response format: JSON object ONLY. No markdown, no explanations.
                Example: {"keyword": "string", "startDate": "YYYY-MM-DD", "endDate": "YYYY-MM-DD"}
            `;

            try {
                const data = await callGemini(prompt);
                const text = extractGeminiText(data);
                const result = JSON.parse(text);

                const filtered = allData.filter(item => {
                    let dateMatch = true, keywordMatch = true;
                    if (result.startDate && result.endDate) {
                        const itemDate = item.deadline.split(' ')[0]; 
                        dateMatch = itemDate >= result.startDate && itemDate <= result.endDate;
                    }
                    if (result.keyword) {
                        const k = result.keyword.toLowerCase();
                        keywordMatch = item.title.toLowerCase().includes(k) || item.agency.toLowerCase().includes(k);
                    }
                    return dateMatch && keywordMatch;
                });

                renderList(filtered);
                status.innerHTML = filtered.length > 0 
                    ? `ğŸ¤– AI ê²€ìƒ‰ ê²°ê³¼: <b>${filtered.length}</b>ê±´` 
                    : `ğŸ¤– AI ë¶„ì„ ì™„ë£Œ: <b>ë‚´ë¶€ DBì— ì¡°ê±´ì— ë§ëŠ” ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</b>`;

            } catch (e) {
                console.error("AI Error:", e);
                simpleSearch(query);
            }
        }

        async function analyzeBidWithAI(title, agency, deadline, index) {
            const box = document.getElementById(`ai-result-${index}`);
            if (box.style.display === 'block') { box.style.display = 'none'; return; }

            box.style.display = 'block';
            box.innerHTML = `<span class="spin-icon">ğŸ§ </span> ë¶„ì„ ì¤‘...`;

            const prompt = `ë‚˜ëŠ” 'ë¹—ë¬¼ì €ë¥˜ì¡°' ê¸°ì—… ì§ì›ì´ì•¼. ì´ ê³µê³  ë¶„ì„í•´ì¤˜. [ê³µê³ ] ${title} / ${agency} / ${deadline}. 1.ìš”ì•½ 2.ì í•©ë„ 3.íŒ (HTML íƒœê·¸ ì—†ì´)`;

            try {
                const data = await callGemini(prompt);
                const text = data.candidates[0].content.parts[0].text;
                box.innerHTML = marked.parse(text);
            } catch (e) {
                box.innerHTML = "âŒ ë¶„ì„ ì‹¤íŒ¨: " + (e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
            }
        }

        function doSearch(keyword) {
             if (keyword.match(/(ë‚´ì¼|ëª¨ë ˆ|ì£¼|ë‹¬|ì›”|ë§ˆê°|ì–¸ì œ)/)) { searchWithAI(keyword); } 
             else { simpleSearch(keyword); }
        }

        function initGoogle() {
            gapi.load('client', async () => {
                await gapi.client.init({ discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"] });
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID, scope: SCOPES,
                    callback: (resp) => {
                        if (resp.error) return;
                        gapi.client.setToken(resp);
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(resp));
                        updateLoginState(true);
                    }
                });
                const savedToken = localStorage.getItem(STORAGE_KEY);
                if (savedToken) {
                    try { gapi.client.setToken(JSON.parse(savedToken)); updateLoginState(true); } catch (e) { handleLogout(); }
                }
                document.getElementById('btn-login').onclick = () => {
                    if (isLogin) { if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) handleLogout(); } 
                    else { tokenClient.requestAccessToken({prompt: ''}); }
                };
            });
        }

        function updateLoginState(loggedIn) {
            const btn = document.getElementById('btn-login');
            const calArea = document.getElementById('cal-area');
            const userInfo = document.getElementById('user-info');
            isLogin = loggedIn;
            if (loggedIn) {
                btn.innerText = "ğŸšª ë¡œê·¸ì•„ì›ƒ";
                btn.style.background = "linear-gradient(135deg, #636e72, #2d3436)";
                calArea.style.display = 'block';
                userInfo.innerText = "âœ… êµ¬ê¸€ ê³„ì • ì—°ë™ë¨";
                document.getElementById('cal-frame').src += ''; 
            } else {
                btn.innerText = "ğŸ“… ë¡œê·¸ì¸";
                btn.style.background = "linear-gradient(135deg, #0984e3, #74b9ff)";
                calArea.style.display = 'none';
                userInfo.innerText = "";
            }
        }

        function handleLogout() {
            const token = gapi.client.getToken();
            if (token !== null) google.accounts.oauth2.revoke(token.access_token);
            gapi.client.setToken(null);
            localStorage.removeItem(STORAGE_KEY);
            updateLoginState(false);
        }

        async function addToCal(title, deadline) {
            if (!gapi.client.getToken()) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); handleLogout(); return; }
            if (!confirm(`[${title}] ì¼ì •ì„ ìº˜ë¦°ë”ì— ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            const end = new Date(deadline);
            const start = new Date(end);
            start.setHours(end.getHours() - 1); 
            const event = {
                'summary': `[ì…ì°°] ${title}`, 'description': 'í•œêµ­ìˆ˜ì•ˆ ì…ì°°ë¹„ì„œ ìë™ë“±ë¡',
                'start': { 'dateTime': start.toISOString() }, 'end': { 'dateTime': end.toISOString() },
                'colorId': '11', 'reminders': { 'useDefault': false, 'overrides': [ {'method': 'popup', 'minutes': 60}, {'method': 'popup', 'minutes': 24 * 60} ] }
            };
            try {
                await gapi.client.calendar.events.insert({ 'calendarId': BID_CALENDAR_ID, 'resource': event });
                alert("âœ… ì¼ì • ë“±ë¡ ì™„ë£Œ!");
                document.getElementById('cal-frame').src += ''; 
            } catch (e) {
                alert("ë“±ë¡ ì‹¤íŒ¨: " + e.result.error.message);
                if (e.result.error.code === 401) handleLogout();
            }
        }

        document.getElementById('btn-voice').onclick = () => {
            if (!('webkitSpeechRecognition' in window)) { alert("í¬ë¡¬ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”."); return; }
            const rec = new webkitSpeechRecognition();
            rec.lang = 'ko-KR'; rec.start();
            document.getElementById('voice-result').innerText = "ë“£ê³  ìˆìŠµë‹ˆë‹¤... ğŸ‘‚";
            rec.onresult = (e) => {
                const txt = e.results[0][0].transcript;
                document.getElementById('voice-result').innerText = `ğŸ—£ï¸ "${txt}"`;
                document.getElementById('search-input').value = txt;
                doSearch(txt);
            };
        };
        document.getElementById('btn-search').onclick = () => doSearch(document.getElementById('search-input').value);
        document.getElementById('btn-refresh').onclick = loadData;

        setupCalendarView();
        loadData();
        initGoogle();
    </script>
</body>
</html>

