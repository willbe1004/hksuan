<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬</title>
  <style>
    * { box-sizing: border-box; }

    body {
      font-family: 'Pretendard', 'Malgun Gothic', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: #f2f4f6;
      margin: 0;
      padding: 0;
      color: #333;
    }

    .content-wrapper {
      max-width: 1200px;
      width: 96%;
      margin: 0 auto;
    }

    /* ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë°•ìŠ¤ */
    .control-box-bg {
      background: white;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      padding: 15px 0 18px;
      border-bottom-left-radius: 20px;
      border-bottom-right-radius: 20px;
    }

    .button-row {
      display: flex;
      gap: 8px;
      width: 100%;
      margin-bottom: 12px;
    }

    .button-row button {
      flex: 1;
      padding: 12px 0;
      border: none;
      border-radius: 12px;
      font-size: 0.9em;
      font-weight: 700;
      color: white;
      cursor: pointer;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.1s, box-shadow 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .button-row button:active {
      transform: scale(0.96);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
    }

    #btn-voice   { background: linear-gradient(135deg, #ff7675, #d63031); }
    #btn-refresh { background: linear-gradient(135deg, #00b894, #00cec9); }
    #btn-add     { background: linear-gradient(135deg, #a29bfe, #6c5ce7); }
    #btn-login   { background: linear-gradient(135deg, #0984e3, #74b9ff); }

    h1 {
      margin: 10px 0 14px;
      font-size: 1.7em;
      color: #1e272e;
      text-align: center;
      font-weight: 800;
      letter-spacing: -0.5px;
    }

    .input-group {
      display: flex;
      gap: 8px;
    }

    input[type="text"] {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #dfe6e9;
      border-radius: 10px;
      font-size: 15px;
      background: #f8f9fa;
      outline: none;
    }

    input[type="text"]:focus {
      border-color: #0984e3;
      background: white;
    }

    #btn-search {
      width: 80px;
      background: #636e72;
      color: white;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
    }

    .voice-text {
      color: #e17055;
      font-weight: bold;
      min-height: 20px;
      margin: 5px 0 8px;
      font-size: 0.9em;
      text-align: center;
    }

    #user-info {
      text-align: right;
      font-size: 0.8em;
      color: #b2bec3;
      margin-top: 3px;
      height: 15px;
    }

    #status {
      text-align: center;
      margin-top: 20px;
      color: #636e72;
      font-size: 0.95em;
      font-weight: 500;
      min-height: 30px;
      line-height: 1.5;
    }

    .spin-icon {
      display: inline-block;
      animation: spin 1.5s linear infinite;
      font-size: 1.2em;
      margin-right: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg);   }
      100%{ transform: rotate(360deg); }
    }

    #bid-list {
      margin-top: 20px;
    }

    /* ì¹´ë“œ UI */
    .card {
      background: white;
      padding: 20px 22px 18px;
      margin-bottom: 16px;
      border-radius: 18px;
      border-left: 5px solid #dfe6e9;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
      width: 100%;
    }

    .card.urgent { border-left-color: #ff7675; }
    .card.normal { border-left-color: #0984e3; }

    .card-top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .card-badges {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 0.8em;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 9px;
      border-radius: 999px;
      font-weight: 600;
    }

    .badge-region {
      background-color: #ecf0f1;
      color: #34495e;
    }

    .badge-status {
      background-color: #ffeaa7;
      color: #d35400;
    }

    .badge-manual {
      background-color: #dfe6e9;
      color: #636e72;
    }

    .badge-open {
      background-color: #e3f2fd;
      color: #1565c0;
    }

    .card-d-day {
      font-size: 0.85em;
      font-weight: 700;
      padding: 4px 12px;
      border-radius: 999px;
      background: #f1f2f6;
      color: #2d3436;
    }

    .card-title {
      font-size: 1.2em;
      font-weight: 800;
      color: #2d3436;
      text-decoration: none;
      display: block;
      margin: 6px 0 12px;
      line-height: 1.4;
    }

    .card-title:hover {
      text-decoration: underline;
    }

    .card-sub-title {
      font-size: 0.85em;
      color: #636e72;
      margin-bottom: 10px;
    }

    .card-meta-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px 24px;
      margin-bottom: 6px;
    }

    .meta-block {
      min-width: 0;
    }

    .meta-label {
      font-size: 0.8em;
      color: #95a5a6;
      margin-bottom: 2px;
    }

    .meta-value {
      font-size: 0.9em;
      color: #2c3e50;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .meta-value-strong {
      font-weight: 700;
    }

    .meta-value-em {
      font-weight: 700;
      color: #d63031;
    }

    .meta-value-small {
      font-size: 0.85em;
      color: #636e72;
    }

    .card-bottom-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid #f1f2f6;
      gap: 8px;
      flex-wrap: wrap;
    }

    .card-contact {
      font-size: 0.8em;
      color: #636e72;
    }

    .card-footer-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .card-footer-buttons button,
    .card-footer-buttons a {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      font-size: 0.85em;
      cursor: pointer;
      font-weight: 600;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .btn-link  { background: #dfe6e9;  color: #2d3436; }
    .btn-cal   { background: #e3f2fd;  color: #0984e3; }
    .btn-ai    { background: linear-gradient(135deg, #a29bfe, #6c5ce7); color: white; }

    .ai-analysis-box {
      display: none;
      background-color: #f3e5f5;
      padding: 14px;
      margin-top: 12px;
      border-radius: 10px;
      font-size: 0.9em;
      color: #4a148c;
      border: 1px solid #e1bee7;
      line-height: 1.6;
    }

    /* ëª¨ë‹¬ */
    #add-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.45);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 22px 22px 18px;
      border-radius: 15px;
      width: 90%;
      max-width: 520px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    textarea {
      width: 100%;
      height: 160px;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 14px;
      font-family: system-ui, sans-serif;
      resize: none;
    }

    .modal-btns {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 4px;
    }

    .calendar-area {
      margin-top: 20px;
      display: none;
    }

    iframe {
      width: 100%;
      height: 600px;
      border: none;
      border-radius: 16px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
    }

    @media (max-width: 768px) {
      .card-meta-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 600px) {
      .card-meta-row {
        grid-template-columns: 1fr;
      }
      .card-bottom-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .card-footer-buttons {
        width: 100%;
      }
      .card-footer-buttons button,
      .card-footer-buttons a {
        flex: 1;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="control-box-bg">
    <div class="content-wrapper">
      <div class="button-row">
        <button id="btn-voice">ğŸ¤ ìŒì„±</button>
        <button id="btn-refresh">ğŸ”„ ê³µê³ ê²€ìƒ‰</button>
        <button id="btn-add">ğŸ“ ì§ì ‘ë“±ë¡</button>
        <button id="btn-login">ğŸ“… ë¡œê·¸ì¸</button>
      </div>

      <h1>ğŸ’§ í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬</h1>

      <div class="voice-text" id="voice-result"></div>

      <div class="input-group">
        <input
          type="text"
          id="search-input"
          placeholder="ì˜ˆ: ë‹¤ìŒ ì£¼ ë§ˆê°ë˜ëŠ” ì €ë¥˜ì¡° ê³µê³  ì°¾ì•„ì¤˜"
        />
        <button id="btn-search">ê²€ìƒ‰</button>
      </div>
      <div id="user-info"></div>
    </div>
  </div>

  <div id="status">
    <span class="spin-icon">â³</span> ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...
  </div>

  <div id="bid-list" class="content-wrapper"></div>

  <div class="calendar-area content-wrapper" id="cal-area">
    <h3 style="text-align: center; color: #2c3e50; margin-bottom: 10px">
      ğŸ“… ì…ì°° ì¼ì •í‘œ
    </h3>
    <iframe id="cal-frame" src=""></iframe>
  </div>

  <!-- ì§ì ‘ë“±ë¡ ëª¨ë‹¬ -->
  <div id="add-modal">
    <div class="modal-content">
      <h3 style="margin-top: 0; color: #2c3e50">ğŸ“ ì™¸ë¶€ ê³µê³  ìŠ¤ë§ˆíŠ¸ ë“±ë¡</h3>
      <p style="font-size: 0.9em; color: #666; line-height: 1.4">
        ì™¸ë¶€ ì‚¬ì´íŠ¸ ë‚´ìš© ë³µë¶™ â” AIê°€ ìë™ ì •ë¦¬(ì§€ì—­/ê¸ˆì•¡/ë©´ì /í†¤ìˆ˜ê¹Œì§€) â” ì—‘ì…€ ì €ì¥
      </p>
      <textarea
        id="paste-area"
        placeholder="[ì˜ˆì‹œ]&#13;&#10;ê³µê³ ëª…: ì„œìš¸ì‹œ â—‹â—‹ì§€ì—­ ë¹—ë¬¼ì €ë¥˜ì¡° ì„¤ì¹˜ê³µì‚¬&#13;&#10;ê³µê³ ë²ˆí˜¸: 2025-12345&#13;&#10;ê³µê³ ì¼: 2025ë…„ 11ì›” 10ì¼&#13;&#10;ë§ˆê°ì¼: 2025ë…„ 11ì›” 21ì¼ 14:00&#13;&#10;ë°œì£¼ì²˜: ì„œìš¸íŠ¹ë³„ì‹œì²­&#13;&#10;ìˆ˜ìš”ê¸°ê´€: ì„œìš¸ì‹œ â—‹â—‹êµ¬ì²­&#13;&#10;ì‚¬ì—…ê¸°ê°„: ì°©ê³µì¼ë¡œë¶€í„° 12ê°œì›”&#13;&#10;ê³µì‚¬ë¹„: 25ì–µ(ì¶”ì •)&#13;&#10;ëŒ€ì§€ë©´ì : 3,200ã¡&#13;&#10;ì €ë¥˜ì¡° ìš©ëŸ‰: 3,000í†¤&#13;&#10;ë‹´ë‹¹ì: í™ê¸¸ë™(02-123-4567)&#13;&#10;ë§í¬: https://www.g2b.go.kr/..."
      ></textarea>
      <div class="modal-btns">
        <button
          onclick="closeModal()"
          style="
            background: #b2bec3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
          "
        >
          ì·¨ì†Œ
        </button>
        <button
          id="btn-smart-save"
          onclick="processSmartAdd()"
          style="
            background: #6c5ce7;
            color: white;
            font-weight: bold;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
          "
        >
          âœ¨ AI ë¶„ì„ ë° ì €ì¥
        </button>
      </div>
    </div>
  </div>

  <!-- Google / Gemini / Markdown -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
    // ============================================================
    // ğŸ”‘ í”„ë¡ íŠ¸ ì „ìš© Gemini / Calendar / Apps Script ì„¤ì •
    //  - ë°±ì—”ë“œ(Apps Script)ìš© í‚¤ì™€ ë¶„ë¦¬í•˜ì—¬ ì‚¬ìš©
    // ============================================================
    const GEMINI_API_KEY_FRONT = 'AIzaSyDaRFQQE-I3lwCnIiKcRWIUYxQLHrrfO1M';
    const GEMINI_MODEL_ID      = 'gemini-1.5-flash-latest';

    const BID_CALENDAR_ID = 'd51a10e0014dcbd83e98d0da91cda4f52f629c19652c15fc693ee4529bbbab04@group.calendar.google.com';

    // Apps Script ì›¹ì•± URL (ë°±ì—”ë“œ doGet)
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxi0Bfdty9LuMJyxCGTqTkyJQJrevz3AqRunbhNmePCh68tta-Fu8w1Lw4E_DROWB99zw/exec';

    const CLIENT_ID   = '1049915608396-i3jn8jrm24bc9mkagdtokk3rfa3li513.apps.googleusercontent.com';
    const SCOPES      = 'https://www.googleapis.com/auth/calendar.events';
    const STORAGE_KEY = 'hksuan_google_token_v2';

    let allData = [];
    let currentData = [];
    let tokenClient;
    let isLogin = false;

    // ------------------------------------------------------------
    // ê³µí†µ: ìº˜ë¦°ë” iframe
    // ------------------------------------------------------------
    function setupCalendarView() {
      const iframe = document.getElementById('cal-frame');
      let calSrc = `https://calendar.google.com/calendar/embed?src=${encodeURIComponent(
        BID_CALENDAR_ID
      )}&ctz=Asia%2FSeoul&hl=ko`;
      if (BID_CALENDAR_ID === 'primary') {
        calSrc =
          'https://calendar.google.com/calendar/embed?src=primary&ctz=Asia%2FSeoul&hl=ko';
      }
      iframe.src = calSrc;
    }

    // ------------------------------------------------------------
    // ê³µí†µ: Gemini í˜¸ì¶œ (í”„ë¡ íŠ¸ ì „ìš© í‚¤ ì‚¬ìš©)
    // ------------------------------------------------------------
    async function callGemini(prompt) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 15000);

      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1/models/${GEMINI_MODEL_ID}:generateContent?key=${GEMINI_API_KEY_FRONT}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: prompt }] }]
            }),
            signal: controller.signal
          }
        );

        const data = await response.json();
        if (!response.ok) {
          const msg = data.error?.message || `HTTP ${response.status}`;
          throw new Error(msg);
        }
        return data;
      } finally {
        clearTimeout(timeoutId);
      }
    }

    function extractGeminiText(data) {
      const parts = data?.candidates?.[0]?.content?.parts || [];
      let text = parts.map(p => p.text || '').join('\n');
      text = text.replace(/```json/g, '').replace(/```/g, '').trim();
      const jsonMatch = text.match(/\{[\s\S]*\}/);
      if (jsonMatch) text = jsonMatch[0];
      return text;
    }

    // ------------------------------------------------------------
    // ë‚ ì§œ íŒŒì„œ (ë°±ì—”ë“œì—ì„œ ì˜¨ "YYYY-MM-DD HH:mm" ë¬¸ìì—´ ê¸°ì¤€)
    // ------------------------------------------------------------
    function parseDateTimeLocal(str) {
      if (!str) return null;
      const s = String(str).trim();
      if (!s) return null;

      const [datePart, timePart] = s.split(' ');
      if (!datePart) return null;

      const [y, m, d] = datePart.split('-').map(n => parseInt(n, 10));
      let hh = 0, mm = 0;

      if (timePart) {
        const [h, m2] = timePart.split(':').map(n => parseInt(n, 10));
        if (!isNaN(h)) hh = h;
        if (!isNaN(m2)) mm = m2;
      }
      if (isNaN(y) || isNaN(m) || isNaN(d)) return null;
      return new Date(y, m - 1, d, hh, mm);
    }

    // ------------------------------------------------------------
    // 1. ë°ì´í„° ë¡œë“œ (ë°±ì—”ë“œ â†’ JSON)
    //   - ì—¬ê¸°ì„œë„ ë§ˆê°ëœ ê³µê³ ëŠ” 1ì°¨ì ìœ¼ë¡œ í•„í„°
    // ------------------------------------------------------------
    async function loadData() {
      const status = document.getElementById('status');
      status.innerHTML =
        '<span class="spin-icon">â³</span> ì…ì°° ê³µê³ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...';

      try {
        const res = await fetch(SCRIPT_URL);
        if (!res.ok)
          throw new Error('ì„œë²„ ì—°ê²° ì‹¤íŒ¨ (Apps Script /exec ì£¼ì†Œ í™•ì¸ í•„ìš”)');

        const text = await res.text();
        if (text.trim().startsWith('<')) {
          throw new Error(
            'Apps Scriptì—ì„œ HTMLì´ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤. "ìµœì¢… ë°°í¬ëœ ì›¹ ì•± URL"ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.'
          );
        }

        const json = JSON.parse(text);

        const now = new Date();
        // ë§ˆê°ëœ ê³µê³ ëŠ” í”„ë¡ íŠ¸ì—ì„œë„ ìˆ¨ê¹€
        allData = json.filter(item => {
          const end = parseDateTimeLocal(item.deadline);
          if (!end) return true; // ë§ˆê°ì¼ ì •ë³´ ì—†ìœ¼ë©´ ì¼ë‹¨ í‘œì‹œ
          return end >= now;
        });

        renderList(allData);
        status.innerHTML = `âœ… ì´ <b>${allData.length}</b>ê±´ì˜ ê³µê³ ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`;
      } catch (e) {
        status.innerHTML = `<span style="color:red">âŒ ì˜¤ë¥˜ ë°œìƒ: ${e.message}</span>`;
        console.error(e);
      }
    }

    // ------------------------------------------------------------
    // 2. ì§ì ‘ë“±ë¡ ëª¨ë‹¬
    // ------------------------------------------------------------
    document.getElementById('btn-add').onclick = () => {
      document.getElementById('add-modal').style.display = 'flex';
    };

    function closeModal() {
      document.getElementById('add-modal').style.display = 'none';
      document.getElementById('paste-area').value = '';
    }

    // ìŠ¤ë§ˆíŠ¸ ë“±ë¡: í…ìŠ¤íŠ¸ â†’ AI ë¶„ì„ â†’ ì‹œíŠ¸ ì €ì¥
    async function processSmartAdd() {
      const text = document.getElementById('paste-area').value;
      if (!text) {
        alert('ë‚´ìš©ì„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”!');
        return;
      }

      const btn = document.getElementById('btn-smart-save');
      btn.innerText = 'ğŸ§  ë¶„ì„ ë° ì €ì¥ ì¤‘...';
      btn.disabled = true;

      const prompt =
        'ë‹¤ìŒì€ í•œêµ­ ê³µê³µì…ì°° ê³µê³  ì›ë¬¸ í…ìŠ¤íŠ¸ì´ë‹¤.\n' +
        'ì•„ë˜ í•­ëª©ì„ ìµœëŒ€í•œ ì •í™•í•˜ê²Œ ì¶”ì¶œí•˜ì—¬ JSON ê°ì²´ í•˜ë‚˜ë¡œë§Œ ì‘ë‹µí•´ë¼.\n\n' +
        'í•„ë“œ ì •ì˜:\n' +
        'no            : ê³µê³ ë²ˆí˜¸ (ì—†ìœ¼ë©´ "ì •ë³´ì—†ìŒ")\n' +
        'region        : ì§€ì—­ (ì˜ˆ: "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬", "ê²½ê¸°ë„ ì–‘ì£¼ì‹œ"ì²˜ëŸ¼ ìœ„ì¹˜ í•œ ì¤„)\n' +
        'title         : ê³µê³ ëª…\n' +
        'date          : ê³µê³ ì¼ (í˜•ì‹: "YYYY-MM-DD HH:mm" ë˜ëŠ” "YYYY-MM-DD")\n' +
        'deadline      : ë§ˆê°ì¼ (í˜•ì‹: "YYYY-MM-DD HH:mm")\n' +
        'client        : ë°œì£¼ì²˜(ê³µê³  ê¸°ê´€)\n' +
        'agency        : ìˆ˜ìš”ê¸°ê´€ (ëª…ì‹œ ì—†ìœ¼ë©´ ë°œì£¼ì²˜ì™€ ë™ì¼í•˜ê²Œ)\n' +
        'servicePeriod : ìš©ì—­/ê³µì‚¬ ê¸°ê°„(ììœ ë¡œìš´ í•œêµ­ì–´ ë¬¸ìì—´, ì˜ˆ: "ì°©ê³µì¼ë¡œë¶€í„° 12ê°œì›”")\n' +
        'serviceAmount : ìš©ì—­ê¸ˆì•¡ ë˜ëŠ” ì¶”ì • ê³µì‚¬ë¹„ (ìˆ«ìë§Œ, ë‹¨ìœ„ì™€ ì½¤ë§ˆ ì œê±°, ëª¨ë¥´ê² ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)\n' +
        'projectBudget : ì „ì²´ ì‚¬ì—…ë¹„ (ìˆ«ìë§Œ, ë‹¨ìœ„ì™€ ì½¤ë§ˆ ì œê±°, ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)\n' +
        'clientManager : ë°œì£¼ì²˜ ë‹´ë‹¹ì ì´ë¦„ ë° ì—°ë½ì²˜ë¥¼ í•œ ì¤„ë¡œ (ì˜ˆ: "í™ê¸¸ë™ 02-123-4567")\n' +
        'siteArea      : ëŒ€ì§€ë©´ì , ë‹¨ìœ„ mÂ² (ìˆ«ìë§Œ, ì˜ˆ: "3200", ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)\n' +
        'expectedTon   : ë¹—ë¬¼ì €ë¥˜ì¡° ì˜ˆìƒ í†¤ìˆ˜ (ìˆ«ìë§Œ, ì˜ˆ: "3000", ê³µê³ ì— ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)\n' +
        'link          : ê³µê³  ìƒì„¸ ë§í¬ URL (ì—†ìœ¼ë©´ "#")\n\n' +
        'ë°˜ë“œì‹œ ì•„ë˜ ì˜ˆì‹œì²˜ëŸ¼ JSON ê°ì²´ í•œ ì¤„ë¡œë§Œ ì¶œë ¥:\n' +
        '{"no":"R25BK...","region":"ê²½ê¸°ë„ ì–‘ì£¼ì‹œ","title":"...","date":"2025-11-10 09:00","deadline":"2025-11-21 14:00","client":"ê²½ê¸°ë„ ì–‘ì£¼ì‹œ","agency":"ê²½ê¸°ë„ ì–‘ì£¼ì‹œ","servicePeriod":"ì°©ê³µì¼ë¡œë¶€í„° 12ê°œì›”","serviceAmount":"2500000000","projectBudget":"2500000000","clientManager":"í™ê¸¸ë™ 02-123-4567","siteArea":"3200","expectedTon":"3000","link":"https://..."}\n\n' +
        'ì…ë ¥ í…ìŠ¤íŠ¸:\n' +
        text;

      try {
        const aiData = await callGemini(prompt);
        const aiText = extractGeminiText(aiData);
        const result = JSON.parse(aiText);

        const params = new URLSearchParams({
          action: 'add',
          no: result.no || 'ì •ë³´ì—†ìŒ',
          region: result.region || '',
          title: result.title || '',
          date: result.date || '',
          deadline: result.deadline || '',
          client: result.client || '',
          agency: result.agency || '',
          servicePeriod: result.servicePeriod || '',
          serviceAmount: result.serviceAmount || '',
          projectBudget: result.projectBudget || '',
          clientManager: result.clientManager || '',
          siteArea: result.siteArea || '',
          expectedTon: result.expectedTon || '',
          link: result.link || '#',
          status: 'ìˆ˜ë™ë“±ë¡',
          aiResult: 'ì§ì ‘ë“±ë¡ í…ìŠ¤íŠ¸ ê¸°ë°˜'
        });

        await fetch(`${SCRIPT_URL}?${params.toString()}`, { mode: 'no-cors' });

        alert(`âœ… ì €ì¥ ìš”ì²­ ì™„ë£Œ!\n[${result.title || 'ì œëª©ì—†ìŒ'}]`);
        closeModal();
        setTimeout(loadData, 2000);
      } catch (e) {
        console.error(e);
        alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
      } finally {
        btn.innerText = 'âœ¨ AI ë¶„ì„ ë° ì €ì¥';
        btn.disabled = false;
      }
    }

    // ------------------------------------------------------------
    // 3. ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (UI ì •ë¦¬ + ë§ˆê° ìˆ¨ê¹€)
    // ------------------------------------------------------------
    function renderList(data) {
      const list = document.getElementById('bid-list');
      const query = document.getElementById('search-input').value || '';

      list.innerHTML = '';
      const now = new Date();

      // ë§ˆê°ëœ ê³µê³ ëŠ” ì—¬ê¸°ì„œë„ í•œë²ˆ ë” í•„í„°
      const visible = data.filter(item => {
        const end = parseDateTimeLocal(item.deadline);
        if (!end) return true;
        return end >= now;
      });

      currentData = visible;

      if (visible.length === 0) {
        let html = `
          <div style="text-align:center; padding:50px 20px; color:#636e72;">
            <p style="font-size:3em; margin-bottom:10px;">ğŸ¤”</p>
            <p style="font-weight:bold; font-size:1.05em;">ì¡°ê±´ì— ë§ëŠ” ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        `;
        if (query) {
          html += `
            <p style="font-size:0.9em; margin-bottom:18px;">ë‚´ë¶€ DBì—ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ì›¹ ê²€ìƒ‰ì„ ì‹œë„í•´ ë³´ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div style="display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
              <button onclick="window.open('https://www.google.com/search?q=${encodeURIComponent(
                query + ' ì…ì°° ê³µê³ '
              )}')" 
                      style="padding:10px 20px; background:#4285F4; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; display:flex; align-items:center; gap:5px;">
                  ğŸŒ êµ¬ê¸€ ê²€ìƒ‰
              </button>
              <button onclick="window.open('https://search.naver.com/search.naver?query=${encodeURIComponent(
                query + ' ì…ì°° ê³µê³ '
              )}')" 
                      style="padding:10px 20px; background:#03C75A; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; display:flex; align-items:center; gap:5px;">
                  âœ… ë„¤ì´ë²„ ê²€ìƒ‰
              </button>
            </div>
          `;
        }
        html += '</div>';
        list.innerHTML = html;
        return;
      }

      visible.forEach((item, index) => {
        const end = parseDateTimeLocal(item.deadline);
        let dDayLabel = '-';
        let cardClass = 'normal';

        if (end) {
          const diff = Math.ceil((end - now) / (1000 * 60 * 60 * 24));
          if (diff < 0) {
            // ì´ ê²½ìš°ëŠ” ìœ„ì—ì„œ ì´ë¯¸ í•„í„°ë˜ì—ˆìœ¼ë¯€ë¡œ ê±°ì˜ ì—†ìŒ
            return;
          } else if (diff === 0) {
            dDayLabel = 'ì˜¤ëŠ˜ ë§ˆê°';
            cardClass = 'urgent';
          } else if (diff <= 3) {
            dDayLabel = `D-${diff}`;
            cardClass = 'urgent';
          } else {
            dDayLabel = `D-${diff}`;
          }
        }

        const statusBadge =
          item.status === 'ìˆ˜ë™ë“±ë¡'
            ? '<span class="badge badge-manual">ìˆ˜ë™ë“±ë¡</span>'
            : '<span class="badge badge-open">ê³µê³ ì¤‘</span>';

        const regionBadge = item.region
          ? `<span class="badge badge-region">#${item.region}</span>`
          : '';

        const serviceAmount = item.serviceAmount
          ? `${Number(item.serviceAmount).toLocaleString()}ì›`
          : '-';

        const projectBudget = item.projectBudget
          ? `${Number(item.projectBudget).toLocaleString()}ì›`
          : '-';

        const siteTon = `${item.siteArea || '-'}ã¡ / ${
          item.expectedTon || '-'
        }í†¤`;

        const div = document.createElement('div');
        div.className = `card ${cardClass}`;
        div.innerHTML = `
          <div class="card-top-row">
            <div class="card-badges">
              ${regionBadge}
              ${statusBadge}
            </div>
            <div class="card-d-day">${dDayLabel}</div>
          </div>

          <div class="card-sub-title">ê³µê³ ë²ˆí˜¸ <span style="font-weight:700; color:#2d3436;">${
            item.no || '-'
          }</span></div>

          <a href="${item.link || '#'}" target="_blank" class="card-title">
            ${item.title || '-'}
          </a>

          <div class="card-meta-row">
            <div class="meta-block">
              <div class="meta-label">ë°œì£¼ì²˜</div>
              <div class="meta-value meta-value-strong">${
                item.client || '-'
              }</div>
            </div>
            <div class="meta-block">
              <div class="meta-label">ìˆ˜ìš”ê¸°ê´€</div>
              <div class="meta-value">${item.agency || '-'}</div>
            </div>
            <div class="meta-block">
              <div class="meta-label">ìš©ì—­ê¸°ê°„</div>
              <div class="meta-value meta-value-small">${
                item.servicePeriod || '-'
              }</div>
            </div>
          </div>

          <div class="card-meta-row">
            <div class="meta-block">
              <div class="meta-label">ê³µê³ ì¼</div>
              <div class="meta-value meta-value-small">${item.date || '-'}</div>
            </div>
            <div class="meta-block">
              <div class="meta-label">ë§ˆê°ì¼</div>
              <div class="meta-value meta-value-em">${item.deadline || '-'}</div>
            </div>
            <div class="meta-block">
              <div class="meta-label">ëŒ€ì§€/í†¤ìˆ˜</div>
              <div class="meta-value meta-value-small">${siteTon}</div>
            </div>
          </div>

          <div class="card-meta-row">
            <div class="meta-block">
              <div class="meta-label">ìš©ì—­ê¸ˆì•¡</div>
              <div class="meta-value meta-value-strong">${serviceAmount}</div>
            </div>
            <div class="meta-block">
              <div class="meta-label">ì‚¬ì—…ë¹„</div>
              <div class="meta-value meta-value-small">${projectBudget}</div>
            </div>
            <div class="meta-block">
              <div class="meta-label">ìƒíƒœ</div>
              <div class="meta-value meta-value-small">${item.status || '-'}</div>
            </div>
          </div>

          <div class="card-bottom-row">
            <div class="card-contact">
              ğŸ“ ë‹´ë‹¹ì: ${item.clientManager || '-'}
            </div>
            <div class="card-footer-buttons">
              <button class="btn-ai" data-index="${index}">ğŸ¤– ìƒì„¸ AI ë¶„ì„</button>
              <a href="${item.link || '#'}" target="_blank" class="btn-link">ğŸ“„ ê³µê³ ë¬¸</a>
              <button class="btn-cal" data-index="${index}">ğŸ“… ìº˜ë¦°ë”</button>
            </div>
          </div>

          <div id="ai-result-${index}" class="ai-analysis-box"></div>
        `;
        list.appendChild(div);
      });

      // ë²„íŠ¼ í•¸ë“¤ëŸ¬ (currentData ê¸°ì¤€)
      document.querySelectorAll('.btn-ai').forEach(btn => {
        btn.onclick = () => {
          const i = parseInt(btn.dataset.index, 10);
          const item = currentData[i];
          if (!item) return;
          analyzeBidWithAI(item, i);
        };
      });

      document.querySelectorAll('.btn-cal').forEach(btn => {
        btn.onclick = () => {
          const i = parseInt(btn.dataset.index, 10);
          const item = currentData[i];
          if (!item) return;
          addToCal(item.title, item.deadline);
        };
      });
    }

    // ------------------------------------------------------------
    // 4. ë‹¨ìˆœ ê²€ìƒ‰ (ì œëª©/ê¸°ê´€ í…ìŠ¤íŠ¸ ë§¤ì¹­)
    // ------------------------------------------------------------
    function simpleSearch(keyword) {
      const q = keyword.toLowerCase();
      const filtered = allData.filter(item =>
        (item.title || '').toLowerCase().includes(q) ||
        (item.client || '').toLowerCase().includes(q) ||
        (item.agency || '').toLowerCase().includes(q) ||
        (item.region || '').toLowerCase().includes(q)
      );
      renderList(filtered);

      const status = document.getElementById('status');
      status.innerHTML =
        filtered.length > 0
          ? `ğŸ” "<b>${keyword}</b>" ê²€ìƒ‰ ê²°ê³¼: ${filtered.length}ê±´`
          : `ğŸ” "<b>${keyword}</b>" ë‚´ë¶€ DB ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ`;
    }

    // ------------------------------------------------------------
    // 5. AI ê²€ìƒ‰ (ê¸°ê°„Â·í‚¤ì›Œë“œ í•´ì„)
    // ------------------------------------------------------------
    async function searchWithAI(query) {
      if (!query) {
        renderList(allData);
        return;
      }
      const status = document.getElementById('status');

      const basicFilter = allData.filter(item =>
        (item.title || '').includes(query) ||
        (item.client || '').includes(query) ||
        (item.agency || '').includes(query) ||
        (item.region || '').includes(query)
      );
      if (basicFilter.length > 0 && !query.match(/(ë‚´ì¼|ëª¨ë ˆ|ì£¼|ë‹¬|ì›”|ë§ˆê°|ì–¸ì œ|ì´ë²ˆ)/)) {
        renderList(basicFilter);
        status.innerHTML = `ğŸ” "<b>${query}</b>" ê²€ìƒ‰ ê²°ê³¼: ${basicFilter.length}ê±´`;
        return;
      }

      status.innerHTML =
        '<span class="spin-icon">ğŸ§ </span> AIê°€ ê²€ìƒ‰ ì¡°ê±´ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...';

      const today = new Date().toISOString().split('T')[0];
      const prompt =
        `Today is ${today}. Analyze user input (Korean): "${query}"\n` +
        'Decide search keyword and date range.\n' +
        'Respond ONLY with JSON object:\n' +
        '{"keyword":"string or empty","startDate":"YYYY-MM-DD or empty","endDate":"YYYY-MM-DD or empty"}';

      try {
        const data = await callGemini(prompt);
        const text = extractGeminiText(data);
        const result = JSON.parse(text);

        const filtered = allData.filter(item => {
          let dateMatch = true;
          let keywordMatch = true;

          if (result.startDate && result.endDate && item.deadline) {
            const itemDate = String(item.deadline).split(' ')[0];
            dateMatch =
              itemDate >= result.startDate && itemDate <= result.endDate;
          }
          if (result.keyword) {
            const k = result.keyword.toLowerCase();
            keywordMatch =
              (item.title || '').toLowerCase().includes(k) ||
              (item.client || '').toLowerCase().includes(k) ||
              (item.agency || '').toLowerCase().includes(k) ||
              (item.region || '').toLowerCase().includes(k);
          }
          return dateMatch && keywordMatch;
        });

        renderList(filtered);
        status.innerHTML =
          filtered.length > 0
            ? `ğŸ¤– AI ê²€ìƒ‰ ê²°ê³¼: <b>${filtered.length}</b>ê±´`
            : 'ğŸ¤– AI ë¶„ì„ ì™„ë£Œ: <b>ì¡°ê±´ì— ë§ëŠ” ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</b>';
      } catch (e) {
        console.error('AI ê²€ìƒ‰ ì˜¤ë¥˜:', e);
        simpleSearch(query);
      }
    }

    // ------------------------------------------------------------
    // 6. ê°œë³„ ê³µê³  ìƒì„¸ AI ë¶„ì„
    // ------------------------------------------------------------
    async function analyzeBidWithAI(item, index) {
      const box = document.getElementById(`ai-result-${index}`);
      if (box.style.display === 'block') {
        box.style.display = 'none';
        return;
      }

      box.style.display = 'block';
      box.innerHTML = '<span class="spin-icon">ğŸ§ </span> ë¶„ì„ ì¤‘...';

      const prompt =
        "ë‚˜ëŠ” 'ë¹—ë¬¼ì €ë¥˜ì¡°Â·ìš°ìˆ˜ì €ë¥˜ì‹œì„¤' ì „ë¬¸ ì—…ì²´(í•œêµ­ìˆ˜ì•ˆ)ì˜ ì˜ì—… ë‹´ë‹¹ìì´ë‹¤.\n" +
        'ì•„ë˜ ì…ì°° ê³µê³ ê°€ ìš°ë¦¬ íšŒì‚¬ì— ì–¼ë§ˆë‚˜ ì í•©í•œì§€ ê°„ë‹¨íˆ ë¶„ì„í•´ì¤˜.\n\n' +
        `ê³µê³ ë²ˆí˜¸: ${item.no}\n` +
        `ê³µê³ ëª…: ${item.title}\n` +
        `ì§€ì—­: ${item.region}\n` +
        `ë°œì£¼ì²˜: ${item.client}\n` +
        `ìˆ˜ìš”ê¸°ê´€: ${item.agency}\n` +
        `ìš©ì—­ê¸°ê°„: ${item.servicePeriod}\n` +
        `ìš©ì—­ê¸ˆì•¡: ${item.serviceAmount}\n` +
        `ì‚¬ì—…ë¹„: ${item.projectBudget}\n` +
        `ëŒ€ì§€ë©´ì : ${item.siteArea}\n` +
        `ì˜ˆìƒí†¤ìˆ˜: ${item.expectedTon}\n` +
        `ë§ˆê°ì¼: ${item.deadline}\n\n` +
        'ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œë§Œ ì •ë¦¬:\n' +
        '1) ê³µì‚¬/ìš©ì—­ ì£¼ìš” ë‚´ìš© ìš”ì•½ (2~3ì¤„)\n' +
        '2) í•œêµ­ìˆ˜ì•ˆ ì…ì¥ì—ì„œ ì í•©ë„ (ë†’ìŒ/ì¤‘ê°„/ë‚®ìŒ + ì´ìœ )\n' +
        '3) ì…ì°° ì°¸ì—¬ ì‹œ ì²´í¬í¬ì¸íŠ¸ 3~5ê°œ (bullet)\n';

      try {
        const data = await callGemini(prompt);
        const text =
          data?.candidates?.[0]?.content?.parts?.[0]?.text ||
          'ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
        box.innerHTML = marked.parse(text);
      } catch (e) {
        console.error(e);
        box.innerHTML = 'âŒ ë¶„ì„ ì‹¤íŒ¨: ' + (e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
      }
    }

    // ------------------------------------------------------------
    // 7. ê²€ìƒ‰ ë¶„ê¸°
    // ------------------------------------------------------------
    function doSearch(keyword) {
      if (!keyword) {
        renderList(allData);
        document.getElementById('status').innerHTML = `ì „ì²´ <b>${allData.length}</b>ê±´`;
        return;
      }
      if (keyword.match(/(ë‚´ì¼|ëª¨ë ˆ|ì£¼|ë‹¬|ì›”|ë§ˆê°|ì–¸ì œ|ì´ë²ˆ)/)) {
        searchWithAI(keyword);
      } else {
        simpleSearch(keyword);
      }
    }

    // ------------------------------------------------------------
    // 8. êµ¬ê¸€ ìº˜ë¦°ë” ì—°ë™
    // ------------------------------------------------------------
    function initGoogle() {
      gapi.load('client', async () => {
        await gapi.client.init({
          discoveryDocs: [
            'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'
          ]
        });
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: resp => {
            if (resp.error) return;
            gapi.client.setToken(resp);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(resp));
            updateLoginState(true);
          }
        });

        const savedToken = localStorage.getItem(STORAGE_KEY);
        if (savedToken) {
          try {
            gapi.client.setToken(JSON.parse(savedToken));
            updateLoginState(true);
          } catch (e) {
            handleLogout();
          }
        }

        document.getElementById('btn-login').onclick = () => {
          if (isLogin) {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) handleLogout();
          } else {
            tokenClient.requestAccessToken({ prompt: '' });
          }
        };
      });
    }

    function updateLoginState(loggedIn) {
      const btn = document.getElementById('btn-login');
      const userInfo = document.getElementById('user-info');
      const calArea = document.getElementById('cal-area');
      isLogin = loggedIn;

      if (loggedIn) {
        btn.innerText = 'ğŸšª ë¡œê·¸ì•„ì›ƒ';
        btn.style.background =
          'linear-gradient(135deg, #636e72, #2d3436)';
        userInfo.innerText = 'âœ… êµ¬ê¸€ ê³„ì • ì—°ë™ë¨';
        calArea.style.display = 'block';
        document.getElementById('cal-frame').src += '';
      } else {
        btn.innerText = 'ğŸ“… ë¡œê·¸ì¸';
        btn.style.background =
          'linear-gradient(135deg, #0984e3, #74b9ff)';
        userInfo.innerText = '';
        calArea.style.display = 'none';
      }
    }

    function handleLogout() {
      const token = gapi.client.getToken();
      if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
      }
      gapi.client.setToken(null);
      localStorage.removeItem(STORAGE_KEY);
      updateLoginState(false);
    }

    async function addToCal(title, deadline) {
      if (!gapi.client.getToken()) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        handleLogout();
        return;
      }
      if (!deadline) {
        alert('ë§ˆê°ì¼ ì •ë³´ê°€ ì—†ì–´ ìº˜ë¦°ë” ë“±ë¡ì´ ì–´ë µìŠµë‹ˆë‹¤.');
        return;
      }
      if (!confirm(`[${title}] ì¼ì •ì„ ìº˜ë¦°ë”ì— ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      const end = parseDateTimeLocal(deadline);
      if (!end) {
        alert('ë§ˆê°ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }

      const start = new Date(end.getTime());
      start.setHours(end.getHours() - 1);

      const event = {
        summary: `[ì…ì°°] ${title}`,
        description: 'í•œêµ­ìˆ˜ì•ˆ ì…ì°°ë¹„ì„œ ìë™ë“±ë¡',
        start: { dateTime: start.toISOString() },
        end: { dateTime: end.toISOString() },
        colorId: '11',
        reminders: {
          useDefault: false,
          overrides: [
            { method: 'popup', minutes: 60 },
            { method: 'popup', minutes: 24 * 60 }
          ]
        }
      };

      try {
        await gapi.client.calendar.events.insert({
          calendarId: BID_CALENDAR_ID,
          resource: event
        });
        alert('âœ… ì¼ì • ë“±ë¡ ì™„ë£Œ!');
        document.getElementById('cal-frame').src += '';
      } catch (e) {
        alert('ë“±ë¡ ì‹¤íŒ¨: ' + (e.result?.error?.message || e.message));
        if (e.result?.error?.code === 401) handleLogout();
      }
    }

    // ------------------------------------------------------------
    // 9. UI ì´ë²¤íŠ¸ ë°”ì¸ë”©
    // ------------------------------------------------------------
    document.getElementById('btn-voice').onclick = () => {
      if (!('webkitSpeechRecognition' in window)) {
        alert('í¬ë¡¬ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
        return;
      }
      const rec = new webkitSpeechRecognition();
      rec.lang = 'ko-KR';
      rec.start();
      document.getElementById('voice-result').innerText =
        'ë“£ê³  ìˆìŠµë‹ˆë‹¤... ğŸ‘‚';
      rec.onresult = e => {
        const txt = e.results[0][0].transcript;
        document.getElementById('voice-result').innerText = `ğŸ—£ï¸ "${txt}"`;
        document.getElementById('search-input').value = txt;
        doSearch(txt);
      };
    };

    document.getElementById('btn-search').onclick = () =>
      doSearch(document.getElementById('search-input').value);
    document.getElementById('btn-refresh').onclick = loadData;

    // ------------------------------------------------------------
    // 10. ì´ˆê¸° ì‹¤í–‰
    // ------------------------------------------------------------
    setupCalendarView();
    loadData();
    initGoogle();
  </script>
</body>
</html>
