<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬</title>
  <style>
    /* 1. ê¸°ë³¸ ì„¤ì • */
    * { box-sizing: border-box; }
    body {
      font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
      background-color: #f2f4f6;
      margin: 0; padding: 0; color: #333;
    }
    .content-wrapper { max-width: 1200px; width: 96%; margin: 0 auto; }

    /* 2. ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë°•ìŠ¤ */
    .control-box-bg {
      background: white;
      position: sticky; top: 0; z-index: 1000;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      padding: 15px 0;
      border-bottom-left-radius: 20px;
      border-bottom-right-radius: 20px;
    }

    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .button-row {
      display: flex; gap: 8px; width: 100%; margin-bottom: 15px;
    }
    .button-row button {
      flex: 1; padding: 12px 0; border: none; border-radius: 12px;
      font-size: 0.9em; font-weight: bold; color: white; cursor: pointer;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1); transition: transform 0.1s;
      display: flex; align-items: center; justify-content: center; gap: 5px;
    }
    .button-row button:active { transform: scale(0.96); }

    #btn-voice  { background: linear-gradient(135deg, #ff7675, #d63031); }
    #btn-refresh{ background: linear-gradient(135deg, #00b894, #00cec9); }
    #btn-add    { background: linear-gradient(135deg, #a29bfe, #6c5ce7); }
    #btn-login  { background: linear-gradient(135deg, #0984e3, #74b9ff); }

    h1 {
      margin: 15px 0; font-size: 1.6em; color: #1e272e;
      text-align: center; font-weight: 800; letter-spacing: -0.5px;
    }

    .input-group { display: flex; gap: 8px; }
    input[type="text"] {
      flex: 1; padding: 12px 15px; border: 1px solid #dfe6e9;
      border-radius: 10px; font-size: 16px; background: #f8f9fa; outline: none;
    }
    input[type="text"]:focus { border-color: #0984e3; background: white; }
    #btn-search {
      width: 80px; background: #636e72; color: white; border: none;
      border-radius: 10px; font-weight: bold; cursor: pointer;
    }

    .voice-text { color: #e17055; font-weight: bold; min-height: 20px; margin: 5px 0; font-size: 0.9em; text-align: center;}
    #user-info  { text-align: right; font-size: 0.8em; color: #b2bec3; margin-top: 5px; height: 15px;}

    #status {
      text-align: center; margin-top: 30px; color: #636e72;
      font-size: 1em; font-weight: 500; min-height: 30px; line-height: 1.5;
    }
    .spin-icon {
      display: inline-block; animation: spin 1.5s linear infinite;
      font-size: 1.2em; margin-right: 8px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    #bid-list { margin-top: 20px; }

    /* ì¹´ë“œ ë ˆì´ì•„ì›ƒ ê°œì„  */
    .card {
      background: white; padding: 20px 22px; margin-bottom: 15px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.03); width: 100%;
      border: 1px solid #e9ecef;
    }
    .card.urgent { border-left: 5px solid #ff7675; }
    .card.normal { border-left: 5px solid #74b9ff; }

    .card-header {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 0.9em; color: #868e96; margin-bottom: 6px;
      gap: 8px;
    }
    .card-header-left {
      display: flex; flex-wrap: wrap; align-items: center; gap: 6px;
    }

    .badge-no {
      background: #e9ecef;
      color: #495057;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.8em;
      font-weight: 600;
    }
    .badge-region {
      background: #fff4e6;
      color: #e8590c;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.8em;
      font-weight: 600;
    }
    .d-day {
      background: #ffeaa7; color: #d35400;
      padding: 3px 10px; border-radius: 20px;
      font-size: 0.8em; font-weight: 700;
    }

    .card-title {
      font-size: 1.2em; font-weight: 800; color: #2d3436;
      text-decoration: none; display: block; margin: 4px 0 10px 0; line-height: 1.4;
    }
    .card-title:hover { text-decoration: underline; }

    .card-meta {
      display: flex; flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
    }
    .meta-pill {
      background: #f1f3f5;
      color: #495057;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 0.8em;
    }

    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 10px 30px;
      margin-top: 4px;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.9em;
      color: #495057;
      margin: 2px 0;
    }
    .info-label {
      color: #868e96;
    }
    .info-value {
      font-weight: 600;
      text-align: right;
    }

    .card-contact {
      margin-top: 8px;
      font-size: 0.9em;
      color: #495057;
    }

    .ai-inline {
      margin-top: 10px;
      padding: 10px 12px;
      background: #f3e5f5;
      border-radius: 10px;
      border: 1px solid #e1bee7;
      font-size: 0.85em;
      color: #4a148c;
      max-height: 4.5em;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .ai-inline-title {
      font-weight: 700;
      margin-bottom: 3px;
      font-size: 0.85em;
    }

    .ai-analysis-box {
      display: none;
      background-color: #f3e5f5;
      padding: 15px;
      margin-top: 12px;
      border-radius: 10px;
      font-size: 0.9em;
      color: #4a148c;
      border: 1px solid #e1bee7;
      line-height: 1.6;
    }

    .card-footer {
      display: flex; justify-content: flex-end; gap: 8px;
      margin-top: 15px; padding-top: 12px; border-top: 1px solid #f1f1f1;
      flex-wrap: wrap;
    }
    .card-footer button, .card-footer a {
      padding: 8px 16px; border-radius: 8px; border:none;
      font-size:0.85em; cursor:pointer; font-weight:bold; text-decoration: none; display: inline-flex; align-items: center; gap: 4px;
    }
    .btn-link { background: #dfe6e9; color: #2d3436; }
    .btn-cal  { background: #e3f2fd; color: #0984e3; }
    .btn-ai   { background: linear-gradient(135deg, #a29bfe, #6c5ce7); color: white; }

    /* ëª¨ë‹¬ì°½ ìŠ¤íƒ€ì¼ */
    #add-modal {
      display: none; position: fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); z-index:2000;
      justify-content:center; align-items:center;
    }
    .modal-content {
      background:white; padding:25px; border-radius:15px;
      width:90%; max-width:500px;
    }
    textarea {
      width:100%; height:150px; padding:10px; margin:10px 0;
      border-radius:8px; border:1px solid #ddd; font-size:14px;
      font-family: sans-serif; resize: none;
    }
    .modal-btns { display:flex; justify-content:flex-end; gap:10px; }

    .calendar-area { margin-top: 20px; display:none; }
    iframe {
      width: 100%; height: 600px; border:none;
      border-radius:16px; box-shadow: 0 10px 20px rgba(0,0,0,0.05);
    }
  </style>
</head>
<body>

  <div class="control-box-bg">
    <div class="content-wrapper">
      <div class="button-row">
        <button id="btn-voice">ğŸ¤ ìŒì„±</button>
        <button id="btn-refresh">ğŸ”„ ê³µê³ ê²€ìƒ‰</button>
        <button id="btn-add">ğŸ“ ì§ì ‘ë“±ë¡</button>
        <button id="btn-login">ğŸ“… ë¡œê·¸ì¸</button>
      </div>

      <h1>ğŸ’§ í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬</h1>

      <div class="voice-text" id="voice-result"></div>

      <div class="input-group">
        <input type="text" id="search-input" placeholder="ì˜ˆ: ë‹¤ìŒ ì£¼ ë§ˆê°ë˜ëŠ” ì €ë¥˜ì¡° ê³µê³  ì°¾ì•„ì¤˜">
        <button id="btn-search">ê²€ìƒ‰</button>
      </div>
      <div id="user-info"></div>
    </div>
  </div>

  <div id="status">
    <span class="spin-icon">â³</span> ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...
  </div>

  <div id="bid-list" class="content-wrapper"></div>

  <div class="calendar-area content-wrapper" id="cal-area">
    <h3 style="text-align:center; color:#2c3e50;">ğŸ“… ì…ì°° ì¼ì •í‘œ</h3>
    <iframe id="cal-frame" src=""></iframe>
  </div>

  <!-- ì§ì ‘ë“±ë¡ ëª¨ë‹¬ -->
  <div id="add-modal">
    <div class="modal-content">
      <h3 style="margin-top:0; color:#2c3e50;">ğŸ“ ì™¸ë¶€ ê³µê³  ìŠ¤ë§ˆíŠ¸ ë“±ë¡</h3>
      <p style="font-size:0.9em; color:#666; line-height:1.4;">
        ì™¸ë¶€ ì‚¬ì´íŠ¸ ë‚´ìš© ë³µë¶™ â” AIê°€ ìë™ ì •ë¦¬ â” ì—‘ì…€ ì €ì¥
      </p>
      <textarea id="paste-area" placeholder="[ì˜ˆì‹œ]&#13;&#10;ê³µê³ ëª…: ì„œìš¸ì‹œ ë¹—ë¬¼ì €ë¥˜ì¡° ì„¤ì¹˜ê³µì‚¬&#13;&#10;ë§ˆê°ì¼: 2025ë…„ 12ì›” 1ì¼ 18:00&#13;&#10;ë°œì£¼ì²˜: ì„œìš¸íŠ¹ë³„ì‹œì²­"></textarea>
      <div class="modal-btns">
        <button onclick="closeModal()" style="background:#b2bec3; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">ì·¨ì†Œ</button>
        <button id="btn-smart-save" onclick="processSmartAdd()" style="background:#6c5ce7; color:white; font-weight:bold; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">âœ¨ AI ë¶„ì„ ë° ì €ì¥</button>
      </div>
    </div>
  </div>

  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script>
    // ============================================================
    // ğŸ”‘ Gemini API í‚¤ / ìº˜ë¦°ë” ID / Apps Script URL
    //  - ë°±ì—”ë“œ ìŠ¤í¬ë¦½íŠ¸ì™€ ë™ì¼í•œ ìƒˆ í‚¤ ì‚¬ìš© (ìµœê·¼ ìƒì„±í•˜ì‹  í‚¤)
    const GEMINI_API_KEY   = 'AIzaSyDu8QKqqTRxutvYqr8GWOUKJLAoT2lZS1k';
    const GEMINI_MODEL_ID  = 'gemini-1.5-flash-latest';

    const BID_CALENDAR_ID  = 'd51a10e0014dcbd83e98d0da91cda4f52f629c19652c15fc693ee4529bbbab04@group.calendar.google.com';
    const SCRIPT_URL       = 'https://script.google.com/macros/s/AKfycbxi0Bfdty9LuMJyxCGTqTkyJQJrevz3AqRunbhNmePCh68tta-Fu8w1Lw4E_DROWB99zw/exec';

    const CLIENT_ID   = '1049915608396-i3jn8jrm24bc9mkagdtokk3rfa3li513.apps.googleusercontent.com';
    const SCOPES      = 'https://www.googleapis.com/auth/calendar.events';
    const STORAGE_KEY = 'hksuan_google_token_v2';
    // ============================================================

    let allData    = [];
    let currentList = [];
    let tokenClient;
    let isLogin    = false;

    // 0. ìº˜ë¦°ë” ë·° ì„¤ì •
    function setupCalendarView() {
      const iframe = document.getElementById('cal-frame');
      let calSrc = `https://calendar.google.com/calendar/embed?src=${encodeURIComponent(BID_CALENDAR_ID)}&ctz=Asia%2FSeoul&hl=ko`;
      if (BID_CALENDAR_ID === 'primary') {
        calSrc = 'https://calendar.google.com/calendar/embed?src=primary&ctz=Asia%2FSeoul&hl=ko';
      }
      iframe.src = calSrc;
    }

    // ---------- ê³µí†µ Gemini í˜¸ì¶œ í•¨ìˆ˜ ----------
    async function callGemini(prompt) {
      const controller = new AbortController();
      const timeoutId  = setTimeout(() => controller.abort(), 15000); // 15ì´ˆ íƒ€ì„ì•„ì›ƒ

      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1/models/${GEMINI_MODEL_ID}:generateContent?key=${GEMINI_API_KEY}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [
                { parts: [ { text: prompt } ] }
              ]
            }),
            signal: controller.signal
          }
        );

        const data = await response.json();
        if (!response.ok) {
          const msg = data.error?.message || `HTTP ${response.status}`;
          throw new Error(msg);
        }
        return data;
      } finally {
        clearTimeout(timeoutId);
      }
    }

    // AI JSON ì¶”ì¶œìš© ìœ í‹¸
    function extractGeminiText(data) {
      const parts = data?.candidates?.[0]?.content?.parts || [];
      let text    = parts.map(p => p.text || '').join('\n');
      text        = text.replace(/```json/g, '').replace(/```/g, '').trim();
      const jsonMatch = text.match(/\{[\s\S]*\}/);
      if (jsonMatch) text = jsonMatch[0];
      return text;
    }

    // ---------- 1. ë°ì´í„° ë¡œë“œ ----------
    async function loadData() {
      const status = document.getElementById('status');
      status.innerHTML = `<span class="spin-icon">â³</span> ì…ì°° ê³µê³ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...`;

      try {
        const res = await fetch(SCRIPT_URL);
        if (!res.ok) throw new Error('ì„œë²„ ì—°ê²° ì‹¤íŒ¨ (Apps Script ì£¼ì†Œ í™•ì¸ í•„ìš”)');

        const text = await res.text();
        if (text.trim().startsWith('<')) {
          throw new Error('Apps Scriptì—ì„œ HTMLì´ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤. ì›¹ ì•± /exec ì£¼ì†Œë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        }

        const json = JSON.parse(text);
        allData = json;
        renderList(allData);
        status.innerHTML = `âœ… ì´ <b>${allData.length}</b>ê±´ì˜ ê³µê³ ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`;
      } catch (e) {
        status.innerHTML = `<span style="color:red">âŒ ì˜¤ë¥˜ ë°œìƒ: ${e.message}</span>`;
        console.error(e);
      }
    }

    // ---------- 2. [ì§ì ‘ë“±ë¡] ëª¨ë‹¬ ----------
    document.getElementById('btn-add').onclick = () => {
      document.getElementById('add-modal').style.display = 'flex';
    };

    function closeModal() {
      document.getElementById('add-modal').style.display = 'none';
      document.getElementById('paste-area').value = '';
    }

    // ìŠ¤ë§ˆíŠ¸ ë“±ë¡: í…ìŠ¤íŠ¸ â†’ AI ë¶„ì„ â†’ ì‹œíŠ¸ ì €ì¥
    async function processSmartAdd() {
      const text = document.getElementById('paste-area').value;
      if (!text) {
        alert('ë‚´ìš©ì„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”!');
        return;
      }

      const btn = document.getElementById('btn-smart-save');
      btn.innerText = 'ğŸ§  ë¶„ì„ ë° ì €ì¥ ì¤‘...';
      btn.disabled  = true;

      const prompt =
        'ì‚¬ìš©ìê°€ ë¶™ì—¬ë„£ì€ ì…ì°° ê³µê³  í…ìŠ¤íŠ¸ì•¼.\n' +
        'ì•„ë˜ í•­ëª©ì„ í•œêµ­ì–´ ê¸°ì¤€ìœ¼ë¡œ ìµœëŒ€í•œ ì •í™•í•˜ê²Œ ì¶”ì¶œí•´ì„œ JSON í•˜ë‚˜ë¡œë§Œ ì¶œë ¥í•´ì¤˜.\n\n' +
        'í•„ë“œ ì„¤ëª…:\n' +
        'no        : ê³µê³ ë²ˆí˜¸ (ì—†ìœ¼ë©´ "ì •ë³´ì—†ìŒ")\n' +
        'region    : ì§€ì—­ (ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)\n' +
        'title     : ê³µê³ ëª…\n' +
      'date      : ê³µê³ ì¼ (YYYY-MM-DD í˜•ì‹, ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)\n' +
        'deadline  : ë§ˆê°ì¼ (YYYY-MM-DD HH:mm í˜•ì‹, ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)\n' +
        'owner     : ë°œì£¼ì²˜\n' +
        'agency    : ìˆ˜ìš”ê¸°ê´€\n' +
        'period    : ìš©ì—­ê¸°ê°„(í…ìŠ¤íŠ¸)\n' +
        'amount    : ìš©ì—­ê¸ˆì•¡(ê¸ˆì•¡ ë˜ëŠ” í…ìŠ¤íŠ¸)\n' +
        'budget    : ì‚¬ì—…ë¹„(ê¸ˆì•¡ ë˜ëŠ” í…ìŠ¤íŠ¸)\n' +
        'contact   : ë°œì£¼ì²˜ ë‹´ë‹¹ì/ì—°ë½ì²˜\n' +
        'area      : ëŒ€ì§€ë©´ì (ã¡)\n' +
        'tonnage   : ì˜ˆìƒí†¤ìˆ˜\n' +
        "link      : ê³µê³  ë§í¬(ì—†ìœ¼ë©´ '#')\n\n" +
        'ì¶œë ¥ í˜•ì‹ì€ ë°˜ë“œì‹œ ì•„ë˜ ì˜ˆì‹œ í•œ ì¤„ê³¼ ê°™ì€ JSON ê°ì²´ë§Œ ì‚¬ìš©.\n' +
        'ì˜ˆì‹œ: {"no":"...","region":"...","title":"...","date":"2025-01-01","deadline":"2025-01-10 18:00","owner":"...","agency":"...","period":"...","amount":"...","budget":"...","contact":"...","area":"...","tonnage":"...","link":"..."}\n\n' +
        'ì…ë ¥ í…ìŠ¤íŠ¸:\n' + text;

      try {
        const aiData = await callGemini(prompt);
        const aiText = extractGeminiText(aiData);
        const result = JSON.parse(aiText);

        const params = new URLSearchParams({
          action:   'add',
          no:       result.no       || '',
          region:   result.region   || '',
          title:    result.title    || '',
          date:     result.date     || '',
          deadline: result.deadline || '',
          owner:    result.owner    || '',
          agency:   result.agency   || '',
          period:   result.period   || '',
          amount:   result.amount   || '',
          budget:   result.budget   || '',
          contact:  result.contact  || '',
          area:     result.area     || '',
          tonnage:  result.tonnage  || '',
          link:     result.link     || '#'
        });

        const saveUrl = `${SCRIPT_URL}?${params.toString()}`;
        await fetch(saveUrl, { mode: 'no-cors' });

        alert(`âœ… ì €ì¥ ìš”ì²­ ì™„ë£Œ!\n[${result.title}]`);
        closeModal();
        setTimeout(loadData, 2000);
      } catch (e) {
        console.error(e);
        alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
      } finally {
        btn.innerText = 'âœ¨ AI ë¶„ì„ ë° ì €ì¥';
        btn.disabled  = false;
      }
    }

    // ---------- 3. ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ ----------
    function renderList(data) {
      const list  = document.getElementById('bid-list');
      const query = document.getElementById('search-input').value;
      list.innerHTML = '';
      currentList = data;

      if (data.length === 0) {
        let html = `
          <div style='text-align:center; padding:50px 20px; color:#636e72;'>
            <p style='font-size:3em; margin-bottom:10px;'>ğŸ¤”</p>
            <p style="font-weight:bold; font-size:1.1em;">ë‚´ë¶€ DBì—ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        `;
        if (query) {
          html += `
            <p style="font-size:0.9em; margin-bottom:20px;">ì›¹ ì „ì²´ì—ì„œ ê²€ìƒ‰í•´ ë³´ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div style="display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
              <button onclick="window.open('https://www.google.com/search?q=${encodeURIComponent(query + ' ì…ì°° ê³µê³ ')}')"
                      style="padding:10px 20px; background:#4285F4; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; display:flex; align-items:center; gap:5px;">
                ğŸŒ êµ¬ê¸€ ê²€ìƒ‰
              </button>
              <button onclick="window.open('https://search.naver.com/search.naver?query=${encodeURIComponent(query + ' ì…ì°° ê³µê³ ')}')"
                      style="padding:10px 20px; background:#03C75A; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold; display:flex; align-items:center; gap:5px;">
                âœ… ë„¤ì´ë²„ ê²€ìƒ‰
              </button>
            </div>
          `;
        }
        html += '</div>';
        list.innerHTML = html;
        return;
      }

      const now = new Date();

      data.forEach((item, index) => {
        const end   = item.deadline ? new Date(item.deadline) : null;
        let dDayText = '-';

        if (end && !isNaN(end.getTime())) {
          const diff  = Math.ceil((end - now) / (1000 * 60 * 60 * 24));
          if (diff < 0)      dDayText = 'ë§ˆê°ë¨';
          else if (diff === 0) dDayText = 'ì˜¤ëŠ˜ë§ˆê°';
          else               dDayText = `D-${diff}`;
        }

        const cardClass = end && (end - now) / (1000 * 60 * 60 * 24) <= 3 ? 'urgent' : 'normal';

        // AI 1ì°¨ê²°ê³¼ ì§§ê²Œ ìë¥´ê¸°
        let aiBrief = '';
        if (item.aiResult) {
          aiBrief = String(item.aiResult).replace(/\s+/g, ' ');
          if (aiBrief.length > 140) aiBrief = aiBrief.slice(0, 140) + ' â€¦';
        }

        const div = document.createElement('div');
        div.className = `card ${cardClass}`;
        div.innerHTML = `
          <div class="card-header">
            <div class="card-header-left">
              <span class="badge-no">#${item.no || '-'}</span>
              ${item.region ? `<span class="badge-region">${item.region}</span>` : ''}
            </div>
            <span class="d-day">${dDayText}</span>
          </div>

          <a href="${item.link}" target="_blank" class="card-title">${item.title || '-'}</a>

          <div class="card-meta">
            ${item.owner ? `<span class="meta-pill">ë°œì£¼ì²˜: ${item.owner}</span>` : ''}
            ${item.agency ? `<span class="meta-pill">ìˆ˜ìš”ê¸°ê´€: ${item.agency}</span>` : ''}
          </div>

          <div class="card-grid">
            <div>
              <div class="info-row">
                <span class="info-label">ê³µê³ ì¼</span>
                <span class="info-value">${item.date || '-'}</span>
              </div>
              <div class="info-row">
                <span class="info-label">ë§ˆê°ì¼</span>
                <span class="info-value">${item.deadline || '-'}</span>
              </div>
              <div class="info-row">
                <span class="info-label">ìš©ì—­ê¸°ê°„</span>
                <span class="info-value">${item.period || '-'}</span>
              </div>
            </div>
            <div>
              <div class="info-row">
                <span class="info-label">ìš©ì—­ê¸ˆì•¡</span>
                <span class="info-value">${item.amount || '-'}</span>
              </div>
              <div class="info-row">
                <span class="info-label">ì‚¬ì—…ë¹„</span>
                <span class="info-value">${item.budget || '-'}</span>
              </div>
              <div class="info-row">
                <span class="info-label">ëŒ€ì§€/í†¤ìˆ˜</span>
                <span class="info-value">
                  ${(item.area || '-')}ã¡ / ${(item.tonnage || '-')}í†¤
                </span>
              </div>
            </div>
          </div>

          ${item.contact ? `<div class="card-contact">ğŸ“ ${item.contact}</div>` : ''}

          ${aiBrief
            ? `<div class="ai-inline">
                 <div class="ai-inline-title">AI 1ì°¨ ë¶„ì„ ìš”ì•½</div>
                 <div>${aiBrief}</div>
               </div>`
            : ''
          }

          <div id="ai-result-${index}" class="ai-analysis-box"></div>

          <div class="card-footer">
            <button class="btn-ai" data-index="${index}">ğŸ¤– ìƒì„¸ AI ë¶„ì„</button>
            <a href="${item.link}" target="_blank" class="btn-link">ğŸ“„ ê³µê³ ë¬¸</a>
            <button class="btn-cal" data-index="${index}">ğŸ“… ìº˜ë¦°ë”</button>
          </div>
        `;
        list.appendChild(div);
      });

      // ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”© (currentList ê¸°ì¤€)
      document.querySelectorAll('.btn-ai').forEach(btn => {
        btn.onclick = () => {
          const i = parseInt(btn.dataset.index, 10);
          const item = currentList[i];
          analyzeBidWithAI(item, i);
        };
      });
      document.querySelectorAll('.btn-cal').forEach(btn => {
        btn.onclick = () => {
          const i = parseInt(btn.dataset.index, 10);
          const item = currentList[i];
          addToCal(item.title, item.deadline);
        };
      });
    }

    // ---------- 4. ê¸°ë³¸ ê²€ìƒ‰ ----------
    function simpleSearch(keyword) {
      const q = keyword.toLowerCase();
      const filtered = allData.filter(item =>
        (item.title  || '').toLowerCase().includes(q) ||
        (item.owner  || '').toLowerCase().includes(q) ||
        (item.agency || '').toLowerCase().includes(q) ||
        (item.region || '').toLowerCase().includes(q)
      );
      renderList(filtered);
      const status = document.getElementById('status');
      status.innerHTML = filtered.length > 0
        ? `ğŸ” "<b>${keyword}</b>" ê²€ìƒ‰ ê²°ê³¼: ${filtered.length}ê±´`
        : `ğŸ” "<b>${keyword}</b>" ë‚´ë¶€ DB ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ`;
    }

    // ---------- 5. AI ê²€ìƒ‰ ----------
    async function searchWithAI(query) {
      if (!query) {
        renderList(allData);
        return;
      }
      const status = document.getElementById('status');

      const basicFilter = allData.filter(item =>
        (item.title || '').includes(query) ||
        (item.owner || '').includes(query) ||
        (item.agency || '').includes(query)
      );
      if (basicFilter.length > 0 && !query.match(/(ë‚´ì¼|ëª¨ë ˆ|ì£¼|ë‹¬|ì›”|ë§ˆê°|ì–¸ì œ)/)) {
        renderList(basicFilter);
        status.innerHTML = `ğŸ” "<b>${query}</b>" ê²€ìƒ‰ ê²°ê³¼: ${basicFilter.length}ê±´`;
        return;
      }

      status.innerHTML = `<span class="spin-icon">ğŸ§ </span> AIê°€ ê²€ìƒ‰ ì¡°ê±´ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...`;

      const today = new Date().toISOString().split('T')[0];
      const prompt =
        `Today is ${today}. Analyze user input: "${query}"\n` +
        'Extract keywords and date ranges.\n' +
        'Response format: JSON object ONLY. No markdown, no explanations.\n' +
        'Example: {"keyword": "string", "startDate": "YYYY-MM-DD", "endDate": "YYYY-MM-DD"}\n';

      try {
        const data   = await callGemini(prompt);
        const text   = extractGeminiText(data);
        const result = JSON.parse(text);

        const filtered = allData.filter(item => {
          let dateMatch    = true;
          let keywordMatch = true;

          if (result.startDate && result.endDate && item.deadline) {
            const itemDate = String(item.deadline).split(' ')[0];
            dateMatch = itemDate >= result.startDate && itemDate <= result.endDate;
          }
          if (result.keyword) {
            const k = result.keyword.toLowerCase();
            keywordMatch =
              (item.title  || '').toLowerCase().includes(k) ||
              (item.owner  || '').toLowerCase().includes(k) ||
              (item.agency || '').toLowerCase().includes(k) ||
              (item.region || '').toLowerCase().includes(k);
          }
          return dateMatch && keywordMatch;
        });

        renderList(filtered);
        status.innerHTML = filtered.length > 0
          ? `ğŸ¤– AI ê²€ìƒ‰ ê²°ê³¼: <b>${filtered.length}</b>ê±´`
          : 'ğŸ¤– AI ë¶„ì„ ì™„ë£Œ: <b>ì¡°ê±´ì— ë§ëŠ” ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</b>';
      } catch (e) {
        console.error('AI Error:', e);
        simpleSearch(query);
      }
    }

    // ---------- 6. ê°œë³„ ê³µê³  AI ë¶„ì„ ----------
    async function analyzeBidWithAI(item, index) {
      const box = document.getElementById(`ai-result-${index}`);
      if (box.style.display === 'block') {
        box.style.display = 'none';
        return;
      }

      box.style.display = 'block';
      box.innerHTML     = `<span class="spin-icon">ğŸ§ </span> ë¶„ì„ ì¤‘...`;

      const prompt =
        "ë‚˜ëŠ” 'ë¹—ë¬¼ì €ë¥˜ì¡°' ê¸°ì—…(í•œêµ­ìˆ˜ì•ˆ) ì§ì›ì´ì•¼.\n" +
        'ì•„ë˜ ì…ì°° ê³µê³ ê°€ ìš°ë¦¬ íšŒì‚¬ì— ì–¼ë§ˆë‚˜ ì í•©í•œì§€ ê°„ë‹¨íˆ ë¶„ì„í•´ì¤˜.\n\n' +
        `[ê³µê³ ë²ˆí˜¸] ${item.no || ''}\n` +
        `[ì§€ì—­] ${item.region || ''}\n` +
        `[ê³µê³ ì œëª©] ${item.title || ''}\n` +
        `[ë°œì£¼ì²˜] ${item.owner || ''}\n` +
        `[ìˆ˜ìš”ê¸°ê´€] ${item.agency || ''}\n` +
        `[ê³µê³ ì¼] ${item.date || ''}\n` +
        `[ë§ˆê°ì¼] ${item.deadline || ''}\n` +
        `[ìš©ì—­ê¸°ê°„] ${item.period || ''}\n` +
        `[ìš©ì—­ê¸ˆì•¡] ${item.amount || ''}\n` +
        `[ì‚¬ì—…ë¹„] ${item.budget || ''}\n` +
        `[ëŒ€ì§€ë©´ì ] ${item.area || ''}\n` +
        `[ì˜ˆìƒí†¤ìˆ˜] ${item.tonnage || ''}\n\n` +
        '1) ê³µì‚¬/ìš©ì—­ì˜ ì£¼ìš” ë‚´ìš©ì„ 3ì¤„ ì´ë‚´ë¡œ ìš”ì•½\n' +
        '2) í•œêµ­ìˆ˜ì•ˆ(ì €ë¥˜ì¡°Â·ë¹—ë¬¼ì €ë¥˜ì¡° ê´€ë ¨)ì—ê²Œì˜ ì í•©ë„ (ë†’ìŒ/ì¤‘ê°„/ë‚®ìŒ + í•œ ì¤„ ì´ìœ )\n' +
        '3) ì…ì°° ì°¸ì—¬ ì‹œ ì²´í¬í¬ì¸íŠ¸ 3~5ê°œ bulletë¡œ ì •ë¦¬\n' +
        'HTML íƒœê·¸ ì—†ì´ ìˆœìˆ˜ í…ìŠ¤íŠ¸/ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì‘ì„±í•´ì¤˜.';

      try {
        const data = await callGemini(prompt);
        const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || 'ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
        box.innerHTML = marked.parse(text);
      } catch (e) {
        console.error(e);
        box.innerHTML = 'âŒ ë¶„ì„ ì‹¤íŒ¨: ' + (e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
      }
    }

    // ---------- 7. ê²€ìƒ‰ ë¶„ê¸° ----------
    function doSearch(keyword) {
      if (!keyword) {
        renderList(allData);
        document.getElementById('status').innerHTML = `ì „ì²´ <b>${allData.length}</b>ê±´`;
        return;
      }
      if (keyword.match(/(ë‚´ì¼|ëª¨ë ˆ|ì£¼|ë‹¬|ì›”|ë§ˆê°|ì–¸ì œ)/)) {
        searchWithAI(keyword);
      } else {
        simpleSearch(keyword);
      }
    }

    // ---------- 8. êµ¬ê¸€ ìº˜ë¦°ë” ì—°ë™ ----------
    function initGoogle() {
      gapi.load('client', async () => {
        await gapi.client.init({
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest']
        });
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: (resp) => {
            if (resp.error) return;
            gapi.client.setToken(resp);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(resp));
            updateLoginState(true);
          }
        });

        const savedToken = localStorage.getItem(STORAGE_KEY);
        if (savedToken) {
          try {
            gapi.client.setToken(JSON.parse(savedToken));
            updateLoginState(true);
          } catch (e) {
            handleLogout();
          }
        }

        document.getElementById('btn-login').onclick = () => {
          if (isLogin) {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) handleLogout();
          } else {
            tokenClient.requestAccessToken({ prompt: '' });
          }
        };
      });
    }

    function updateLoginState(loggedIn) {
      const btn      = document.getElementById('btn-login');
      const userInfo = document.getElementById('user-info');
      const calArea  = document.getElementById('cal-area');
      isLogin        = loggedIn;

      if (loggedIn) {
        btn.innerText           = 'ğŸšª ë¡œê·¸ì•„ì›ƒ';
        btn.style.background    = 'linear-gradient(135deg, #636e72, #2d3436)';
        userInfo.innerText      = 'âœ… êµ¬ê¸€ ê³„ì • ì—°ë™ë¨';
        calArea.style.display   = 'block';
        document.getElementById('cal-frame').src += '';
      } else {
        btn.innerText           = 'ğŸ“… ë¡œê·¸ì¸';
        btn.style.background    = 'linear-gradient(135deg, #0984e3, #74b9ff)';
        userInfo.innerText      = '';
        calArea.style.display   = 'none';
      }
    }

    function handleLogout() {
      const token = gapi.client.getToken();
      if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
      }
      gapi.client.setToken(null);
      localStorage.removeItem(STORAGE_KEY);
      updateLoginState(false);
    }

    async function addToCal(title, deadline) {
      if (!gapi.client.getToken()) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        handleLogout();
        return;
      }
      if (!deadline) {
        alert('ë§ˆê°ì¼ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      if (!confirm(`[${title}] ì¼ì •ì„ ìº˜ë¦°ë”ì— ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      const end   = new Date(deadline);
      if (isNaN(end.getTime())) {
        alert('ë§ˆê°ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }
      const start = new Date(end);
      start.setHours(end.getHours() - 1);

      const event = {
        summary    : `[ì…ì°°] ${title}`,
        description: 'í•œêµ­ìˆ˜ì•ˆ ì…ì°°ë¹„ì„œ ìë™ë“±ë¡',
        start      : { dateTime: start.toISOString() },
        end        : { dateTime: end.toISOString() },
        colorId    : '11',
        reminders  : {
          useDefault: false,
          overrides: [
            { method: 'popup', minutes: 60 },
            { method: 'popup', minutes: 24 * 60 }
          ]
        }
      };

      try {
        await gapi.client.calendar.events.insert({
          calendarId: BID_CALENDAR_ID,
          resource  : event
        });
        alert('âœ… ì¼ì • ë“±ë¡ ì™„ë£Œ!');
        document.getElementById('cal-frame').src += '';
      } catch (e) {
        alert('ë“±ë¡ ì‹¤íŒ¨: ' + (e.result?.error?.message || e.message));
        if (e.result?.error?.code === 401) handleLogout();
      }
    }

    // ---------- 9. UI ì´ë²¤íŠ¸ ë°”ì¸ë”© ----------
    document.getElementById('btn-voice').onclick = () => {
      if (!('webkitSpeechRecognition' in window)) {
        alert('í¬ë¡¬ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
        return;
      }
      const rec = new webkitSpeechRecognition();
      rec.lang  = 'ko-KR';
      rec.start();
      document.getElementById('voice-result').innerText = 'ë“£ê³  ìˆìŠµë‹ˆë‹¤... ğŸ‘‚';
      rec.onresult = (e) => {
        const txt = e.results[0][0].transcript;
        document.getElementById('voice-result').innerText = `ğŸ—£ï¸ "${txt}"`;
        document.getElementById('search-input').value     = txt;
        doSearch(txt);
      };
    };

    document.getElementById('btn-search').onclick  = () => doSearch(document.getElementById('search-input').value);
    document.getElementById('btn-refresh').onclick = loadData;

    // ---------- 10. ì´ˆê¸° ì‹¤í–‰ ----------
    setupCalendarView();
    loadData();
    initGoogle();
  </script>
</body>
</html>
