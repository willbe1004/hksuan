<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>한국수안 AI 입찰관리</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #050816;
      color: #f5f5f5;
    }
    header {
      padding: 16px 24px;
      border-bottom: 1px solid #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #050816;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    .search-bar {
      display: flex;
      gap: 8px;
      width: 60%;
    }
    .search-bar input,
    .search-bar select {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #0b1020;
      color: #f5f5f5;
      flex: 1;
    }
    .search-bar button {
      padding: 8px 14px;
      border-radius: 6px;
      border: none;
      background: #3b82f6;
      color: #fff;
      cursor: pointer;
      white-space: nowrap;
    }
    main {
      padding: 16px 24px 40px;
    }
    #bidList {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .bid-card {
      background: #0b1020;
      border-radius: 10px;
      padding: 14px 16px;
      border: 1px solid #1e293b;
    }
    .bid-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      margin-bottom: 6px;
    }
    .bid-title {
      margin: 4px 0 8px;
      font-size: 16px;
      font-weight: 600;
    }
    .bid-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 12px;
      color: #cbd5f5;
      margin-bottom: 8px;
    }
    .ai-block {
      margin-top: 6px;
      padding: 10px;
      background: #111827;
      border-radius: 8px;
      border: 1px solid #1f2937;
      font-size: 13px;
    }
    .ai-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .ai-text {
      margin: 0 0 8px;
      white-space: pre-wrap;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
    }
    .badge-region {
      background: #1e293b;
      color: #e5e7eb;
      margin-right: 6px;
    }
    .badge-days {
      background: #22c55e33;
      color: #4ade80;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
    }
    .badge-high {
      background: #ef444433;
      color: #f97373;
    }
    .badge-mid {
      background: #eab30833;
      color: #facc15;
    }
    .btn-row {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    .btn-primary,
    .btn-outline {
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-primary {
      border: none;
      background: #3b82f6;
      color: #fff;
    }
    .btn-outline {
      border: 1px solid #4b5563;
      background: transparent;
      color: #e5e7eb;
    }
    .help {
      font-size: 13px;
      color: #9ca3af;
    }
    .error {
      font-size: 13px;
      color: #fca5a5;
    }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal.hidden {
      display: none;
    }
    .modal-inner {
      background: #020617;
      border-radius: 12px;
      border: 1px solid #1e293b;
      padding: 16px 18px;
      width: min(720px, 96vw);
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 45px rgba(0,0,0,0.7);
      font-size: 13px;
    }
    .modal-title {
      margin: 0 0 4px;
      font-size: 16px;
      font-weight: 600;
    }
    .modal-sub {
      margin: 0 0 10px;
      font-size: 12px;
      color: #9ca3af;
    }
    .modal-section {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid #1e293b;
    }
    .modal-section h3 {
      margin: 0 0 6px;
      font-size: 13px;
    }
    .modal-section p {
      margin: 2px 0;
      white-space: pre-wrap;
    }
    .modal-buttons {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    ul {
      padding-left: 18px;
      margin: 4px 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>한국수안 AI 입찰관리</h1>
    <div class="search-bar">
      <input id="keywordInput" type="text" placeholder="예: 학교 개축, 리모델링, 서울시" />
      <select id="regionSelect">
        <option value="전체">전체 지역</option>
        <option value="서울">서울</option>
        <option value="경기">경기</option>
        <option value="부산">부산</option>
        <option value="대전">대전</option>
        <option value="광주">광주</option>
        <option value="인천">인천</option>
        <option value="강원">강원</option>
        <option value="충청">충청</option>
        <option value="경상">경상</option>
        <option value="전라">전라</option>
      </select>
      <button id="searchBtn">검색</button>
    </div>
  </header>

  <main>
    <div id="bidList" class="bid-list">
      <!-- 카드가 여기에 렌더링됩니다 -->
    </div>
  </main>

  <!-- 2차 분석 모달 -->
  <div id="detailModal" class="modal hidden">
    <div class="modal-inner">
      <div id="detailContent"></div>
    </div>
  </div>

  <script>
    // ✅ 여기에 Apps Script WebApp URL 입력
    const API_BASE = 'YOUR_WEBAPP_URL_HERE';

    let allBids = [];

    document.addEventListener('DOMContentLoaded', () => {
      loadBidList();
      document.getElementById('searchBtn').addEventListener('click', applyFilter);
      document.getElementById('keywordInput').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') applyFilter();
      });

      // 모달 바깥 클릭 시 닫기
      document.getElementById('detailModal').addEventListener('click', (e) => {
        if (e.target.id === 'detailModal') hideDetailModal();
      });

      // 전역 버튼 핸들링
      document.addEventListener('click', globalClickHandler);
    });

    async function loadBidList() {
      const listEl = document.getElementById('bidList');
      listEl.innerHTML = '<p class="help">공고를 불러오는 중입니다...</p>';
      try {
        const resp = await fetch(API_BASE);
        const data = await resp.json();
        allBids = data || [];
        renderBids(allBids);
      } catch (err) {
        listEl.innerHTML = '<p class="error">목록을 가져오는 중 오류: ' +
          escapeHtml(err.message) + '</p>';
      }
    }

    function renderBids(list) {
      const listEl = document.getElementById('bidList');
      if (!list || !list.length) {
        listEl.innerHTML = '<p class="help">조건에 맞는 공고가 없습니다.</p>';
        return;
      }
      const html = list.map(item => {
        const ai = item.aiResult || 'AI 분석 대기중';
        const relBadge =
          ai.indexOf('[상]') >= 0
            ? '<span class="badge badge-high">관련성 상</span>'
            : ai.indexOf('[중]') >= 0
            ? '<span class="badge badge-mid">관련성 중</span>'
            : '';

        return `
<div class="bid-card">
  <div class="bid-header">
    <div>
      <span class="badge badge-region">${escapeHtml(item.region || '지역미상')}</span>
      <span class="bid-no">${escapeHtml(item.no || '')}</span>
    </div>
    <span class="badge-days">${escapeHtml(item.status || '공고중')}</span>
  </div>
  <h2 class="bid-title">${escapeHtml(item.title || '')}</h2>
  <div class="bid-meta">
    <span>수요기관: ${escapeHtml(item.client || '')}</span>
    <span>발주처: ${escapeHtml(item.agency || '')}</span>
    <span>마감: ${escapeHtml(item.deadline || '')}</span>
  </div>
  <div class="ai-block">
    <div class="ai-head">
      <strong>1차 AI 요약</strong>
      ${relBadge}
    </div>
    <p class="ai-text">${escapeHtml(ai)}</p>
    <div class="btn-row">
      <button class="btn-primary btn-second"
        data-no="${escapeHtml(item.no || '')}"
        data-link="${escapeHtml(item.link || '')}"
        data-title="${escapeHtml(item.title || '')}"
        data-region="${escapeHtml(item.region || '')}"
        data-client="${escapeHtml(item.client || '')}">
        2차 분석
      </button>
      <button class="btn-outline btn-open-nara"
        data-link="${escapeHtml(item.link || '')}">
        나라장터 열기
      </button>
    </div>
  </div>
</div>`;
      }).join('');
      listEl.innerHTML = html;
    }

    function applyFilter() {
      const q = document.getElementById('keywordInput').value.trim();
      const region = document.getElementById('regionSelect').value;
      const filtered = allBids.filter(item => {
        const condRegion =
          !region || region === '전체' ||
          (item.region && item.region.indexOf(region) >= 0);
        const condText =
          !q ||
          (item.title && item.title.indexOf(q) >= 0) ||
          (item.client && item.client.indexOf(q) >= 0);
        return condRegion && condText;
      });
      renderBids(filtered);
    }

    function globalClickHandler(e) {
      const target = e.target;
      if (target.classList.contains('btn-open-nara')) {
        const link = target.dataset.link;
        if (link) window.open(link, '_blank');
      } else if (target.classList.contains('btn-second')) {
        openSecondAnalysis(target);
      } else if (target.id === 'modalCloseBtn') {
        hideDetailModal();
      } else if (target.id === 'modalOpenNara') {
        const link = target.dataset.link;
        if (link) window.open(link, '_blank');
      }
    }

    async function openSecondAnalysis(btn) {
      const bidNo = btn.dataset.no;
      const link = btn.dataset.link;
      const title = btn.dataset.title;
      const region = btn.dataset.region;
      const client = btn.dataset.client;

      const modal = document.getElementById('detailModal');
      const content = document.getElementById('detailContent');
      modal.classList.remove('hidden');
      content.innerHTML =
        '<p class="help">[' + escapeHtml(bidNo) + '] ' +
        escapeHtml(title) + '<br>2차 분석 중입니다...</p>';

      try {
        const url =
          API_BASE + '?action=secondAnalysis' +
          '&bidNo=' + encodeURIComponent(bidNo) +
          '&link=' + encodeURIComponent(link) +
          '&title=' + encodeURIComponent(title) +
          '&region=' + encodeURIComponent(region) +
          '&client=' + encodeURIComponent(client);

        const resp = await fetch(url);
        const data = await resp.json();

        const attachHtml =
          data.attachments && data.attachments.length
            ? '<ul>' +
              data.attachments
                .map(name => '<li>' + escapeHtml(name) + '</li>')
                .join('') +
              '</ul>'
            : '<p class="help">나라장터 상세에서 첨부파일 이름을 찾지 못했습니다.</p>';

        content.innerHTML = `
  <h2 class="modal-title">[${escapeHtml(data.bidNo || bidNo)}] ${escapeHtml(data.title || title)}</h2>
  <p class="modal-sub">수요기관: ${escapeHtml(data.client || client)} / 지역: ${escapeHtml(data.region || region)}</p>
  <div class="modal-section">
    <h3>한국수안 관점 2차 요약 ${data.relevance ? '(' + escapeHtml(data.relevance) + ')' : ''}</h3>
    <p>${escapeHtml(data.summary || '요약 결과가 없습니다.')}</p>
    ${data.reason ? '<p class="help">' + escapeHtml(data.reason) + '</p>' : ''}
  </div>
  <div class="modal-section">
    <h3>톤수 추정 & 시설 유형</h3>
    <p>예상 시설 유형: ${escapeHtml(data.siteType || '추정 불가')}</p>
    <p>예상 저류조 규모: ${escapeHtml(data.tonEstimate || '')} ${data.tonLevel ? '(' + escapeHtml(data.tonLevel) + ')' : ''}</p>
    ${data.tonReason ? '<p class="help">' + escapeHtml(data.tonReason) + '</p>' : ''}
  </div>
  <div class="modal-section">
    <h3>리스크 & 기회</h3>
    <p><strong>리스크:</strong> ${escapeHtml(data.risk || '별도 언급 없음')}</p>
    <p><strong>기회:</strong> ${escapeHtml(data.opportunity || '별도 언급 없음')}</p>
  </div>
  <div class="modal-section">
    <h3>나라장터 첨부파일 이름</h3>
    ${attachHtml}
  </div>
  <div class="modal-buttons">
    <button id="modalCloseBtn" class="btn-outline">닫기</button>
    <button id="modalOpenNara" class="btn-primary" data-link="${escapeHtml(link)}">나라장터 열기</button>
  </div>`;
      } catch (err) {
        content.innerHTML =
          '<p class="error">2차 분석 중 오류가 발생했습니다: ' +
          escapeHtml(err.message) + '</p>';
      }
    }

    function hideDetailModal() {
      document.getElementById('detailModal').classList.add('hidden');
    }

    function escapeHtml(str) {
      return (str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
  </script>
</body>
</html>
