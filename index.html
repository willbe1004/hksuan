<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ğŸ’§ í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Pretendard','Malgun Gothic',sans-serif;
      background:#f4f6f8;
      margin:0;
      color:#333;
    }
    .content-wrapper { max-width:1100px; margin:0 auto; padding:0 10px; }

    /* ìƒë‹¨ ë°•ìŠ¤ (ì ‘í˜ ìœ ì§€) */
    .control-box-bg {
      background:#fff;
      position:sticky; top:0; z-index:1000;
      box-shadow:0 2px 10px rgba(0,0,0,0.05);
      padding:10px 0 14px;
    }
    .button-row {
      display:flex; gap:6px; margin-bottom:8px;
    }
    .button-row button {
      flex:1; padding:10px 0;
      border:none; border-radius:10px;
      font-size:0.9em; font-weight:700;
      color:#fff; cursor:pointer;
    }
    #btn-voice   { background:linear-gradient(135deg,#ff7675,#d63031); }
    #btn-refresh { background:linear-gradient(135deg,#00b894,#00cec9); }
    #btn-add     { background:linear-gradient(135deg,#a29bfe,#6c5ce7); }
    #btn-login   { background:linear-gradient(135deg,#636e72,#2d3436); }

    h1 {
      margin:4px 0 2px;
      font-size:1.6em;
      text-align:center;
    }
    #voice-result {
      text-align:center;
      color:#e17055;
      font-size:0.9em;
      font-weight:600;
      min-height:18px;
      margin-bottom:4px;
    }
    #search-input {
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid #ddd;
      font-size:0.95em;
    }
    #status {
      text-align:center;
      margin-top:8px;
      font-size:0.9em;
      color:#636e72;
      min-height:20px;
    }
    .spin-icon {
      display:inline-block;
      animation:spin 1.5s linear infinite;
      margin-right:4px;
    }
    @keyframes spin {0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    /* ì¹´ë“œ */
    #bid-list { margin-top:10px; }
    .card {
      background:#fff;
      margin:12px 0;
      padding:15px 18px 12px;
      border-radius:14px;
      border-left:5px solid #dfe6e9;
      box-shadow:0 4px 10px rgba(0,0,0,0.03);
    }
    .card.normal { border-left-color:#0984e3; }
    .card.urgent { border-left-color:#ff7675; }

    .card-header-top {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
    }
    .region-tag {
      padding:3px 8px;
      border-radius:999px;
      background:#e8f0fe;
      color:#1a73e8;
      font-size:0.75em;
      font-weight:700;
      margin-right:6px;
    }
    .bid-no {
      font-size:0.8em;
      color:#636e72;
    }
    .status-chip {
      padding:3px 8px;
      border-radius:999px;
      background:#ffeaa7;
      color:#d35400;
      font-size:0.75em;
      font-weight:700;
    }

    .card-title {
      margin:4px 0 2px;
      font-size:1.05em;
      font-weight:800;
      color:#2d3436;
      text-decoration:none;
      display:block;
    }
    .card-title:hover { text-decoration:underline; }

    .card-subinfo {
      font-size:0.8em;
      color:#7f8c8d;
      margin-bottom:6px;
    }

    /* 1ì°¨ ìš”ì•½ ë°” */
    .ai-summary-bar {
      margin-top:4px;
      padding:6px 10px;
      border-radius:10px;
      background:#f5e9ff;
      color:#6c5ce7;
      font-size:0.85em;
      display:flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .ai-summary-title {
      font-weight:700;
      flex-shrink:0;
    }
    .ai-summary-text {
      flex:1;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* 1ì°¨ ìƒì„¸ ë©”ëª¨ */
    .ai-detail-box {
      display:none;
      background:#f8ecff;
      border-radius:10px;
      padding:10px 12px;
      margin-top:6px;
      border:1px solid #e1bee7;
      font-size:0.85em;
      color:#5b2c83;
      line-height:1.6;
    }
    .ai-detail-box ul {
      margin:6px 0 0;
      padding-left:18px;
    }
    .ai-detail-box li { margin-bottom:3px; }

    .ai-detail-note {
      margin-top:8px;
      font-size:0.75em;
      color:#a06ab4;
    }

    /* ì¹´ë“œ í•˜ë‹¨ */
    .card-footer {
      display:flex;
      justify-content:flex-end;
      gap:6px;
      margin-top:8px;
    }
    .card-footer button,
    .card-footer a {
      padding:6px 10px;
      border-radius:8px;
      border:none;
      font-size:0.8em;
      cursor:pointer;
      font-weight:700;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .btn-ai   { background:#a29bfe; color:#fff; }
    .btn-link { background:#dfe6e9; color:#2d3436; }
    .btn-cal  { background:#e3f2fd; color:#0984e3; }

    @media (max-width:600px) {
      .button-row { flex-wrap:wrap; }
      .card-footer { flex-wrap:wrap; }
    }
  </style>
</head>
<body>
<div class="control-box-bg">
  <div class="content-wrapper">
    <div class="button-row">
      <button id="btn-voice">ğŸ¤ ìŒì„±</button>
      <button id="btn-refresh">ğŸ”„ ê³µê³ ê²€ìƒ‰</button>
      <button id="btn-add">ğŸ“ ì§ì ‘ë“±ë¡</button>
      <button id="btn-login">ğŸ“… ë¡œê·¸ì¸</button>
    </div>
    <h1>ğŸ’§ í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬</h1>
    <div id="voice-result"></div>
    <input id="search-input" type="text"
           placeholder="ì˜ˆ: ë‹¤ìŒ ì£¼ ë§ˆê°ë˜ëŠ” ì €ë¥˜ì¡° ê³µê³  ì°¾ì•„ì¤˜ (í˜„ì¬ëŠ” DB í‚¤ì›Œë“œ/AI ê²€ìƒ‰)" />
    <div id="status"></div>
  </div>
</div>

<div id="bid-list" class="content-wrapper"></div>

<script>
  // ===== ê¸°ë³¸ ì„¤ì • =====
  const SCRIPT_URL =
    'https://script.google.com/macros/s/AKfycbxi0Bfdty9LuMJyxCGTqTkyJQJrevz3AqRunbhNmePCh68tta-Fu8w1Lw4E_DROWB99zw/exec';

  let allData = [];

  // ===== ë°ì´í„° ë¡œë“œ =====
  async function loadData() {
    const statusEl = document.getElementById('status');
    statusEl.innerHTML = '<span class="spin-icon">â³</span> ì…ì°° ê³µê³ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...';

    try {
      const res  = await fetch(SCRIPT_URL + '?t=' + Date.now());
      const text = await res.text();
      const json = JSON.parse(text);

      // ë§ˆê° ì§€ë‚œ ê²ƒ í•œ ë²ˆ ë” í•„í„°
      const now = new Date();
      allData = json.filter(it => {
        if (!it.deadline) return true;
        const d = new Date(String(it.deadline).replace(' ', 'T'));
        if (isNaN(d.getTime())) return true;
        return d >= now;
      });
      renderList(allData);
      statusEl.innerHTML = `âœ… ì´ <b>${allData.length}</b>ê±´ì˜ ê³µê³ ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`;
    } catch (e) {
      console.error(e);
      document.getElementById('bid-list').innerHTML = '';
      statusEl.innerHTML = `<span style="color:red">âŒ ì˜¤ë¥˜: ${e.message}</span>`;
    }
  }

  // ===== ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ + 1ì°¨ ìš”ì•½ / ìƒì„¸ ë©”ëª¨ =====
  function renderList(data) {
    const list = document.getElementById('bid-list');
    list.innerHTML = '';

    if (!data.length) {
      list.innerHTML = `
        <div style="text-align:center;padding:40px 0;color:#636e72;">
          ì¡°ê±´ì— ë§ëŠ” ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.
        </div>`;
      return;
    }

    const now = new Date();

    data.forEach((item, index) => {
      const deadlineStr = item.deadline || '';
      const d = new Date(deadlineStr ? deadlineStr.replace(' ', 'T') : now);
      let dDayLabel = 'ë§ˆê°ì¼ ë¯¸ì •';
      let cardClass = 'normal';

      if (!isNaN(d.getTime())) {
        const diff = Math.ceil((d - now) / (1000 * 60 * 60 * 24));
        if (diff < 0) dDayLabel = 'ë§ˆê°ë¨';
        else if (diff === 0) { dDayLabel = 'ì˜¤ëŠ˜ ë§ˆê°'; cardClass = 'urgent'; }
        else {
          dDayLabel = `D-${diff}`;
          if (diff <= 3) cardClass = 'urgent';
        }
      }

      const aiText = (item.aiResult || '').trim() || 'AI ìš”ì•½ ì—†ìŒ';
      const short = aiText.length > 80 ? aiText.slice(0, 80) + 'â€¦' : aiText;

      const div = document.createElement('div');
      div.className = `card ${cardClass}`;
      div.innerHTML = `
        <div class="card-header-top">
          <div>
            <span class="region-tag">#${item.region || 'ì§€ì—­ë¯¸ìƒ'}</span>
            <span class="bid-no">${item.no || '-'}</span>
          </div>
          <span class="status-chip">${dDayLabel}</span>
        </div>

        <a href="${item.link || '#'}" target="_blank" class="card-title">
          ${item.title || '(ì œëª© ì—†ìŒ)'}
        </a>
        <div class="card-subinfo">
          ìˆ˜ìš”ê¸°ê´€: ${item.agency || '-'} Â· ë°œì£¼ì²˜: ${item.client || '-'}
        </div>

        <div class="ai-summary-bar">
          <span class="ai-summary-title">ğŸ“Œ 1ì°¨ AI ìš”ì•½</span>
          <span class="ai-summary-text">${short}</span>
        </div>

        <div id="ai-detail-${index}" class="ai-detail-box"></div>

        <div class="card-footer">
          <button class="btn-ai" data-index="${index}">ğŸ” 1ì°¨ ìš”ì•½ í¼ì¹˜ê¸°</button>
          <a href="${item.link || '#'}" target="_blank" class="btn-link">ğŸ“„ ê³µê³ ë¬¸</a>
        </div>
      `;
      list.appendChild(div);
    });

    // ë²„íŠ¼ ì´ë²¤íŠ¸
    document.querySelectorAll('.btn-ai').forEach(btn => {
      btn.onclick = () => {
        const i = parseInt(btn.dataset.index, 10);
        const box = document.getElementById(`ai-detail-${i}`);
        const item = allData[i];
        const txt  = (item.aiResult || '').trim() || 'AI ìš”ì•½ ì—†ìŒ';

        if (box.style.display === 'block') {
          box.style.display = 'none';
          btn.textContent   = 'ğŸ” 1ì°¨ ìš”ì•½ í¼ì¹˜ê¸°';
          return;
        }

        // ê°„ë‹¨í•œ â€œì‹¤ë¬´ ë©”ëª¨â€ ìƒì„± ë¡œì§
        const level = inferLevelFromText(txt);
        const bullets = buildActionBullets(level, item);

        box.innerHTML = `
          <div><b>1ì°¨ AI ìš”ì•½ ì›ë¬¸</b><br>${txt}</div>
          <hr style="border:none;border-top:1px dashed #d1b4ea;margin:8px 0;">
          <div><b>ì‹¤ë¬´ ë©”ëª¨ (${level} ê´€ì‹¬ë„ ê¸°ì¤€)</b></div>
          <ul>${bullets.map(x=>`<li>${x}</li>`).join('')}</ul>
          <div class="ai-detail-note">
            â€» í˜„ì¬ ë²„ì „ì€ ë°±ì—”ë“œ 1ì°¨ ìš”ì•½ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.<br>
            ê³µê³  ì²¨ë¶€ë¬¸ì„œê¹Œì§€ ë¶„ì„í•˜ëŠ” 2ì°¨ ìƒì„¸ AI ë¶„ì„ì€ ì¶”í›„ ì„œë²„ì—ì„œ í™•ì¥ ì˜ˆì •ì…ë‹ˆë‹¤.
          </div>
        `;
        box.style.display = 'block';
        btn.textContent   = 'ğŸ”’ 1ì°¨ ìš”ì•½ ë‹«ê¸°';
      };
    });
  }

  // ===== ì‹¤ë¬´ ë©”ëª¨ ìƒì„± ë³´ì¡° í•¨ìˆ˜ =====
  function inferLevelFromText(text) {
    if (!text) return 'ì¤‘ê°„';
    if (/(ë§¤ìš°|ë†’ì€|ìƒ)/.test(text)) return 'ë†’ìŒ';
    if (/(ë‚®ì€|í•˜)/.test(text))      return 'ë‚®ìŒ';
    return 'ì¤‘ê°„';
  }
  function buildActionBullets(level, item) {
    const baseTitle = item.title || '';
    if (level === 'ë†’ìŒ') {
      return [
        'í•µì‹¬ íƒ€ê¹ƒ ê³µê³ ì…ë‹ˆë‹¤. ë°œì£¼ì²˜/ë‹´ë‹¹ìì—ê²Œ ì €ë¥˜ì¡° í¬í•¨ ì—¬ë¶€ë¥¼ ë°”ë¡œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.',
        'ì…ì°° ë§ˆê° ì´ì „ì— í˜„ì¥ ì¡°ê±´(ë¶€ì§€ ê·œëª¨, ì§€í•˜ì¸µ ê³„íš ë“±)ì„ í™•ì¸í•´ ì˜ˆìƒ í†¤ìˆ˜ ì‚°ì • ê¸°ì¤€ì„ ì¡ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.',
        'ì„¤ê³„ì‚¬ì™€ì˜ ê´€ê³„ê°€ ìˆë‹¤ë©´, ìš°ìˆ˜Â·ë¹—ë¬¼ ì²˜ë¦¬ íŒŒíŠ¸ ë¶„ë¦¬ ì„¤ê³„/ë¶„ë¦¬ ë°œì£¼ ê°€ëŠ¥ì„±ë„ ì²´í¬í•´ ë³´ì„¸ìš”.'
      ];
    }
    if (level === 'ë‚®ìŒ') {
      return [
        'ì§ì ‘ì ì¸ ë¹—ë¬¼ì €ë¥˜ì¡° ê³µì‚¬ëŠ” ì•„ë‹ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.',
        'ë‹¤ë§Œ ëŒ€ê·œëª¨ í† ëª©Â·ê±´ì¶• ê³µì‚¬ì¸ ê²½ìš°, ë³„ë„ ì €ë¥˜ì¡° ë°œì£¼ê°€ ë’¤ë”°ë¥¼ ìˆ˜ ìˆìœ¼ë‹ˆ í”„ë¡œì íŠ¸ëª…ê³¼ ë°œì£¼ì²˜ëŠ” ë©”ëª¨í•´ ë‘ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.',
        'ë¹„ìŠ·í•œ ìœ í˜•ì˜ ê³µê³ ê°€ ë°˜ë³µë˜ëŠ”ì§€ ì£¼ê°„ ë‹¨ìœ„ë¡œ íŒ¨í„´ë§Œ ì¶”ì í•´ ë³´ì‹œë©´ ì¢‹ê² ìŠµë‹ˆë‹¤.'
      ];
    }
    // ì¤‘ê°„
    return [
      'ì§ì ‘ì ì¸ ì €ë¥˜ì¡° ê³µì‚¬ëŠ” ì•„ë‹ˆì§€ë§Œ, ìš°ìˆ˜ ì²˜ë¦¬Â·ì¹¨ìˆ˜ ë°©ì§€ ì‹œì„¤ì´ í¬í•¨ë  ì—¬ì§€ê°€ ìˆëŠ” ê³µê³ ì…ë‹ˆë‹¤.',
      'ê³µê³ ë¬¸ ë° ì„¤ê³„ ê°œìš”ì—ì„œ ë¹—ë¬¼ì €ë¥˜ì¡°/ìš°ìˆ˜ì €ë¥˜ì¡°/ì¡°ì ˆì§€ ë“±ì˜ í‚¤ì›Œë“œê°€ ìˆëŠ”ì§€ í•œ ë²ˆ ë” í™•ì¸í•´ ì£¼ì„¸ìš”.',
      'ë°œì£¼ì²˜ ê¸°ìˆ ë¶€ì„œì— â€œìš°ìˆ˜Â·ì¹¨ìˆ˜ ëŒ€ì±… ì‹œì„¤ ê³„íš ì—¬ë¶€â€ë¥¼ ì§ˆì˜í•´ ë³´ê³  ë³„ë„ ë°œì£¼ ê°€ëŠ¥ì„±ì´ ìˆìœ¼ë©´ ìº˜ë¦°ë”ì— ë¶ë§ˆí¬í•´ ë‘ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.'
    ];
  }

  // ===== ê²€ìƒ‰ (í˜„ì¬: DB ê¸°ë°˜ í‚¤ì›Œë“œ + ë‚ ì§œ AI í•„í„°) =====
  function simpleSearch(keyword) {
    const q = keyword.toLowerCase();
    const filtered = allData.filter(item =>
      (item.title  || '').toLowerCase().includes(q) ||
      (item.agency || '').toLowerCase().includes(q) ||
      (item.region || '').toLowerCase().includes(q)
    );
    renderList(filtered);
    const status = document.getElementById('status');
    status.innerHTML = filtered.length
      ? `ğŸ” "<b>${keyword}</b>" ê²€ìƒ‰ ê²°ê³¼: ${filtered.length}ê±´`
      : `ğŸ” "<b>${keyword}</b>" ë‚´ë¶€ DB ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ`;
  }

  async function searchWithAI(keyword) {
    // í˜„ì¬ëŠ” ê°„ë‹¨íˆ DB ê²€ìƒ‰ â†’ ì´í›„ ìŒì„±/LLM+ê³µê³µë°ì´í„° í™•ì¥ ì˜ˆì •
    simpleSearch(keyword);
  }

  function doSearch(keyword) {
    if (!keyword) {
      renderList(allData);
      document.getElementById('status').innerHTML =
        `ì „ì²´ <b>${allData.length}</b>ê±´`;
      return;
    }
    if (keyword.match(/(ë‚´ì¼|ëª¨ë ˆ|ì´ë²ˆì£¼|ë‹¤ìŒì£¼|ì˜¤ëŠ˜|ë§ˆê°)/)) {
      searchWithAI(keyword);
    } else {
      simpleSearch(keyword);
    }
  }

  // ===== ìŒì„± ì¸ì‹ â†’ ìš°ì„  DB ê²€ìƒ‰ + í–¥í›„ ë°±ì—”ë“œ ì—°ë™ í¬ì¸íŠ¸ =====
  document.getElementById('btn-voice').onclick = () => {
    if (!('webkitSpeechRecognition' in window)) {
      alert('í¬ë¡¬ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ìŒì„± ì¸ì‹ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
      return;
    }
    const rec = new webkitSpeechRecognition();
    rec.lang  = 'ko-KR';
    rec.start();
    const vr = document.getElementById('voice-result');
    vr.innerText = 'ë“£ê³  ìˆìŠµë‹ˆë‹¤... ğŸ‘‚';

    rec.onresult = async (e) => {
      const txt = e.results[0][0].transcript;
      vr.innerText = `ğŸ—£ï¸ "${txt}"`;
      document.getElementById('search-input').value = txt;

      // 1ë‹¨ê³„: í˜„ì¬ëŠ” ë‚´ë¶€ DB + ê°„ë‹¨ AI ê²€ìƒ‰
      doSearch(txt);

      // 2ë‹¨ê³„(ì„¤ê³„ë§Œ): í–¥í›„ ì—¬ê¸°ì„œ SCRIPT_URL?action=voiceSearch&query=...
      // ë¥¼ í˜¸ì¶œí•˜ì—¬ ê³µê³µë°ì´í„°/ì›¹ê¹Œì§€ í™•ì¥ëœ ê²°ê³¼ë¥¼ ë³‘í•© í‘œì‹œí•  ìˆ˜ ìˆê²Œ ì„¤ê³„í•´ ë‘ì—ˆìŠµë‹ˆë‹¤.
      // const res = await fetch(SCRIPT_URL + '?action=voiceSearch&query=' + encodeURIComponent(txt));
      // const extra = await res.json();
      // -> allDataì™€ ë³‘í•© í›„ renderList([...extra, ...allData])
    };
  };

  // ===== ê¸°íƒ€ ë²„íŠ¼ =====
  document.getElementById('btn-refresh').onclick = loadData;
  document.getElementById('search-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') doSearch(e.target.value);
  });
  document.getElementById('btn-add').onclick = () => {
    alert('ì§ì ‘ë“±ë¡/ìŠ¤ë§ˆíŠ¸ë“±ë¡ UIëŠ” ë‹¤ìŒ ë¼ìš´ë“œì—ì„œ í•©ì¹˜ê² ìŠµë‹ˆë‹¤ ğŸ™‚');
  };
  document.getElementById('btn-login').onclick = () => {
    alert('ìº˜ë¦°ë” ì—°ë™ì€ ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ì…”ë„ ë˜ê³ , í•„ìš” ì‹œ ì•Œë ¤ì£¼ì‹œë©´ í•©ì³ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.');
  };

  // ===== ì´ˆê¸° ì‹¤í–‰ =====
  loadData();
</script>
</body>
</html>
