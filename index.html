<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬</title>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ + ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        * { box-sizing: border-box; }
        body { font-family: 'Pretendard', sans-serif; background-color: #f2f4f6; margin: 0; padding: 0; color: #333; }
        .content-wrapper { max-width: 1200px; width: 96%; margin: 0 auto; }
        
        .control-box-bg { background: white; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-radius: 0 0 20px 20px; padding: 15px 0; }
        
        /* ë²„íŠ¼ 4ê°œë¡œ ë³€ê²½ */
        .button-row { display: flex; gap: 8px; width: 100%; margin-bottom: 15px; }
        .button-row button { flex: 1; padding: 10px 0; border: none; border-radius: 10px; font-size: 0.9em; font-weight: bold; color: white; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        #btn-voice { background: linear-gradient(135deg, #ff7675, #d63031); } 
        #btn-refresh { background: linear-gradient(135deg, #00b894, #00cec9); }
        #btn-login { background: linear-gradient(135deg, #0984e3, #74b9ff); }
        /* ìƒˆë¡œ ì¶”ê°€ëœ ë²„íŠ¼ ìƒ‰ìƒ */
        #btn-add { background: linear-gradient(135deg, #6c5ce7, #a29bfe); }

        h1 { margin: 15px 0; font-size: 1.5em; color: #1e272e; text-align: center; font-weight: 800; }
        .input-group { display: flex; gap: 8px; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #dfe6e9; border-radius: 10px; font-size: 16px; }
        #btn-search { width: 70px; background: #636e72; color: white; border: none; border-radius: 10px; font-weight: bold; }
        
        #status { text-align: center; margin-top: 20px; color: #636e72; font-size: 0.9em; min-height: 25px; }
        .spin-icon { display: inline-block; animation: spin 1s linear infinite; margin-right: 5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #bid-list { margin-top: 20px; }
        .card { background: white; padding: 20px; margin-bottom: 15px; border-radius: 16px; border-left: 6px solid #ddd; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .card-header { display: flex; justify-content: space-between; font-size: 0.9em; color: #888; margin-bottom: 8px; }
        .card-title { font-size: 1.2em; font-weight: bold; color: #2d3436; display: block; margin-bottom: 10px; text-decoration: none; }
        .d-day { background: #ffeaa7; color: #d35400; padding: 3px 8px; border-radius: 20px; font-size: 0.8em; }
        .card-info { font-size: 0.95em; color: #636e72; }
        
        .ai-analysis-box { display: none; background: #f3e5f5; padding: 15px; margin-top: 10px; border-radius: 10px; font-size: 0.9em; color: #4a148c; }
        
        .card-footer { display: flex; justify-content: flex-end; gap: 8px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #f1f1f1; }
        .btn-mini { padding: 8px 15px; border-radius: 6px; border:none; font-size:0.85em; font-weight:bold; cursor:pointer; color:white; }
        .btn-ai { background: #a29bfe; } .btn-link { background: #dfe6e9; color: #333; text-decoration:none; display:inline-block;} .btn-cal { background: #74b9ff; }

        /* ëª¨ë‹¬ì°½ ìŠ¤íƒ€ì¼ (ë“±ë¡ìš©) */
        #add-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center; }
        .modal-content { background:white; padding:25px; border-radius:15px; width:90%; max-width:500px; }
        textarea { width:100%; height:150px; padding:10px; margin:10px 0; border-radius:8px; border:1px solid #ddd; font-size:14px; }
        .modal-btns { display:flex; justify-content:flex-end; gap:10px; }

        .calendar-area { margin-top: 20px; display:none; }
        iframe { width: 100%; height: 500px; border:none; border-radius:16px; }
    </style>
</head>
<body>

    <div class="control-box-bg">
        <div class="content-wrapper">
            <div class="button-row">
                <button id="btn-voice">ğŸ¤ ìŒì„±</button>
                <button id="btn-refresh">ğŸ”„ ê³µê³ ê²€ìƒ‰</button>
                <button id="btn-add">ğŸ“ ì§ì ‘ë“±ë¡</button> <button id="btn-login">ğŸ“… ë¡œê·¸ì¸</button>
            </div>

            <h1>ğŸ’§ í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬</h1>
            <div class="voice-text" id="voice-result" style="text-align:center; color:#e17055; font-size:0.9em; min-height:20px;"></div>

            <div class="input-group">
                <input type="text" id="search-input" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥">
                <button id="btn-search">ê²€ìƒ‰</button>
            </div>
            <div id="user-info" style="text-align:right; font-size:0.8em; color:#aaa; margin-top:5px;"></div>
        </div>
    </div>

    <div id="status"></div>
    <div id="bid-list" class="content-wrapper"></div>
    
    <div class="calendar-area content-wrapper" id="cal-area">
        <h3 style="text-align:center; color:#2c3e50;">ğŸ“… ì…ì°° ì¼ì •í‘œ</h3>
        <iframe id="cal-frame" src=""></iframe>
    </div>

    <div id="add-modal">
        <div class="modal-content">
            <h3>ğŸ“ ì™¸ë¶€ ê³µê³  ìŠ¤ë§ˆíŠ¸ ë“±ë¡</h3>
            <p style="font-size:0.9em; color:#666;">ì™¸ë¶€ ì‚¬ì´íŠ¸(êµ¬ê¸€/ë„¤ì´ë²„ ë“±)ì—ì„œ ë³µì‚¬í•œ ê³µê³  ë‚´ìš©ì„ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. AIê°€ ìë™ìœ¼ë¡œ ì •ë¦¬í•´ì¤ë‹ˆë‹¤.</p>
            <textarea id="paste-area" placeholder="ì˜ˆ: [ì„œìš¸ì‹œì²­] ë¹—ë¬¼ì €ë¥˜ì¡° ì„¤ì¹˜ê³µì‚¬ ì…ì°° ê³µê³  ... ë§ˆê°ì¼: 2025ë…„ 12ì›” 1ì¼ ..."></textarea>
            <div class="modal-btns">
                <button onclick="closeModal()" style="background:#b2bec3; padding:10px 20px; border:none; border-radius:8px; color:white;">ì·¨ì†Œ</button>
                <button onclick="processSmartAdd()" style="background:#6c5ce7; padding:10px 20px; border:none; border-radius:8px; color:white; font-weight:bold;">AI ë¶„ì„ ë° ì €ì¥</button>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        // ğŸ”‘ API ë° ì„¤ì •ê°’ (ê³ ê°ë‹˜ ê°’ìœ¼ë¡œ ìœ ì§€)
        const GEMINI_API_KEY = 'AIzaSyDaRFQQE-I3lwCnIiKcRWIUYxQLHrrfO1M'; // ğŸ”¥ ê¼­ ì±„ì›Œì£¼ì„¸ìš”
        const SCRIPT_URL = 'https://script.google.com/macros/library/d/1ybSbtP-AUQNnUibCEM17YkAc5kjsqa2FYGMUpCFKB-FoDyUqrtN-8Y17/3'; // ğŸ”¥ ê¼­ ì±„ì›Œì£¼ì„¸ìš”
        const BID_CALENDAR_ID = 'd51a10e0014dcbd83e98d0da91cda4f52f629c19652c15fc693ee4529bbbab04@group.calendar.google.com'; 
        const CLIENT_ID = '1049915608396-i3jn8jrm24bc9mkagdtokk3rfa3li513.apps.googleusercontent.com'; 
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events';
        const STORAGE_KEY = 'hksuan_google_token_v2';

        let allData = [];
        let tokenClient;
        let isLogin = false;

        // ... (ê¸°ì¡´ setupCalendarView, loadData, renderList í•¨ìˆ˜ë“¤ì€ ë™ì¼í•˜ê²Œ ì‚¬ìš©) ...
        // (ì§€ë©´ ê´€ê³„ìƒ ìƒëµëœ ë¶€ë¶„ì€ ìœ„ ì½”ë“œì™€ ë˜‘ê°™ìŠµë‹ˆë‹¤. ì „ì²´ í•©ì¹  ë•Œ ìœ„ ì½”ë“œ ì°¸ê³ í•˜ì„¸ìš”.)

        // ğŸ”¥ [ì‹ ê·œ ê¸°ëŠ¥] ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
        document.getElementById('btn-add').onclick = () => {
            document.getElementById('add-modal').style.display = 'flex';
        };
        function closeModal() {
            document.getElementById('add-modal').style.display = 'none';
            document.getElementById('paste-area').value = '';
        }

        // ğŸ”¥ [ì‹ ê·œ ê¸°ëŠ¥] AIê°€ í…ìŠ¤íŠ¸ ë¶„ì„í•´ì„œ ì—‘ì…€ì— ì €ì¥
        async function processSmartAdd() {
            const text = document.getElementById('paste-area').value;
            if (!text) { alert("ë‚´ìš©ì„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”!"); return; }

            const btn = document.querySelector('#add-modal button:last-child');
            btn.innerText = "ğŸ§  ë¶„ì„ ë° ì €ì¥ ì¤‘...";
            btn.disabled = true;

            // 1. Geminiì—ê²Œ ë¶„ì„ ìš”ì²­
            const prompt = `
                ì‚¬ìš©ìê°€ ë¶™ì—¬ë„£ì€ ê³µê³  í…ìŠ¤íŠ¸ì•¼. ì—¬ê¸°ì„œ [ê³µê³ ëª…, ê³µê³ ë²ˆí˜¸(ì—†ìœ¼ë©´ 'ì •ë³´ì—†ìŒ'), ê³µê³ ì¼(YYYY-MM-DD), ë§ˆê°ì¼(YYYY-MM-DD HH:mm), ë°œì£¼ì²˜, ë§í¬(ì—†ìœ¼ë©´ 'ì •ë³´ì—†ìŒ')]ë¥¼ ì¶”ì¶œí•´ì¤˜.
                ê²°ê³¼ëŠ” ì˜¤ì§ JSONìœ¼ë¡œë§Œ ì¤˜.
                í…ìŠ¤íŠ¸: "${text}"
                JSONí˜•ì‹: {"title": "...", "no": "...", "date": "...", "deadline": "...", "agency": "...", "link": "..."}
            `;
            
            try {
                const aiRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const aiData = await aiRes.json();
                let aiText = aiData.candidates[0].content.parts[0].text;
                aiText = aiText.replace(/```json/g, '').replace(/```/g, '').trim();
                const jsonMatch = aiText.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("AI ë¶„ì„ ì‹¤íŒ¨");
                const result = JSON.parse(jsonMatch[0]);

                // 2. Apps Scriptë¡œ ë°ì´í„° ì „ì†¡ (ì €ì¥)
                // GET ë°©ì‹ìœ¼ë¡œ ë°ì´í„° ì „ì†¡ (action=add)
                const saveUrl = `${SCRIPT_URL}?action=add` + 
                    `&title=${encodeURIComponent(result.title)}` +
                    `&no=${encodeURIComponent(result.no)}` +
                    `&date=${encodeURIComponent(result.date)}` +
                    `&deadline=${encodeURIComponent(result.deadline)}` +
                    `&agency=${encodeURIComponent(result.agency)}` +
                    `&link=${encodeURIComponent(result.link)}`;

                await fetch(saveUrl); // ì €ì¥ ìš”ì²­
                
                alert(`âœ… ì €ì¥ ì™„ë£Œ!\n[${result.title}]`);
                closeModal();
                loadData(); // ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨

            } catch (e) {
                alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
            } finally {
                btn.innerText = "AI ë¶„ì„ ë° ì €ì¥";
                btn.disabled = false;
            }
        }

        // ... (ë‚˜ë¨¸ì§€ í•¨ìˆ˜ë“¤: searchWithAI, analyzeBidWithAI ë“± ê¸°ì¡´ ì½”ë“œ ìœ ì§€) ...
        // (ì½”ë“œ ì „ì²´ í•©ì¹˜ê¸°ê°€ ì–´ë ¤ìš°ì‹œë©´ ë§ì”€í•´ ì£¼ì„¸ìš”. í•œ ë²ˆì— ë‹¤ í•©ì¹œ ê¸´ ì½”ë“œë¥¼ ë“œë¦¬ê² ìŠµë‹ˆë‹¤!)
