<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬</title>
    <style>
        /* 1. ê¸°ë³¸ ì„¤ì • */
        * { box-sizing: border-box; }
        body { 
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif; 
            background-color: #f2f4f6; 
            margin: 0; padding: 0; color: #333; 
        }
        .content-wrapper { max-width: 1200px; width: 96%; margin: 0 auto; }

        /* 2. ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë°•ìŠ¤ */
        .control-box-bg { 
            background: white; position: sticky; top: 0; z-index: 1000; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
            padding: 15px 0; 
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .button-row { display: flex; gap: 8px; width: 100%; margin-bottom: 15px; }
        .button-row button {
            flex: 1; padding: 12px 0; border: none; border-radius: 12px; 
            font-size: 0.9em; font-weight: bold; color: white; cursor: pointer;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1); transition: transform 0.1s;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .button-row button:active { transform: scale(0.96); }
        
        #btn-voice { background: linear-gradient(135deg, #ff7675, #d63031); } 
        #btn-refresh { background: linear-gradient(135deg, #00b894, #00cec9); }
        #btn-add { background: linear-gradient(135deg, #a29bfe, #6c5ce7); } 
        #btn-login { background: linear-gradient(135deg, #0984e3, #74b9ff); } 

        /* ì œëª© */
        h1 { margin: 15px 0; font-size: 1.6em; color: #1e272e; text-align: center; font-weight: 800; letter-spacing: -0.5px; }
        
        /* ê²€ìƒ‰ì°½ */
        .input-group { display: flex; gap: 8px; }
        input[type="text"] { 
            flex: 1; padding: 12px 15px; border: 1px solid #dfe6e9; 
            border-radius: 10px; font-size: 16px; background: #f8f9fa; outline: none;
        }
        input[type="text"]:focus { border-color: #0984e3; background: white; }
        #btn-search {
            width: 80px; background: #636e72; color: white; border: none;
            border-radius: 10px; font-weight: bold; cursor: pointer;
        }

        .voice-text { color: #e17055; font-weight: bold; min-height: 20px; margin: 5px 0; font-size: 0.9em; text-align: center;}
        #user-info { text-align: right; font-size: 0.8em; color: #b2bec3; margin-top: 5px; height: 15px;}
        #status { text-align: center; margin-top: 30px; color: #636e72; font-size: 1em; font-weight: 500; min-height: 30px; line-height: 1.5; }
        
        .spin-icon { display: inline-block; animation: spin 1.5s linear infinite; font-size: 1.2em; margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #bid-list { margin-top: 20px; }
        
        /* ğŸ”¥ [ìˆ˜ì •ë¨] ì¹´ë“œ ìŠ¤íƒ€ì¼ - ê¹”ë”í•œ ì •ë¦¬ */
        .card { 
            background: white; padding: 25px; margin-bottom: 15px; 
            border-radius: 16px; border-left: 6px solid #ddd; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.03); 
            transition: transform 0.2s; width: 100%;
        }
        .card:hover { transform: translateY(-3px); }
        .card.urgent { border-left-color: #ff7675; }
        .card.normal { border-left-color: #0984e3; }
        
        /* ì¹´ë“œ í—¤ë” (ì§€ì—­ ë°°ì§€, D-Day) */
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .region-badge { 
            background: #f1f3f5; color: #495057; padding: 4px 8px; 
            border-radius: 6px; font-size: 0.85em; font-weight: 600; 
        }
        .d-day { 
            background: #ffeaa7; color: #d35400; padding: 4px 10px; 
            border-radius: 20px; font-size: 0.85em; font-weight: bold; 
        }

        .card-title { 
            font-size: 1.35em; font-weight: 800; color: #2d3436; 
            text-decoration: none; display: block; margin-bottom: 15px; 
            line-height: 1.4; 
        }
        
        /* ğŸ”¥ [ì‹ ê·œ] ì •ë³´ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ (ê¹”ë”í•œ ì •ë ¬) */
        .info-grid {
            display: grid;
            grid-template-columns: 70px 1fr; /* ë¼ë²¨ ê³ ì •í­, ë‚´ìš© ë‚˜ë¨¸ì§€ */
            gap: 6px 10px;
            font-size: 0.95em;
            color: #495057;
        }
        .info-label { color: #adb5bd; font-weight: 500; }
        .info-val { font-weight: 600; }
        .highlight-price { color: #0984e3; }
        .highlight-date { color: #d63031; }

        /* AI ë¶„ì„ ë°•ìŠ¤ */
        .ai-analysis-box {
            display: none; background-color: #f8f9fa; padding: 15px; 
            margin-top: 15px; border-radius: 12px; font-size: 0.9em; color: #5e35b1;
            border: 1px solid #e1bee7; line-height: 1.6;
        }

        .card-footer { display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px; padding-top: 15px; border-top: 1px solid #f1f1f1; }
        .btn-card { 
            padding: 10px 16px; border-radius: 8px; border:none; 
            font-size:0.9em; cursor:pointer; font-weight:bold; text-decoration: none; display: inline-block;
        }
        .btn-link { background: #f1f2f6; color: #2f3542; }
        .btn-cal { background: #e3f2fd; color: #0984e3; }
        .btn-ai { background: linear-gradient(135deg, #a29bfe, #6c5ce7); color: white; } 
        
        /* ëª¨ë‹¬ & ìº˜ë¦°ë” */
        #add-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center; }
        .modal-content { background:white; padding:25px; border-radius:15px; width:90%; max-width:500px; }
        textarea { width:100%; height:150px; padding:10px; margin:10px 0; border-radius:8px; border:1px solid #ddd; font-size:14px; font-family: sans-serif; resize: none; }
        .modal-btns { display:flex; justify-content:flex-end; gap:10px; }
        
        .calendar-area { margin-top: 20px; display:none; }
        iframe { width: 100%; height: 600px; border:none; border-radius:16px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

    <div class="control-box-bg">
        <div class="content-wrapper">
            <div class="button-row">
                <button id="btn-voice">ğŸ¤ ìŒì„±</button>
                <button id="btn-refresh">ğŸ”„ ê³µê³ ê²€ìƒ‰</button>
                <button id="btn-add">ğŸ“ ì§ì ‘ë“±ë¡</button> 
                <button id="btn-login">ğŸ“… ë¡œê·¸ì¸</button>
            </div>

            <h1>ğŸ’§ í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬</h1>
            <div class="voice-text" id="voice-result"></div>

            <div class="input-group">
                <input type="text" id="search-input" placeholder="ì˜ˆ: ë‹¤ìŒ ì£¼ ë§ˆê°ë˜ëŠ” ì €ë¥˜ì¡° ê³µê³  ì°¾ì•„ì¤˜">
                <button id="btn-search">ê²€ìƒ‰</button>
            </div>
            <div id="user-info"></div>
        </div>
    </div>

    <div id="status">
        <span class="spin-icon">â³</span> ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...
    </div>
    
    <div id="bid-list" class="content-wrapper"></div>
    
    <div class="calendar-area content-wrapper" id="cal-area">
        <h3 style="text-align:center; color:#2c3e50;">ğŸ“… ì…ì°° ì¼ì •í‘œ</h3>
        <iframe id="cal-frame" src=""></iframe>
    </div>

    <div id="add-modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:#2c3e50;">ğŸ“ ì™¸ë¶€ ê³µê³  ìŠ¤ë§ˆíŠ¸ ë“±ë¡</h3>
            <p style="font-size:0.9em; color:#666; line-height:1.4;">ì™¸ë¶€ ì‚¬ì´íŠ¸ ê³µê³  ë‚´ìš©ì„ ë³µì‚¬í•´ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
            <textarea id="paste-area" placeholder="[ì˜ˆì‹œ] ê³µê³ ëª…: ì„œìš¸ì‹œ ë¹—ë¬¼ì €ë¥˜ì¡° ì„¤ì¹˜ê³µì‚¬..."></textarea>
            <div class="modal-btns">
                <button onclick="closeModal()" style="background:#b2bec3; color:white; border:none; padding:10px 20px; border-radius:8px;">ì·¨ì†Œ</button>
                <button onclick="processSmartAdd()" style="background:#6c5ce7; color:white; border:none; padding:10px 20px; border-radius:8px; font-weight:bold;">âœ¨ AI ë¶„ì„ ë° ì €ì¥</button>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        // ============================================================
        // ğŸ”‘ í‚¤ ë° ì„¤ì •
        const GEMINI_API_KEY = 'AIzaSyDu8QKqqTRxutvYqr8GWOUKJLAoT2lZS1k';
        const GEMINI_MODEL_ID = 'gemini-1.5-flash-latest';
        const BID_CALENDAR_ID = 'd51a10e0014dcbd83e98d0da91cda4f52f629c19652c15fc693ee4529bbbab04@group.calendar.google.com'; 
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxi0Bfdty9LuMJyxCGTqTkyJQJrevz3AqRunbhNmePCh68tta-Fu8w1Lw4E_DROWB99zw/exec'; 
        
        const CLIENT_ID = '1049915608396-i3jn8jrm24bc9mkagdtokk3rfa3li513.apps.googleusercontent.com'; 
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events';
        const STORAGE_KEY = 'hksuan_google_token_v2'; 
        // ============================================================

        let allData = [];
        let tokenClient;
        let isLogin = false;

        // ... (ìº˜ë¦°ë” ë·°, Gemini í˜¸ì¶œ ë“± ê¸°ì¡´ ë¡œì§ ìœ ì§€) ...
        // ì§€ë©´ìƒ í•µì‹¬ì¸ renderListì™€ loadData ë¶€ë¶„ë§Œ ìˆ˜ì •ëœ ê²ƒì„ ë³´ì—¬ë“œë¦½ë‹ˆë‹¤.
        // ì‹¤ì œ ì‚¬ìš© ì‹œì—ëŠ” ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ì„ ê·¸ëŒ€ë¡œ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.

        // ğŸ’¡ ì „ì²´ ë¡œì§ì„ í¬í•¨í•œ ìŠ¤í¬ë¦½íŠ¸ ë¸”ë¡ì…ë‹ˆë‹¤.
        
        function setupCalendarView() {
            const iframe = document.getElementById('cal-frame');
            let calSrc = `https://calendar.google.com/calendar/embed?src=${encodeURIComponent(BID_CALENDAR_ID)}&ctz=Asia%2FSeoul&hl=ko`;
            if (BID_CALENDAR_ID === 'primary') calSrc = 'https://calendar.google.com/calendar/embed?src=primary&ctz=Asia%2FSeoul&hl=ko';
            iframe.src = calSrc;
        }

        async function callGemini(prompt) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);
            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1/models/${GEMINI_MODEL_ID}:generateContent?key=${GEMINI_API_KEY}`,
                    { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }), signal: controller.signal }
                );
                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || `HTTP ${response.status}`);
                return data;
            } finally { clearTimeout(timeoutId); }
        }
        function extractGeminiText(data) {
            const parts = data?.candidates?.[0]?.content?.parts || [];
            let text = parts.map(p => p.text || '').join('\n');
            return text.replace(/```json/g, '').replace(/```/g, '').trim();
        }

        async function loadData() {
            const status = document.getElementById('status');
            status.innerHTML = `<span class="spin-icon">â³</span> ì…ì°° ê³µê³ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...`;
            try {
                const res = await fetch(SCRIPT_URL);
                if (!res.ok) throw new Error('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
                const text = await res.text();
                if (text.trim().startsWith('<')) throw new Error('Apps Script URL í™•ì¸ í•„ìš”');
                allData = JSON.parse(text);
                renderList(allData);
                status.innerHTML = `âœ… ì´ <b>${allData.length}</b>ê±´ì˜ ê³µê³ ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`;
            } catch (e) {
                status.innerHTML = `<span style="color:red">âŒ ì˜¤ë¥˜ ë°œìƒ: ${e.message}</span>`;
            }
        }

        // ğŸ”¥ [ìˆ˜ì •ëœ ë Œë”ë§ í•¨ìˆ˜] - ê¹”ë”í•œ í‘œ ë””ìì¸ ì ìš©
        function renderList(data) {
            const list = document.getElementById('bid-list');
            list.innerHTML = "";
            
            const query = document.getElementById('search-input').value;
            if(data.length === 0) {
                // (ê²°ê³¼ ì—†ìŒ ì²˜ë¦¬ ìƒëµ - ê¸°ì¡´ê³¼ ë™ì¼)
                 list.innerHTML = `<div style='text-align:center; padding:50px; color:#888;'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                // ì™¸ë¶€ ê²€ìƒ‰ ë²„íŠ¼ ë¡œì§ì€ ìœ ì§€
                 if(query) { /* ì™¸ë¶€ê²€ìƒ‰ ë²„íŠ¼ ì½”ë“œ */ }
                 return;
            }

            data.forEach((item, index) => {
                const today = new Date();
                const end = new Date(item.deadline);
                const diff = Math.ceil((end - today) / (1000*60*60*24));
                let dDay = diff < 0 ? "ë§ˆê°ë¨" : `D-${diff}`;
                if (diff === 0) dDay = "ì˜¤ëŠ˜ë§ˆê°";
                const cardClass = diff <= 3 ? "urgent" : "normal";

                // ë°ì´í„° í•„ë“œ ì²˜ë¦¬
                const region = item.region || 'ì§€ì—­ë¯¸ìƒ';
                const agency = item.agency || item.client || '-'; // ìˆ˜ìš”ê¸°ê´€
                const client = item.client || item.agency || '-'; // ë°œì£¼ì²˜
                
                // ì—‘ì…€ì˜ í•­ëª©ë“¤ì„ ê¹”ë”í•˜ê²Œ ì •ë¦¬
                // ê°’ì´ ì—†ê±°ë‚˜ '-' ì¸ ê²½ìš°ì—” ë³´ì—¬ì£¼ì§€ ì•Šë„ë¡ í•„í„°ë§ í•  ìˆ˜ë„ ìˆìœ¼ë‚˜,
                // ë ˆì´ì•„ì›ƒ ìœ ì§€ë¥¼ ìœ„í•´ ë³´ì—¬ì£¼ë˜ ê¹”ë”í•˜ê²Œ ì²˜ë¦¬
                
                const div = document.createElement('div');
                div.className = `card ${cardClass}`;
                div.innerHTML = `
                    <div class="card-header">
                        <span class="region-badge">${region}</span>
                        <span class="d-day">${dDay}</span>
                    </div>
                    
                    <a href="${item.link}" target="_blank" class="card-title">${item.title}</a>
                    
                    <div class="info-grid">
                        <span class="info-label">ë°œì£¼/ìˆ˜ìš”</span>
                        <span class="info-val">${client} / ${agency}</span>
                        
                        <span class="info-label">ì¶”ì •ê¸ˆì•¡</span>
                        <span class="info-val highlight-price">${item.serviceAmount || item.price || '-'}</span>
                        
                        <span class="info-label">ë§ˆê°ì¼ì‹œ</span>
                        <span class="info-val highlight-date">${item.deadline || '-'}</span>
                        
                        ${ item.servicePeriod && item.servicePeriod !== '-' ? `<span class="info-label">ìš©ì—­ê¸°ê°„</span><span class="info-val">${item.servicePeriod}</span>` : '' }
                        ${ item.siteArea && item.siteArea !== '-' ? `<span class="info-label">ëŒ€ì§€ë©´ì </span><span class="info-val">${item.siteArea}</span>` : '' }
                        
                        <span class="info-label">ì§„í–‰ìƒíƒœ</span>
                        <span class="info-val">${item.status}</span>
                    </div>

                    <div id="ai-result-${index}" class="ai-analysis-box"></div>

                    <div class="card-footer">
                        <button class="btn-card btn-ai" onclick="analyzeBidWithAI('${item.title}', '${agency}', '${item.deadline}', ${index})">ğŸ¤– AI ë¶„ì„</button>
                        <a href="${item.link}" target="_blank" class="btn-card btn-link">ğŸ“„ ê³µê³ ë¬¸</a>
                        <button class="btn-card btn-cal" onclick="addToCal('${item.title}', '${item.deadline}')">ğŸ“… ìº˜ë¦°ë”</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }
        
        // ... (ë‚˜ë¨¸ì§€ í•¨ìˆ˜ë“¤: ëª¨ë‹¬, AIê²€ìƒ‰, ìº˜ë¦°ë” ë“± ê¸°ì¡´ê³¼ ë™ì¼) ...
        // ìƒëµëœ ë¶€ë¶„ì€ ì´ì „ ì½”ë“œì™€ ë™ì¼í•˜ê²Œ ìœ ì§€í•´ì£¼ì„¸ìš”.

        // (ì „ì²´ ì½”ë“œ í•©ë³¸ì´ í•„ìš”í•˜ì‹œë©´ ë§ì”€í•´ì£¼ì„¸ìš”. ì—¬ê¸°ëŠ” ìˆ˜ì •ëœ renderListê°€ í•µì‹¬ì…ë‹ˆë‹¤.)
        
        // ---------- ì´í•˜ ëª¨ë‹¬, AIí•¨ìˆ˜ ë“± ê¸°ì¡´ ì½”ë“œ ë³µì› ----------
        document.getElementById('btn-add').onclick = () => { document.getElementById('add-modal').style.display = 'flex'; };
        function closeModal() { document.getElementById('add-modal').style.display = 'none'; document.getElementById('paste-area').value = ''; }
        
        async function processSmartAdd() { /* ... ê¸°ì¡´ ë™ì¼ ... */ }
        function simpleSearch(keyword) { /* ... ê¸°ì¡´ ë™ì¼ ... */ }
        async function searchWithAI(query) { /* ... ê¸°ì¡´ ë™ì¼ ... */ }
        async function analyzeBidWithAI(title, agency, deadline, index) { /* ... ê¸°ì¡´ ë™ì¼ ... */ }
        function doSearch(keyword) { /* ... ê¸°ì¡´ ë™ì¼ ... */ }
        function initGoogle() { /* ... ê¸°ì¡´ ë™ì¼ ... */ }
        function updateLoginState(loggedIn) { /* ... ê¸°ì¡´ ë™ì¼ ... */ }
        function handleLogout() { /* ... ê¸°ì¡´ ë™ì¼ ... */ }
        async function addToCal(title, deadline) { /* ... ê¸°ì¡´ ë™ì¼ ... */ }
        
        document.getElementById('btn-voice').onclick = () => { /* ... */ };
        document.getElementById('btn-search').onclick = () => doSearch(document.getElementById('search-input').value);
        document.getElementById('btn-refresh').onclick = loadData;

        setupCalendarView();
        loadData();
        initGoogle();
    </script>
</body>
</html>
