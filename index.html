<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
      background-color: #f2f4f6;
      margin: 0;
      color: #333;
    }
    .content-wrapper { max-width: 1200px; width: 96%; margin: 0 auto; }

    /* ìƒë‹¨ ì»¨íŠ¸ë¡¤ */
    .control-box-bg {
      background: white;
      position: sticky; top: 0; z-index: 1000;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      padding: 15px 0 20px;
      border-bottom-left-radius: 20px;
      border-bottom-right-radius: 20px;
    }
    .button-row {
      display: flex; gap: 8px; width: 100%; margin-bottom: 15px;
    }
    .button-row button {
      flex: 1;
      padding: 12px 0;
      border: none;
      border-radius: 12px;
      font-size: 0.9em;
      font-weight: 700;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      transition: transform 0.1s, box-shadow 0.1s;
      display: flex; align-items: center; justify-content: center; gap: 5px;
    }
    .button-row button:active {
      transform: scale(0.96);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    #btn-voice   { background: linear-gradient(135deg,#ff7675,#d63031); }
    #btn-refresh { background: linear-gradient(135deg,#00b894,#00cec9); }
    #btn-add     { background: linear-gradient(135deg,#a29bfe,#6c5ce7); }
    #btn-login   { background: linear-gradient(135deg,#0984e3,#74b9ff); }

    h1 {
      margin: 10px 0 5px;
      font-size: 1.7em;
      color: #1e272e;
      text-align: center;
      font-weight: 800;
      letter-spacing: -0.5px;
    }

    .voice-text {
      color: #e17055;
      font-weight: 600;
      min-height: 20px;
      margin: 5px 0 10px;
      font-size: 0.9em;
      text-align: center;
    }

    .input-group {
      display: flex;
      gap: 8px;
    }
    input[type="text"] {
      flex: 1;
      padding: 12px 15px;
      border: 1px solid #dfe6e9;
      border-radius: 10px;
      font-size: 15px;
      background: #f8f9fa;
      outline: none;
    }
    input[type="text"]:focus {
      border-color: #0984e3;
      background: #fff;
    }
    #btn-search {
      width: 80px;
      background: #636e72;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
    }

    #user-info  {
      text-align: right;
      font-size: 0.8em;
      color: #b2bec3;
      margin-top: 6px;
      min-height: 16px;
    }

    #status {
      text-align: center;
      margin: 20px 0 10px;
      color: #636e72;
      font-size: 0.95em;
      font-weight: 500;
      min-height: 24px;
      line-height: 1.5;
    }
    .spin-icon {
      display: inline-block;
      animation: spin 1.5s linear infinite;
      font-size: 1.1em;
      margin-right: 6px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    #bid-list { margin-top: 10px; }

    /* ì¹´ë“œ UI */
    .card {
      background: #fff;
      padding: 20px 22px 18px;
      margin-bottom: 14px;
      border-radius: 18px;
      border-left: 5px solid #dfe6e9;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
      width: 100%;
    }
    .card.urgent { border-left-color: #ff7675; }
    .card.normal { border-left-color: #0984e3; }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .card-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85em;
      color: #636e72;
    }
    .region-tag {
      padding: 3px 8px;
      border-radius: 999px;
      background: #e8f0fe;
      color: #1a73e8;
      font-weight: 700;
      font-size: 0.75em;
    }
    .bid-no {
      font-weight: 600;
      color: #636e72;
    }
    .status-chip {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75em;
      font-weight: 700;
      color: #e67e22;
      background: #ffeaa7;
    }

    .card-title {
      display: block;
      margin: 4px 0 10px;
      font-size: 1.15em;
      font-weight: 800;
      color: #2d3436;
      text-decoration: none;
      line-height: 1.5;
    }
    .card-title:hover { text-decoration: underline; }

    .card-main {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 8px;
    }
    .card-main-left, .card-main-right {
      flex: 1;
      min-width: 0;
    }
    .info-row {
      display: flex;
      gap: 6px;
      font-size: 0.85em;
      margin-bottom: 4px;
      color: #636e72;
    }
    .info-label {
      width: 55px;
      flex-shrink: 0;
      color: #95a5a6;
    }
    .info-value {
      flex: 1;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
    .info-value-strong {
      font-weight: 700;
      color: #2d3436;
    }

    .card-main-right {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 6px;
      align-content: flex-start;
      font-size: 0.8em;
    }
    .stat-pill {
      background: #f7f9fb;
      border-radius: 10px;
      padding: 6px 8px;
      border: 1px solid #ecf0f1;
    }
    .stat-label {
      font-size: 0.7em;
      color: #95a5a6;
      margin-bottom: 2px;
    }
    .stat-value {
      font-weight: 700;
      color: #2d3436;
      font-size: 0.9em;
    }
    .d-day-pill {
      background: #ffeaa7;
      border-color: #ffeaa7;
      color: #d35400;
    }

    .ai-analysis-box {
      display: none;
      background-color: #f3e5f5;
      padding: 12px;
      margin-top: 10px;
      border-radius: 10px;
      font-size: 0.85em;
      color: #4a148c;
      border: 1px solid #e1bee7;
      line-height: 1.6;
    }

    .card-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 8px;
      padding-top: 10px;
      border-top: 1px solid #f1f1f1;
    }
    .card-footer button,
    .card-footer a {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      font-size: 0.8em;
      cursor: pointer;
      font-weight: 700;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn-link { background: #dfe6e9; color: #2d3436; }
    .btn-cal  { background: #e3f2fd; color: #0984e3; }
    .btn-ai   { background: linear-gradient(135deg,#a29bfe,#6c5ce7); color: #fff; }

    /* ë¹ˆ ê²°ê³¼ í™”ë©´ */
    .empty-box {
      text-align: center;
      padding: 60px 20px 40px;
      color: #636e72;
    }
    .empty-box p { margin: 6px 0; }
    .empty-emoji {
      font-size: 3.4em;
      margin-bottom: 6px;
    }

    /* ëª¨ë‹¬ */
    #add-modal {
      display: none;
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.5);
      z-index:2000;
      justify-content:center;
      align-items:center;
    }
    .modal-content {
      background:#fff;
      padding:22px;
      border-radius:15px;
      width:90%;
      max-width:520px;
    }
    textarea {
      width:100%;
      height:180px;
      padding:10px;
      margin:10px 0;
      border-radius:8px;
      border:1px solid #ddd;
      font-size:14px;
      font-family: sans-serif;
      resize: none;
    }
    .modal-btns {
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }

    .calendar-area { margin-top: 20px; display:none; }
    iframe {
      width: 100%;
      height: 600px;
      border:none;
      border-radius:16px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.05);
    }

    @media (max-width: 768px) {
      .card-main {
        flex-direction: column;
      }
      .card-main-right {
        grid-template-columns: repeat(2, minmax(0,1fr));
      }
    }
    @media (max-width: 480px) {
      .card-main-right {
        grid-template-columns: minmax(0,1fr);
      }
    }
  </style>
</head>
<body>

<div class="control-box-bg">
  <div class="content-wrapper">
    <div class="button-row">
      <button id="btn-voice">ğŸ¤ ìŒì„±</button>
      <button id="btn-refresh">ğŸ”„ ê³µê³ ê²€ìƒ‰</button>
      <button id="btn-add">ğŸ“ ì§ì ‘ë“±ë¡</button>
      <button id="btn-login">ğŸ“… ë¡œê·¸ì¸</button>
    </div>

    <h1>ğŸ’§ í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬</h1>

    <div class="voice-text" id="voice-result"></div>

    <div class="input-group">
      <input type="text" id="search-input" placeholder="ì˜ˆ: ë‹¤ìŒ ì£¼ ë§ˆê°ë˜ëŠ” ì €ë¥˜ì¡° ê³µê³  ì°¾ì•„ì¤˜">
      <button id="btn-search">ê²€ìƒ‰</button>
    </div>
    <div id="user-info"></div>
  </div>
</div>

<div id="status"></div>
<div id="bid-list" class="content-wrapper"></div>

<div class="calendar-area content-wrapper" id="cal-area">
  <h3 style="text-align:center; color:#2c3e50;">ğŸ“… ì…ì°° ì¼ì •í‘œ</h3>
  <iframe id="cal-frame" src=""></iframe>
</div>

<!-- ì§ì ‘ë“±ë¡ ëª¨ë‹¬ -->
<div id="add-modal">
  <div class="modal-content">
    <h3 style="margin-top:0; color:#2c3e50;">ğŸ“ ì™¸ë¶€ ê³µê³  ìŠ¤ë§ˆíŠ¸ ë“±ë¡</h3>
    <p style="font-size:0.9em; color:#666; line-height:1.4;">
      ì™¸ë¶€ ì‚¬ì´íŠ¸ ê³µê³ ë¬¸ì„ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ìœ¼ë©´, AIê°€ ê³µê³ ë²ˆí˜¸Â·ë§ˆê°ì¼Â·ê¸ˆì•¡Â·ë©´ì Â·í†¤ìˆ˜ê¹Œì§€ ì¶”ì¶œí•˜ì—¬ ì‹œíŠ¸ì— ì €ì¥í•©ë‹ˆë‹¤.
    </p>
    <textarea id="paste-area" placeholder="[ì˜ˆì‹œ]&#13;&#10;ê³µê³ ëª…: ì„œìš¸ì‹œ ë¹—ë¬¼ì €ë¥˜ì¡° ì„¤ì¹˜ê³µì‚¬&#13;&#10;ê³µê³ ë²ˆí˜¸: R25BK00000000&#13;&#10;ì§€ì—­: ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬&#13;&#10;ê³µê³ ì¼: 2025ë…„ 11ì›” 20ì¼ 10:00&#13;&#10;ë§ˆê°ì¼: 2025ë…„ 12ì›” 1ì¼ 18:00&#13;&#10;ë°œì£¼ì²˜: ì„œìš¸íŠ¹ë³„ì‹œì²­&#13;&#10;ìˆ˜ìš”ê¸°ê´€: ì„œìš¸ì‹œ ë¬¼ìˆœí™˜ì •ì±…ê³¼&#13;&#10;ìš©ì—­ê¸°ê°„: ê³„ì•½ì¼ë¡œë¶€í„° 12ê°œì›”&#13;&#10;ìš©ì—­ê¸ˆì•¡: 3ì–µ 5ì²œë§Œì›&#13;&#10;ì´ì‚¬ì—…ë¹„: 5ì–µì›&#13;&#10;ëŒ€ì§€ë©´ì : 12,345ã¡&#13;&#10;ì €ë¥˜ì¡° ì˜ˆìƒìš©ëŸ‰: ì•½ 2,500í†¤&#13;&#10;ë‹´ë‹¹ì: í™ê¸¸ë™(02-1234-5678)&#13;&#10;ë§í¬: https://..."></textarea>
    <div class="modal-btns">
      <button onclick="closeModal()" style="background:#b2bec3; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">ì·¨ì†Œ</button>
      <button id="btn-smart-save" onclick="processSmartAdd()" style="background:#6c5ce7; color:white; font-weight:bold; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">âœ¨ AI ë¶„ì„ ë° ì €ì¥</button>
    </div>
  </div>
</div>

<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
  // ===== ì„¤ì •ê°’ =====
  const GEMINI_MODEL_ID = 'gemini-2.0-flash';

  // ğŸ‘‰ ê¸°ì¡´ì— ì‚¬ìš©í•˜ì‹œë˜ ê°’ìœ¼ë¡œ ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤.
  const BID_CALENDAR_ID  = 'd51a10e0014dcbd83e98d0da91cda4f52f629c19652c15fc693ee4529bbbab04@group.calendar.google.com';
  const SCRIPT_URL       = 'https://script.google.com/macros/s/AKfycbxi0Bfdty9LuMJyxCGTqTkyJQJrevz3AqRunbhNmePCh68tta-Fu8w1Lw4E_DROWB99zw/exec';
  const CLIENT_ID        = '1049915608396-i3jn8jrm24bc9mkagdtokk3rfa3li513.apps.googleusercontent.com';

  const SCOPES      = 'https://www.googleapis.com/auth/calendar.events';
  const STORAGE_KEY = 'hksuan_google_token_v2';

  let allData    = [];
  let tokenClient;
  let isLogin    = false;

  // ìº˜ë¦°ë” iframe ê¸°ë³¸ ì„¤ì •
  function setupCalendarView() {
    const iframe = document.getElementById('cal-frame');
    let calSrc = `https://calendar.google.com/calendar/embed?src=${encodeURIComponent(BID_CALENDAR_ID)}&ctz=Asia%2FSeoul&hl=ko`;
    if (BID_CALENDAR_ID === 'primary') {
      calSrc = 'https://calendar.google.com/calendar/embed?src=primary&ctz=Asia%2FSeoul&hl=ko';
    }
    iframe.src = calSrc;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ê³µí†µ Gemini í˜¸ì¶œ â€“ Apps Script í”„ë¡ì‹œ ì‚¬ìš©
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function callGemini(prompt) {
    const controller = new AbortController();
    const timeoutId  = setTimeout(() => controller.abort(), 20000);

    try {
      const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'gemini',
          model: GEMINI_MODEL_ID,
          prompt: prompt
        }),
        signal: controller.signal
      });

      const data = await response.json();

      if (data && data.error) {
        const msg = data.message || `Gemini í”„ë¡ì‹œ ì˜¤ë¥˜ (status=${data.status || 'unknown'})`;
        throw new Error(msg);
      }

      return data;
    } finally {
      clearTimeout(timeoutId);
    }
  }

  function extractGeminiText(data) {
    const parts = data?.candidates?.[0]?.content?.parts || [];
    let text    = parts.map(p => p.text || '').join('\n');
    text        = text.replace(/```json/g, '').replace(/```/g, '').trim();
    const jsonMatch = text.match(/\{[\s\S]*\}/);
    if (jsonMatch) text = jsonMatch[0];
    return text;
  }

  // ===== 1. ë°ì´í„° ë¡œë“œ =====
  async function loadData() {
    const statusEl = document.getElementById('status');
    statusEl.innerHTML = `<span class="spin-icon">â³</span> ì…ì°° ê³µê³ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...`;

    try {
      const res  = await fetch(SCRIPT_URL + '?t=' + Date.now());
      if (!res.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜: ' + res.status);

      const text = await res.text();
      if (!text.trim()) throw new Error('ì‘ë‹µì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
      if (text.trim().startsWith('<')) {
        throw new Error('JSON ëŒ€ì‹  HTMLì´ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤. ì›¹ì•± ë°°í¬ URL(SCRIPT_URL)ì„ í™•ì¸í•˜ì„¸ìš”.');
      }

      let json;
      try {
        json = JSON.parse(text);
      } catch (err) {
        throw new Error('JSON íŒŒì‹± ì‹¤íŒ¨: ' + err.message + '\nì‘ë‹µ ì¼ë¶€: ' + text.slice(0, 120) + '...');
      }

      const now = new Date();
      // ë§ˆê°ì¼ì´ ì§€ë‚œ ê³µê³ ëŠ” í”„ë¡ íŠ¸ì—ì„œ í•œ ë²ˆ ë” í•„í„°ë§
      allData = json.filter(item => {
        if (!item.deadline) return true;
        const iso = String(item.deadline).replace(' ', 'T');
        const d = new Date(iso);
        if (isNaN(d.getTime())) return true;
        return d >= now;
      });

      renderList(allData);
      statusEl.innerHTML = `âœ… ì´ <b>${allData.length}</b>ê±´ì˜ ê³µê³ ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`;
    } catch (e) {
      console.error('loadData ì˜¤ë¥˜', e);
      allData = [];
      renderList([]);
      document.getElementById('status').innerHTML =
        `<span style="color:red">âŒ ì˜¤ë¥˜: ${e.message}</span>`;
    }
  }

  // ===== 2. ì§ì ‘ë“±ë¡ ëª¨ë‹¬ =====
  document.getElementById('btn-add').onclick = () => {
    document.getElementById('add-modal').style.display = 'flex';
  };

  function closeModal() {
    document.getElementById('add-modal').style.display = 'none';
    document.getElementById('paste-area').value = '';
  }

  async function processSmartAdd() {
    const text = document.getElementById('paste-area').value;
    if (!text) {
      alert('ë‚´ìš©ì„ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”!');
      return;
    }

    const btn = document.getElementById('btn-smart-save');
    btn.innerText = 'ğŸ§  ë¶„ì„ ë° ì €ì¥ ì¤‘...';
    btn.disabled  = true;

    const prompt =
      'ë‹¤ìŒì€ í•œêµ­ì˜ ê³µê³µì…ì°° ê³µê³ ë¬¸ í…ìŠ¤íŠ¸ì…ë‹ˆë‹¤.\n' +
      'ì•„ë˜ í•­ëª©ì„ ìµœëŒ€í•œ ì •í™•íˆ ì¶”ì¶œí•´ì„œ JSON í•œ ì¤„ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”.\n\n' +
      'í•„ë“œ ì„¤ëª…:\n' +
      'no            : ê³µê³ ë²ˆí˜¸ (ë¬¸ìì—´, ì—†ìœ¼ë©´ "ì •ë³´ì—†ìŒ")\n' +
      'region        : ì§€ì—­ (ì˜ˆ: "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬" ë“±, ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)\n' +
      'title         : ê³µê³ ëª…\n' +
      'date          : ê³µê³ ì¼ (YYYY-MM-DD HH:mm í˜•íƒœ, ì‹œê°„ ì—†ìœ¼ë©´ "YYYY-MM-DD 00:00")\n' +
      'deadline      : ë§ˆê°ì¼ (YYYY-MM-DD HH:mm í˜•íƒœ, ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)\n' +
      'client        : ë°œì£¼ì²˜(ê³µê³ ê¸°ê´€)\n' +
      'agency        : ìˆ˜ìš”ê¸°ê´€ (êµ¬ë¶„ì´ ì•ˆ ë˜ë©´ ë°œì£¼ì²˜ì™€ ë™ì¼í•˜ê²Œ)\n' +
      'servicePeriod : ìš©ì—­ê¸°ê°„ (ì˜ˆ: "ê³„ì•½ì¼ë¡œë¶€í„° 12ê°œì›”")\n' +
      'serviceAmount : ìš©ì—­ê¸ˆì•¡ (ì˜ˆ: "350,000,000ì›" ë˜ëŠ” "3ì–µ 5ì²œë§Œì›" ë“± ì›ë¬¸ ê·¸ëŒ€ë¡œ ìš”ì•½)\n' +
      'projectBudget : ì´ì‚¬ì—…ë¹„/ì‚¬ì—…ë¹„ (ìˆìœ¼ë©´ ê¸°ì…, ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´)\n' +
      'clientManager : ë°œì£¼ì²˜ ë‹´ë‹¹ì ì´ë¦„ê³¼ ì—°ë½ì²˜ (ì˜ˆ: "í™ê¸¸ë™(02-1234-5678)")\n' +
      'siteArea      : ëŒ€ì§€ë©´ì  ë˜ëŠ” ì—°ë©´ì  (ã¡ ë‹¨ìœ„ ìˆ«ì ë˜ëŠ” ì˜ˆ: "12,345ã¡")\n' +
      'expectedTon   : ë¹—ë¬¼ì €ë¥˜ì¡° ì˜ˆìƒ ìš©ëŸ‰ ë˜ëŠ” ì˜ˆìƒí†¤ìˆ˜ (ì˜ˆ: "2,500í†¤" ë˜ëŠ” "ì•½ 2,500í†¤")\n' +
      'link          : ê³µê³ ë¬¸ URL (ì—†ìœ¼ë©´ "#")\n\n' +
      'ì¶œë ¥ í˜•ì‹ ì˜ˆì‹œ(í•œ ì¤„):\n' +
      '{"no":"R25BK00000000","region":"ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬","title":"ì„œìš¸ì‹œ ë¹—ë¬¼ì €ë¥˜ì¡° ì„¤ì¹˜ê³µì‚¬","date":"2025-11-20 10:00","deadline":"2025-12-01 18:00","client":"ì„œìš¸íŠ¹ë³„ì‹œì²­","agency":"ì„œìš¸ì‹œ ë¬¼ìˆœí™˜ì •ì±…ê³¼","servicePeriod":"ê³„ì•½ì¼ë¡œë¶€í„° 12ê°œì›”","serviceAmount":"350,000,000ì›","projectBudget":"500,000,000ì›","clientManager":"í™ê¸¸ë™(02-1234-5678)","siteArea":"12345ã¡","expectedTon":"2500í†¤","link":"https://..."}\n\n' +
      'ìœ„ í˜•ì‹ì„ ë°˜ë“œì‹œ ì§€í‚¤ê³ , ì„¤ëª… ë¬¸ì¥ ì—†ì´ JSON ê°ì²´ 1ê°œë§Œ ì¶œë ¥í•˜ì„¸ìš”.\n\n' +
      'ì…ë ¥ í…ìŠ¤íŠ¸:\n' + text;

    try {
      const aiData = await callGemini(prompt);
      const aiText = extractGeminiText(aiData);
      const result = JSON.parse(aiText);

      const saveUrl =
        `${SCRIPT_URL}?action=add` +
        `&no=${encodeURIComponent(result.no || 'ì •ë³´ì—†ìŒ')}` +
        `&region=${encodeURIComponent(result.region || '')}` +
        `&title=${encodeURIComponent(result.title || '')}` +
        `&date=${encodeURIComponent(result.date || '')}` +
        `&deadline=${encodeURIComponent(result.deadline || '')}` +
        `&client=${encodeURIComponent(result.client || '')}` +
        `&agency=${encodeURIComponent(result.agency || '')}` +
        `&servicePeriod=${encodeURIComponent(result.servicePeriod || '')}` +
        `&serviceAmount=${encodeURIComponent(result.serviceAmount || '')}` +
        `&projectBudget=${encodeURIComponent(result.projectBudget || '')}` +
        `&clientManager=${encodeURIComponent(result.clientManager || '')}` +
        `&siteArea=${encodeURIComponent(result.siteArea || '')}` +
        `&expectedTon=${encodeURIComponent(result.expectedTon || '')}` +
        `&link=${encodeURIComponent(result.link || '#')}`;

      await fetch(saveUrl, { mode: 'no-cors' });

      alert(`âœ… ì €ì¥ ìš”ì²­ ì™„ë£Œ!\n[${result.title}]`);
      closeModal();
      setTimeout(loadData, 2000);
    } catch (e) {
      console.error(e);
      alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
    } finally {
      btn.innerText = 'âœ¨ AI ë¶„ì„ ë° ì €ì¥';
      btn.disabled  = false;
    }
  }

  // ===== 3. ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ =====
  function renderList(data) {
    const list  = document.getElementById('bid-list');
    list.innerHTML = '';

    if (data.length === 0) {
      const html = `
        <div class="empty-box">
          <div class="empty-emoji">ğŸ¤”</div>
          <p><strong>ì¡°ê±´ì— ë§ëŠ” ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</strong></p>
        </div>`;
      list.innerHTML = html;
      return;
    }

    const now = new Date();

    data.forEach((item, index) => {
      const deadlineStr = item.deadline || '';
      const deadlineIso = deadlineStr.replace(' ', 'T');
      const end   = new Date(deadlineIso);
      let dDayLabel = 'ë§ˆê°ì¼ ë¯¸ì •';
      let cardClass = 'normal';

      if (!isNaN(end.getTime())) {
        const diff = Math.ceil((end - now) / (1000 * 60 * 60 * 24));
        if (diff < 0) {
          dDayLabel = 'ë§ˆê°ë¨';
        } else if (diff === 0) {
          dDayLabel = 'ì˜¤ëŠ˜ ë§ˆê°';
          cardClass = 'urgent';
        } else {
          dDayLabel = `D-${diff}`;
          if (diff <= 3) cardClass = 'urgent';
        }
      }

      const div = document.createElement('div');
      div.className = `card ${cardClass}`;
      div.innerHTML = `
        <div class="card-header">
          <div class="card-header-left">
            <span class="region-tag">#${item.region || 'ì§€ì—­ë¯¸ìƒ'}</span>
            <span class="bid-no">${item.no || '-'}</span>
          </div>
          <span class="status-chip">${dDayLabel}</span>
        </div>
        <a href="${item.link || '#'}" target="_blank" class="card-title">${item.title || '(ì œëª© ì—†ìŒ)'}</a>

        <div class="card-main">
          <div class="card-main-left">
            <div class="info-row">
              <span class="info-label">ìˆ˜ìš”ê¸°ê´€</span>
              <span class="info-value info-value-strong">${item.agency || '-'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">ë°œì£¼ì²˜</span>
              <span class="info-value">${item.client || '-'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">ë‹´ë‹¹ì</span>
              <span class="info-value">${item.clientManager || '-'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">ìš©ì—­ê¸°ê°„</span>
              <span class="info-value">${item.servicePeriod || '-'}</span>
            </div>
          </div>

          <div class="card-main-right">
            <div class="stat-pill d-day-pill">
              <div class="stat-label">ë§ˆê°ì¼</div>
              <div class="stat-value">${deadlineStr || '-'}</div>
            </div>
            <div class="stat-pill">
              <div class="stat-label">ê³µê³ ì¼</div>
              <div class="stat-value">${item.date || '-'}</div>
            </div>
            <div class="stat-pill">
              <div class="stat-label">ìš©ì—­ê¸ˆì•¡</div>
              <div class="stat-value">${item.serviceAmount || '-'}</div>
            </div>
            <div class="stat-pill">
              <div class="stat-label">ì‚¬ì—…ë¹„</div>
              <div class="stat-value">${item.projectBudget || '-'}</div>
            </div>
            <div class="stat-pill">
              <div class="stat-label">ëŒ€ì§€ë©´ì </div>
              <div class="stat-value">${item.siteArea || '-'}${item.siteArea ? 'ã¡' : ''}</div>
            </div>
            <div class="stat-pill">
              <div class="stat-label">ì˜ˆìƒí†¤ìˆ˜</div>
              <div class="stat-value">${item.expectedTon || '-'}${item.expectedTon ? 'í†¤' : ''}</div>
            </div>
          </div>
        </div>

        <div id="ai-result-${index}" class="ai-analysis-box"></div>

        <div class="card-footer">
          <button class="btn-ai" data-index="${index}">ğŸ¤– ìƒì„¸ AI ë¶„ì„</button>
          <a href="${item.link || '#'}" target="_blank" class="btn-link">ğŸ“„ ê³µê³ ë¬¸</a>
          <button class="btn-cal" data-index="${index}">ğŸ“… ìº˜ë¦°ë”</button>
        </div>
      `;
      list.appendChild(div);
    });

    document.querySelectorAll('.btn-ai').forEach(btn => {
      btn.onclick = () => {
        const i = parseInt(btn.dataset.index, 10);
        const item = allData[i];
        analyzeBidWithAI(item, i);
      };
    });
    document.querySelectorAll('.btn-cal').forEach(btn => {
      btn.onclick = () => {
        const i = parseInt(btn.dataset.index, 10);
        const item = allData[i];
        addToCal(item.title, item.deadline);
      };
    });
  }

  // ===== 4. ê²€ìƒ‰ =====
  function simpleSearch(keyword) {
    const q = keyword.toLowerCase();
    const filtered = allData.filter(item =>
      (item.title  || '').toLowerCase().includes(q) ||
      (item.agency || '').toLowerCase().includes(q) ||
      (item.region || '').toLowerCase().includes(q)
    );
    renderList(filtered);
    const status = document.getElementById('status');
    status.innerHTML = filtered.length > 0
      ? `ğŸ” "<b>${keyword}</b>" ê²€ìƒ‰ ê²°ê³¼: ${filtered.length}ê±´`
      : `ğŸ” "<b>${keyword}</b>" ë‚´ë¶€ DB ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ`;
  }

  async function searchWithAI(query) {
    if (!query) {
      renderList(allData);
      return;
    }
    const status = document.getElementById('status');

    const basicFilter = allData.filter(item =>
      (item.title  || '').includes(query) ||
      (item.agency || '').includes(query) ||
      (item.region || '').includes(query)
    );
    if (basicFilter.length > 0 && !query.match(/(ë‚´ì¼|ëª¨ë ˆ|ì£¼|ë‹¬|ì›”|ë§ˆê°|ì–¸ì œ)/)) {
      renderList(basicFilter);
      status.innerHTML = `ğŸ” "<b>${query}</b>" ê²€ìƒ‰ ê²°ê³¼: ${basicFilter.length}ê±´`;
      return;
    }

    status.innerHTML = `<span class="spin-icon">ğŸ§ </span> AIê°€ ê²€ìƒ‰ ì¡°ê±´ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...`;

    const today = new Date().toISOString().split('T')[0];
    const prompt =
      `Today is ${today}. Analyze this Korean query: "${query}"\n` +
      'Extract keyword (for title/agency/region) and date range for bid deadline.\n' +
      'Response format: {"keyword":"...","startDate":"YYYY-MM-DD","endDate":"YYYY-MM-DD"} ONLY.';

    try {
      const data   = await callGemini(prompt);
      const text   = extractGeminiText(data);
      const result = JSON.parse(text);

      const filtered = allData.filter(item => {
        let dateMatch    = true;
        let keywordMatch = true;

        if (result.startDate && result.endDate && item.deadline) {
          const itemDate = String(item.deadline).split(' ')[0];
          dateMatch = itemDate >= result.startDate && itemDate <= result.endDate;
        }
        if (result.keyword) {
          const k = result.keyword.toLowerCase();
          keywordMatch =
            (item.title  || '').toLowerCase().includes(k) ||
            (item.agency || '').toLowerCase().includes(k) ||
            (item.region || '').toLowerCase().includes(k);
        }
        return dateMatch && keywordMatch;
      });

      renderList(filtered);
      status.innerHTML = filtered.length > 0
        ? `ğŸ¤– AI ê²€ìƒ‰ ê²°ê³¼: <b>${filtered.length}</b>ê±´`
        : 'ğŸ¤– AI ë¶„ì„ ì™„ë£Œ: <b>ì¡°ê±´ì— ë§ëŠ” ê³µê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</b>';
    } catch (e) {
      console.error('AI ê²€ìƒ‰ ì˜¤ë¥˜:', e);
      simpleSearch(query);
    }
  }

  function doSearch(keyword) {
    if (!keyword) {
      renderList(allData);
      document.getElementById('status').innerHTML = `ì „ì²´ <b>${allData.length}</b>ê±´`;
      return;
    }
    if (keyword.match(/(ë‚´ì¼|ëª¨ë ˆ|ì£¼|ë‹¬|ì›”|ë§ˆê°|ì–¸ì œ)/)) {
      searchWithAI(keyword);
    } else {
      simpleSearch(keyword);
    }
  }

  // ===== 5. ê°œë³„ ê³µê³  ìƒì„¸ AI ë¶„ì„ =====
  async function analyzeBidWithAI(item, index) {
    const box = document.getElementById(`ai-result-${index}`);
    if (box.style.display === 'block') {
      box.style.display = 'none';
      return;
    }

    box.style.display = 'block';
    box.innerHTML     = `<span class="spin-icon">ğŸ§ </span> ë¶„ì„ ì¤‘...`;

    const prompt =
      "ë‚˜ëŠ” 'ë¹—ë¬¼ì €ë¥˜ì¡°' ë° ìš°ìˆ˜ì €ë¥˜ì‹œì„¤ ì „ë¬¸ ì‹œê³µì‚¬(í•œêµ­ìˆ˜ì•ˆ) ì§ì›ì´ë‹¤.\n" +
      'ë‹¤ìŒ ì…ì°° ê³µê³ ê°€ ìš°ë¦¬ íšŒì‚¬ì— ì–¼ë§ˆë‚˜ ì í•©í•œì§€ ê°„ë‹¨íˆ ë¶„ì„í•´ì¤˜.\n\n' +
      `ê³µê³ ë²ˆí˜¸: ${item.no}\n` +
      `ì§€ì—­: ${item.region}\n` +
      `ê³µê³ ëª…: ${item.title}\n` +
      `ê³µê³ ì¼: ${item.date}\n` +
      `ë§ˆê°ì¼: ${item.deadline}\n` +
      `ë°œì£¼ì²˜: ${item.client}\n` +
      `ìˆ˜ìš”ê¸°ê´€: ${item.agency}\n` +
      `ìš©ì—­ê¸°ê°„: ${item.servicePeriod}\n` +
      `ìš©ì—­ê¸ˆì•¡: ${item.serviceAmount}\n` +
      `ì‚¬ì—…ë¹„: ${item.projectBudget}\n` +
      `ëŒ€ì§€ë©´ì : ${item.siteArea}\n` +
      `ì˜ˆìƒí†¤ìˆ˜: ${item.expectedTon}\n\n` +
      '1) ê³µì‚¬ì˜ ì£¼ìš” ë‚´ìš©ê³¼ ìŠ¤ì¼€ì¼ ìš”ì•½\n' +
      '2) ë¹—ë¬¼ì €ë¥˜ì¡°Â·ìš°ìˆ˜ì €ë¥˜ì‹œì„¤Â·ì¹¨ìˆ˜ë°©ì§€ ì‚¬ì—…ê³¼ì˜ ê´€ë ¨ì„± ë° ìš°ë¦¬ íšŒì‚¬ ì í•©ë„ (ë†’ìŒ/ì¤‘ê°„/ë‚®ìŒ + ì´ìœ )\n' +
      '3) ì…ì°° ì°¸ì—¬ ì‹œ ê¸°ìˆ Â·ê°€ê²©Â·ê²½ìŸêµ¬ë„ ê´€ì  ì²´í¬í¬ì¸íŠ¸ 3~5ê°œ\n' +
      '4) ì¶”ê°€ë¡œ ë°œì£¼ì²˜/ì„¤ê³„ìì—ê²Œ í™•ì¸í•´ì•¼ í•  ì§ˆë¬¸ 3ê°œ ì •ë„ ì œì•ˆ\n' +
      'ìˆœìˆ˜ ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸ë¡œë§Œ ë‹µë³€í•´ì¤˜.';

    try {
      const data = await callGemini(prompt);
      const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || 'ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
      box.innerHTML = marked.parse(text);
    } catch (e) {
      console.error(e);
      box.innerHTML = 'âŒ ë¶„ì„ ì‹¤íŒ¨: ' + (e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
    }
  }

  // ===== 6. êµ¬ê¸€ ìº˜ë¦°ë” ì—°ë™ =====
  function initGoogle() {
    gapi.load('client', async () => {
      await gapi.client.init({
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest']
      });
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
          if (resp.error) return;
          gapi.client.setToken(resp);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(resp));
          updateLoginState(true);
        }
      });

      const savedToken = localStorage.getItem(STORAGE_KEY);
      if (savedToken) {
        try {
          gapi.client.setToken(JSON.parse(savedToken));
          updateLoginState(true);
        } catch (e) {
          handleLogout();
        }
      }

      document.getElementById('btn-login').onclick = () => {
        if (isLogin) {
          if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) handleLogout();
        } else {
          tokenClient.requestAccessToken({ prompt: '' });
        }
      };
    });
  }

  function updateLoginState(loggedIn) {
    const btn      = document.getElementById('btn-login');
    const userInfo = document.getElementById('user-info');
    const calArea  = document.getElementById('cal-area');
    isLogin        = loggedIn;

    if (loggedIn) {
      btn.innerText         = 'ğŸšª ë¡œê·¸ì•„ì›ƒ';
      btn.style.background  = 'linear-gradient(135deg,#636e72,#2d3436)';
      userInfo.innerText    = 'âœ… êµ¬ê¸€ ê³„ì • ì—°ë™ë¨';
      calArea.style.display = 'block';
      document.getElementById('cal-frame').src += '';
    } else {
      btn.innerText         = 'ğŸ“… ë¡œê·¸ì¸';
      btn.style.background  = 'linear-gradient(135deg,#0984e3,#74b9ff)';
      userInfo.innerText    = '';
      calArea.style.display = 'none';
    }
  }

  function handleLogout() {
    const token = gapi.client.getToken();
    if (token !== null) {
      google.accounts.oauth2.revoke(token.access_token);
    }
    gapi.client.setToken(null);
    localStorage.removeItem(STORAGE_KEY);
    updateLoginState(false);
  }

  async function addToCal(title, deadline) {
    if (!gapi.client.getToken()) {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      handleLogout();
      return;
    }
    if (!confirm(`[${title}] ì¼ì •ì„ ìº˜ë¦°ë”ì— ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

    const endIso = String(deadline || '').replace(' ', 'T') || new Date().toISOString();
    const end   = new Date(endIso);
    const start = new Date(end);
    start.setHours(end.getHours() - 1);

    const event = {
      summary    : `[ì…ì°°] ${title}`,
      description: 'í•œêµ­ìˆ˜ì•ˆ ì…ì°°ë¹„ì„œ ìë™ë“±ë¡',
      start      : { dateTime: start.toISOString() },
      end        : { dateTime: end.toISOString() },
      colorId    : '11',
      reminders  : {
        useDefault: false,
        overrides: [
          { method: 'popup', minutes: 60 },
          { method: 'popup', minutes: 24 * 60 }
        ]
      }
    };

    try {
      await gapi.client.calendar.events.insert({
        calendarId: BID_CALENDAR_ID,
        resource  : event
      });
      alert('âœ… ì¼ì • ë“±ë¡ ì™„ë£Œ!');
      document.getElementById('cal-frame').src += '';
    } catch (e) {
      alert('ë“±ë¡ ì‹¤íŒ¨: ' + (e.result?.error?.message || e.message));
      if (e.result?.error?.code === 401) handleLogout();
    }
  }

  // ===== 7. UI ì´ë²¤íŠ¸ =====
  document.getElementById('btn-voice').onclick = () => {
    if (!('webkitSpeechRecognition' in window)) {
      alert('í¬ë¡¬ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
      return;
    }
    const rec = new webkitSpeechRecognition();
    rec.lang  = 'ko-KR';
    rec.start();
    document.getElementById('voice-result').innerText = 'ë“£ê³  ìˆìŠµë‹ˆë‹¤... ğŸ‘‚';
    rec.onresult = (e) => {
      const txt = e.results[0][0].transcript;
      document.getElementById('voice-result').innerText = `ğŸ—£ï¸ "${txt}"`;
      document.getElementById('search-input').value     = txt;
      doSearch(txt);
    };
  };

  document.getElementById('btn-search').onclick  = () =>
    doSearch(document.getElementById('search-input').value);
  document.getElementById('btn-refresh').onclick = loadData;

  // ===== 8. ì´ˆê¸° ì‹¤í–‰ =====
  setupCalendarView();
  loadData();
  initGoogle();
</script>
</body>
</html>
