<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬</title>
    <style>
        /* 1. ê¸°ë³¸ ì„¤ì • */
        * { box-sizing: border-box; }
        body { 
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif; 
            background-color: #f2f4f6; 
            margin: 0; padding: 0; color: #333; 
        }
        
        .content-wrapper {
            max-width: 1200px; 
            width: 96%;        
            margin: 0 auto;    
        }

        /* 2. ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë°•ìŠ¤ */
        .control-box-bg { 
            background: white; 
            position: sticky; top: 0; z-index: 1000; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
            padding: 15px 0; 
        }

        /* 3. ë²„íŠ¼ 3ê°œ í•œ ì¤„ ì •ë ¬ */
        .button-row {
            display: flex; gap: 10px; width: 100%;
            margin-bottom: 15px; 
        }
        .button-row button {
            flex: 1; padding: 12px 0; border: none; border-radius: 12px; 
            font-size: 0.95em; font-weight: bold; color: white; cursor: pointer;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            transition: transform 0.1s, opacity 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .button-row button:active { transform: scale(0.96); }
        
        #btn-voice { background: linear-gradient(135deg, #ff7675, #d63031); } 
        #btn-refresh { background: linear-gradient(135deg, #00b894, #00cec9); }
        #btn-login { background: linear-gradient(135deg, #0984e3, #74b9ff); } 

        /* ì œëª© ìŠ¤íƒ€ì¼ */
        h1 { 
            margin: 15px 0; 
            font-size: 1.6em; color: #1e272e; 
            text-align: center; font-weight: 800; letter-spacing: -0.5px;
        }
        
        /* 4. ê²€ìƒ‰ì°½ ë””ìì¸ */
        .input-group { display: flex; gap: 8px; }
        input[type="text"] { 
            flex: 1; padding: 12px 15px; border: 1px solid #dfe6e9; 
            border-radius: 10px; font-size: 16px; background: #f8f9fa; outline: none;
        }
        input[type="text"]:focus { border-color: #0984e3; background: white; }
        #btn-search {
            width: 80px; background: #636e72; color: white; border: none;
            border-radius: 10px; font-weight: bold; cursor: pointer;
        }

        .voice-text { color: #e17055; font-weight: bold; min-height: 20px; margin: 5px 0; font-size: 0.9em; text-align: center;}
        #user-info { text-align: right; font-size: 0.8em; color: #b2bec3; margin-top: 5px; height: 15px;}
        #status { text-align: center; margin-top: 30px; color: #636e72; font-size: 1em; font-weight: 500; }
        
        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .loading-icon { display: inline-block; animation: spin 1.2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* 5. ë¦¬ìŠ¤íŠ¸ ì˜ì—­ */
        #bid-list { margin-top: 20px; }
        
        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { 
            background: white; padding: 25px; margin-bottom: 15px; 
            border-radius: 16px; border-left: 6px solid #ddd; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.03); 
            transition: transform 0.2s; width: 100%;
        }
        .card:hover { transform: translateY(-3px); }
        .card.urgent { border-left-color: #ff7675; }
        .card.normal { border-left-color: #0984e3; }
        
        .card-header { display: flex; justify-content: space-between; font-size: 0.9em; color: #888; margin-bottom: 10px; font-weight: 600;}
        .card-title { font-size: 1.3em; font-weight: bold; color: #2d3436; text-decoration: none; display: block; margin-bottom: 12px; line-height: 1.4; }
        .d-day { background: #ffeaa7; color: #d35400; padding: 3px 10px; border-radius: 20px; font-size: 0.85em; }
        .card-info { font-size: 1em; color: #636e72; line-height: 1.6; }
        .card-footer { display: flex; justify-content: flex-end; gap: 8px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #f1f1f1; }
        .card-footer button, .card-footer a { 
            padding: 10px 20px; border-radius: 8px; border:none; 
            font-size:0.9em; cursor:pointer; font-weight:bold; text-decoration: none; display: inline-block;
        }
        .btn-link { background: #dfe6e9; color: #2d3436; }
        .btn-cal { background: #e3f2fd; color: #0984e3; }
        
        /* ìº˜ë¦°ë” ì˜ì—­ */
        .calendar-area { margin-top: 20px; display:none; }
        iframe { width: 100%; height: 600px; border:none; border-radius:16px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

    <div class="control-box-bg">
        <div class="content-wrapper">
            
            <div class="button-row">
                <button id="btn-voice">ğŸ¤ ìŒì„±</button>
                <button id="btn-refresh">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                <button id="btn-login">ğŸ“… ë¡œê·¸ì¸</button>
            </div>

            <h1>ğŸ’§ í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬</h1>

            <div class="voice-text" id="voice-result"></div>

            <div class="input-group">
                <input type="text" id="search-input" placeholder="ê²€ìƒ‰ì–´ (ì˜ˆ: LH, ë¶€ì²œ, ì €ë¥˜ì¡°)">
                <button id="btn-search">ê²€ìƒ‰</button>
            </div>
            <div id="user-info"></div>
        </div>
    </div>

    <div id="status">
        <span class="loading-icon">â³</span> ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...
    </div>
    
    <div id="bid-list" class="content-wrapper"></div>
    
    <div class="calendar-area content-wrapper" id="cal-area">
        <h3 style="text-align:center; color:#2c3e50;">ğŸ“… ì…ì°° ì¼ì •í‘œ</h3>
        <iframe id="cal-frame" src=""></iframe>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        // ============================================================
        // ğŸ”´ [ìˆ˜ì • í•„ìš”] ì•„ë˜ ë”°ì˜´í‘œ ì•ˆì— 'ìƒˆë¡œ ë§Œë“  ìº˜ë¦°ë” ID'ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
        // ì˜ˆ: const BID_CALENDAR_ID = 'c_a1b2c3d4...group.calendar.google.com';
        const BID_CALENDAR_ID = 'd51a10e0014dcbd83e98d0da91cda4f52f629c19652c15fc693ee4529bbbab04@group.calendar.google.com'; 
        // ============================================================

        // ğŸš¨ Apps Script ì£¼ì†Œ
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxi0Bfdty9LuMJyxCGTqTkyJQJrevz3AqRunbhNmePCh68tta-Fu8w1Lw4E_DROWB99zw/exec'; 

        // êµ¬ê¸€ ë¡œê·¸ì¸ ì„¤ì •
        const CLIENT_ID = '1049915608396-i3jn8jrm24bc9mkagdtokk3rfa3li513.apps.googleusercontent.com'; 
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events';
        const STORAGE_KEY = 'hksuan_google_token_v2'; 
        
        let allData = [];
        let tokenClient;
        let isLogin = false;

        // 0. ìº˜ë¦°ë” Iframe ì„¤ì • (ìë™ ì‹¤í–‰)
        function setupCalendarView() {
            const iframe = document.getElementById('cal-frame');
            // ì…ì°° ìº˜ë¦°ë” IDê°€ 'primary'(ê¸°ë³¸)ê°€ ì•„ë‹ˆë©´ í•´ë‹¹ IDë¥¼ ë³´ì—¬ì£¼ë„ë¡ ì£¼ì†Œ ì„¤ì •
            let calSrc = `https://calendar.google.com/calendar/embed?src=${BID_CALENDAR_ID}&ctz=Asia%2FSeoul&hl=ko`;
            
            // ë§Œì•½ IDë¥¼ ì•„ì§ ì•ˆ ë°”ê¿¨ìœ¼ë©´ ê¸°ë³¸ ìº˜ë¦°ë” ë³´ì—¬ì¤Œ
            if (BID_CALENDAR_ID === 'primary') {
                // êµ¬ê¸€ ìº˜ë¦°ë” ê¸°ë³¸ ì„ë² ë“œ URL (ê°œì¸ ìº˜ë¦°ë”)
                calSrc = "https://calendar.google.com/calendar/embed?src=primary&ctz=Asia%2FSeoul&hl=ko";
            }
            iframe.src = calSrc;
        }

        // 1. ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
        async function loadData() {
            const status = document.getElementById('status');
            status.innerHTML = `<span class="loading-icon">â³</span> ì…ì°° ê³µê³ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...`;
            try {
                const res = await fetch(SCRIPT_URL);
                const json = await res.json();
                allData = json;
                renderList(allData);
                status.innerHTML = `âœ… ì´ <b>${allData.length}</b>ê±´ì˜ ê³µê³ ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`;
            } catch (e) {
                status.innerHTML = "âŒ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
                console.error(e);
            }
        }

        function renderList(data) {
            const list = document.getElementById('bid-list');
            list.innerHTML = "";
            if(data.length === 0) {
                list.innerHTML = "<p style='text-align:center; padding:30px; color:#999;'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
                return;
            }
            data.forEach(item => {
                const today = new Date();
                const end = new Date(item.deadline);
                const diff = Math.ceil((end - today) / (1000*60*60*24));
                let dDay = diff < 0 ? "ë§ˆê°ë¨" : `D-${diff}`;
                if (diff === 0) dDay = "ì˜¤ëŠ˜ë§ˆê°";
                const cardClass = diff <= 3 ? "urgent" : "normal";

                const div = document.createElement('div');
                div.className = `card ${cardClass}`;
                div.innerHTML = `
                    <div class="card-header">
                        <span>ğŸ¢ ${item.agency}</span>
                        <span class="d-day">${dDay}</span>
                    </div>
                    <a href="${item.link}" target="_blank" class="card-title">${item.title}</a>
                    <div class="card-info">
                        ë§ˆê°: <span style="color:#d63031; font-weight:bold">${item.deadline}</span> <br>
                        ìƒíƒœ: ${item.status}
                    </div>
                    <div class="card-footer">
                        <a href="${item.link}" target="_blank" class="btn-link">ğŸ“„ ê³µê³ ë¬¸</a>
                        <button onclick="addToCal('${item.title}', '${item.deadline}')" class="btn-cal">ğŸ“… ìº˜ë¦°ë” ë‹´ê¸°</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function doSearch(keyword) {
            if(!keyword) { renderList(allData); return; }
            const filtered = allData.filter(item => item.title.includes(keyword) || item.agency.includes(keyword));
            renderList(filtered);
            document.getElementById('status').innerHTML = `ğŸ” "<b>${keyword}</b>" ê²€ìƒ‰ ê²°ê³¼: ${filtered.length}ê±´`;
        }

        // 2. êµ¬ê¸€ ë¡œê·¸ì¸ ì´ˆê¸°í™”
        function initGoogle() {
            gapi.load('client', async () => {
                await gapi.client.init({ discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"] });
                
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID, scope: SCOPES,
                    callback: (resp) => {
                        if (resp.error) return;
                        gapi.client.setToken(resp);
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(resp));
                        updateLoginState(true);
                    }
                });

                const savedToken = localStorage.getItem(STORAGE_KEY);
                if (savedToken) {
                    try { gapi.client.setToken(JSON.parse(savedToken)); updateLoginState(true); } catch (e) { handleLogout(); }
                }
                document.getElementById('btn-login').onclick = () => {
                    if (isLogin) { if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) handleLogout(); } 
                    else { tokenClient.requestAccessToken({prompt: ''}); }
                };
            });
        }

        function updateLoginState(loggedIn) {
            const btn = document.getElementById('btn-login');
            const calArea = document.getElementById('cal-area');
            const userInfo = document.getElementById('user-info');
            isLogin = loggedIn;
            if (loggedIn) {
                btn.innerText = "ğŸšª ë¡œê·¸ì•„ì›ƒ";
                btn.style.background = "linear-gradient(135deg, #636e72, #2d3436)";
                calArea.style.display = 'block';
                userInfo.innerText = "âœ… êµ¬ê¸€ ê³„ì • ì—°ë™ë¨";
                // ë¡œê·¸ì¸ ë˜ë©´ ìº˜ë¦°ë” ë‹¤ì‹œ ë¡œë“œ (í˜¹ì‹œ ë¹„ê³µê°œ ìº˜ë¦°ë”ì¼ ê²½ìš°ë¥¼ ëŒ€ë¹„)
                document.getElementById('cal-frame').src += ''; 
            } else {
                btn.innerText = "ğŸ“… ë¡œê·¸ì¸";
                btn.style.background = "linear-gradient(135deg, #0984e3, #74b9ff)";
                calArea.style.display = 'none';
                userInfo.innerText = "";
            }
        }

        function handleLogout() {
            const token = gapi.client.getToken();
            if (token !== null) google.accounts.oauth2.revoke(token.access_token);
            gapi.client.setToken(null);
            localStorage.removeItem(STORAGE_KEY);
            updateLoginState(false);
        }

        // 3. ìº˜ë¦°ë” ë‹´ê¸° (ìˆ˜ì •ë¨: ì§€ì •ëœ ìº˜ë¦°ë” IDë¡œ ì €ì¥)
        async function addToCal(title, deadline) {
            if (!gapi.client.getToken()) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); handleLogout(); return; }
            if (!confirm(`[${title}] ì¼ì •ì„ ìº˜ë¦°ë”ì— ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            const end = new Date(deadline);
            const start = new Date(end);
            start.setHours(end.getHours() - 1); 
            
            const event = {
                'summary': `[ì…ì°°] ${title}`, 'description': 'í•œêµ­ìˆ˜ì•ˆ ì…ì°°ë¹„ì„œ ìë™ë“±ë¡',
                'start': { 'dateTime': start.toISOString() }, 'end': { 'dateTime': end.toISOString() },
                'colorId': '11', 
                'reminders': { 'useDefault': false, 'overrides': [ {'method': 'popup', 'minutes': 60}, {'method': 'popup', 'minutes': 24 * 60} ] }
            };
            
            try {
                // ğŸ”¥ ì—¬ê¸°ì„œ BID_CALENDAR_IDë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤!
                await gapi.client.calendar.events.insert({ 'calendarId': BID_CALENDAR_ID, 'resource': event });
                alert("âœ… ì¼ì • ë“±ë¡ ì™„ë£Œ! (ë§ˆê° 1ì¼ì „, 1ì‹œê°„ì „ ì•Œë¦¼)");
                // ìº˜ë¦°ë” iframe ìƒˆë¡œê³ ì¹¨í•´ì„œ ë“±ë¡ëœ ê²ƒ ë°”ë¡œ ë³´ì—¬ì£¼ê¸°
                document.getElementById('cal-frame').src += ''; 
            } catch (e) {
                alert("ë“±ë¡ ì‹¤íŒ¨: " + e.result.error.message + "\n(ìº˜ë¦°ë” ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”)");
                if (e.result.error.code === 401) handleLogout();
            }
        }

        document.getElementById('btn-voice').onclick = () => {
            if (!('webkitSpeechRecognition' in window)) { alert("í¬ë¡¬ ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”."); return; }
            const rec = new webkitSpeechRecognition();
            rec.lang = 'ko-KR'; rec.start();
            document.getElementById('voice-result').innerText = "ë“£ê³  ìˆìŠµë‹ˆë‹¤... ğŸ‘‚";
            rec.onresult = (e) => {
                const txt = e.results[0][0].transcript;
                document.getElementById('voice-result').innerText = `ğŸ—£ï¸ "${txt}"`;
                document.getElementById('search-input').value = txt;
                doSearch(txt);
            };
        };
        document.getElementById('btn-search').onclick = () => doSearch(document.getElementById('search-input').value);
        document.getElementById('btn-refresh').onclick = loadData;

        setupCalendarView(); // ìº˜ë¦°ë” ë·° ì„¤ì •
        loadData();
        initGoogle();
    </script>
</body>
</html>
