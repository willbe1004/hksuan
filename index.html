<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ìˆ˜ì•ˆ ì…ì°°ë¹„ì„œ</title>
    <style>
        /* ë””ìì¸ ê¾¸ë¯¸ê¸° */
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #f4f7f6; padding: 20px; max-width: 700px; margin: 0 auto; color: #333; }
        h1 { text-align: center; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        
        .control-box { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { opacity: 0.8; }
        
        #btn-voice { background: #e74c3c; color: white; } /* ë¹¨ê°• */
        #btn-refresh { background: #2ecc71; color: white; } /* ì´ˆë¡ */
        #btn-login { background: #3498db; color: white; } /* íŒŒë‘ */
        
        .input-group { margin-top: 10px; display: flex; gap: 5px; }
        input[type="text"] { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        
        /* ê³µê³  ì¹´ë“œ ë””ìì¸ */
        .card { background: white; padding: 15px; margin-top: 15px; border-radius: 8px; border-left: 5px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card.urgent { border-left-color: #e74c3c; } /* ê¸´ê¸‰ */
        .card.normal { border-left-color: #3498db; } /* ì¼ë°˜ */
        
        .card-header { display: flex; justify-content: space-between; font-size: 0.9em; color: #777; margin-bottom: 5px; }
        .card-title { font-size: 1.1em; font-weight: bold; color: #333; cursor: pointer; text-decoration: none; display: block; margin-bottom: 5px;}
        .card-title:hover { color: #2980b9; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        
        .d-day { font-weight: bold; color: #e74c3c; }
        .voice-text { color: #e67e22; font-weight: bold; min-height: 20px; margin: 10px 0; }
        
        /* ë¡œë”© ë©”ì‹œì§€ */
        #status { text-align: center; margin-top: 10px; color: #666; }

        /* ğŸ”¥ ì¶”ê°€ëœ ë¶€ë¶„: ì•„ì´ì½˜ íšŒì „ ì• ë‹ˆë©”ì´ì…˜ */
        .loading-icon {
            display: inline-block; /* í…ìŠ¤íŠ¸ì™€ ê°™ì€ ì¤„ì— ìˆê²Œ */
            animation: spin 1.5s linear infinite; /* 1.5ì´ˆ ë™ì•ˆ ì„ í˜•ìœ¼ë¡œ ë¬´í•œ íšŒì „ */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ìº˜ë¦°ë” ìˆ¨ê¹€ */
        .calendar-area { margin-top: 20px; display: none; }
        iframe { width: 100%; height: 400px; border: none; border-radius: 10px; }
    </style>
</head>
<body>

    <h1>ğŸ’§ í•œêµ­ìˆ˜ì•ˆ ì…ì°°ë¹„ì„œ</h1>

    <div class="control-box">
        <div id="user-info" style="font-size:0.8em; margin-bottom:5px; color:#888;"></div>
        <div>
            <button id="btn-voice">ğŸ¤ ìŒì„± ê²€ìƒ‰</button>
            <button id="btn-refresh">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            <button id="btn-login">ğŸ“… êµ¬ê¸€ ë¡œê·¸ì¸</button>
        </div>
        <div class="voice-text" id="voice-result"></div>
        <div class="input-group">
            <input type="text" id="search-input" placeholder="ì˜ˆ: ë¶€ì²œì‹œ ê³µê³ , ë§ˆê°ì¼ ì–¸ì œì•¼?">
            <button id="btn-search" style="background:#34495e; color:white;">ê²€ìƒ‰</button>
        </div>
    </div>

    <div id="status">
        <span class="loading-icon">â³</span> ì…ì°° ê³µê³ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
    </div>
    <div id="bid-list"></div>

    <div class="calendar-area" id="cal-area">
        <h3>ğŸ“… ì¼ì • í™•ì¸</h3>
        <iframe src="https://calendar.google.com/calendar/embed?src=cce03f167bf28bafd3795833209784265eadca0ed8138cae7d9024470ad36c66%40group.calendar.google.com&ctz=Asia%2FSeoul"></iframe>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxi0Bfdty9LuMJyxCGTqTkyJQJrevz3AqRunbhNmePCh68tta-Fu8w1Lw4E_DROWB99zw/exec'; 

        const CLIENT_ID = '1049915608396-i3jn8jrm24bc9mkagdtokk3rfa3li513.apps.googleusercontent.com'; 
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events';
        
        let allData = [];
        let tokenClient;

        // 1. ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function loadData() {
            const status = document.getElementById('status');
            const list = document.getElementById('bid-list');
            
            // ğŸ”¥ ìˆ˜ì •ëœ ë¶€ë¶„: ì•„ì´ì½˜ì— loading-icon í´ë˜ìŠ¤ë¥¼ ì¶”ê°€/ì œê±°
            status.innerHTML = `<span class="loading-icon">â³</span> ì…ì°° ê³µê³ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...`;
            status.querySelector('.loading-icon').classList.add('loading-icon'); // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘

            try {
                const res = await fetch(SCRIPT_URL);
                const json = await res.json();
                allData = json;
                renderList(allData);
                status.innerHTML = `âœ… ì´ ${allData.length}ê±´ì˜ ê³µê³ ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`;
            } catch (e) {
                status.innerHTML = "âŒ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>ìŠ¤í¬ë¦½íŠ¸ ì£¼ì†Œë¥¼ í™•ì¸í•˜ê±°ë‚˜, ì—‘ì…€ì— 'ë°°í¬'ê°€ ì˜ ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.";
                console.error(e);
            } finally {
                // ğŸ”¥ ìˆ˜ì •ëœ ë¶€ë¶„: ë¡œë”©ì´ ëë‚˜ë©´ ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ ì œê±°
                const loadingIcon = status.querySelector('.loading-icon');
                if (loadingIcon) {
                    loadingIcon.classList.remove('loading-icon'); // ì• ë‹ˆë©”ì´ì…˜ ì •ì§€
                }
            }
        }

        // 2. í™”ë©´ì— ë¿Œë¦¬ê¸°
        function renderList(data) {
            const list = document.getElementById('bid-list');
            list.innerHTML = "";
            
            if(data.length === 0) {
                list.innerHTML = "<p style='text-align:center'>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
                return;
            }

            data.forEach(item => {
                const today = new Date();
                const end = new Date(item.deadline);
                const diff = Math.ceil((end - today) / (1000*60*60*24));
                let dDay = diff < 0 ? "ë§ˆê°ë¨" : `D-${diff}`;
                if (diff === 0) dDay = "ì˜¤ëŠ˜ë§ˆê°";
                
                const cardClass = diff <= 3 ? "urgent" : "normal";

                const div = document.createElement('div');
                div.className = `card ${cardClass}`;
                div.innerHTML = `
                    <div class="card-header">
                        <span>ğŸ¢ ${item.agency}</span>
                        <span class="d-day">${dDay}</span>
                    </div>
                    <a href="${item.link}" target="_blank" class="card-title">${item.title}</a>
                    <div style="font-size:0.9em; color:#555;">
                        ë§ˆê°: ${item.deadline} <br>
                        ìƒíƒœ: ${item.status}
                    </div>
                    <div class="card-footer">
                        <button onclick="window.open('${item.link}')" style="background:#eee; color:#333; font-size:0.8em;">ğŸ“„ ê³µê³ ë¬¸</button>
                        <button onclick="addToCal('${item.title}', '${item.deadline}')" style="background:#e8f0fe; color:#1a73e8; font-size:0.8em;">ğŸ“… ìº˜ë¦°ë” ë‹´ê¸°</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // 3. ê²€ìƒ‰ ê¸°ëŠ¥
        function doSearch(keyword) {
            if(!keyword) { renderList(allData); return; }
            const filtered = allData.filter(item => item.title.includes(keyword) || item.agency.includes(keyword));
            renderList(filtered);
            document.getElementById('status').innerText = `ğŸ” "${keyword}" ê²€ìƒ‰ ê²°ê³¼: ${filtered.length}ê±´`;
        }

        // 4. ìŒì„± ì¸ì‹
        document.getElementById('btn-voice').onclick = () => {
            if (!('webkitSpeechRecognition' in window)) { alert("í¬ë¡¬ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ë©ë‹ˆë‹¤!"); return; }
            const rec = new webkitSpeechRecognition();
            rec.lang = 'ko-KR';
            rec.start();
            document.getElementById('voice-result').innerText = "ë“£ê³  ìˆìŠµë‹ˆë‹¤... ğŸ‘‚";
            
            rec.onresult = (e) => {
                const txt = e.results[0][0].transcript;
                document.getElementById('voice-result').innerText = `ğŸ—£ï¸ "${txt}"`;
                document.getElementById('search-input').value = txt;
                doSearch(txt);
            };
        };

        document.getElementById('btn-search').onclick = () => doSearch(document.getElementById('search-input').value);
        document.getElementById('btn-refresh').onclick = loadData;

        // 5. êµ¬ê¸€ ìº˜ë¦°ë” ì—°ë™ (ë¡œê·¸ì¸ & ì¼ì •ì¶”ê°€)
        function initGoogle() {
            gapi.load('client', async () => {
                await gapi.client.init({ discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"] });
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID, scope: SCOPES, callback: ''
                });
                document.getElementById('btn-login').onclick = () => {
                    tokenClient.callback = (resp) => {
                        if (resp.error) throw resp;
                        document.getElementById('btn-login').innerText = "âœ… ë¡œê·¸ì¸ë¨";
                        document.getElementById('cal-area').style.display = 'block';
                    };
                    tokenClient.requestAccessToken({prompt: 'consent'});
                };
            });
        }

        async function addToCal(title, deadline) {
            if (!gapi.client.getToken()) { alert("ìƒë‹¨ì˜ [êµ¬ê¸€ ë¡œê·¸ì¸] ë²„íŠ¼ì„ ë¨¼ì € ëˆŒëŸ¬ì£¼ì„¸ìš”!"); return; }
            if (!confirm(`[${title}] ì¼ì •ì„ ìº˜ë¦°ë”ì— ë„£ì„ê¹Œìš”?`)) return;

            const end = new Date(deadline);
            const start = new Date(end);
            start.setHours(end.getHours() - 1); // 1ì‹œê°„ ì „ë¶€í„°

            const event = {
                'summary': `[ì…ì°°] ${title}`,
                'description': 'í•œêµ­ìˆ˜ì•ˆ ì…ì°°ë¹„ì„œ ìë™ë“±ë¡',
                'start': { 'dateTime': start.toISOString() },
                'end': { 'dateTime': end.toISOString() },
                'colorId': '11' // ë¹¨ê°•
            };

            try {
                await gapi.client.calendar.events.insert({ 'calendarId': 'primary', 'resource': event });
                alert("âœ… ì¼ì • ë“±ë¡ ì™„ë£Œ!");
                document.querySelector('iframe').src += ''; // ë‹¬ë ¥ ìƒˆë¡œê³ ì¹¨
            } catch (e) {
                alert("ì‹¤íŒ¨: " + e.message);
            }
        }

        // ì‹œì‘!
        loadData();
        initGoogle();
    </script>
</body>
</html>