<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Pretendard', sans-serif; background-color: #f8f9fa; margin: 0; color: #333; }
        .content-wrapper { max-width: 1200px; width: 96%; margin: 0 auto; }

        /* ìƒë‹¨ í—¤ë” */
        .control-box-bg { 
            background: white; position: sticky; top: 0; z-index: 1000; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 15px 0; 
        }

        .button-row { display: flex; gap: 8px; margin-bottom: 15px; }
        .button-row button {
            flex: 1; padding: 12px; border: none; border-radius: 12px; 
            font-size: 0.95em; font-weight: bold; color: white; cursor: pointer;
            transition: 0.2s;
        }
        #btn-voice { background: #ff6b6b; } 
        #btn-refresh { background: #1dd1a1; }
        #btn-add { background: #a29bfe; } 
        #btn-login { background: #54a0ff; } 

        h1 { margin: 10px 0; font-size: 1.5em; text-align: center; color: #2d3436; }
        
        .input-group { display: flex; gap: 8px; }
        input[type="text"] { 
            flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; 
        }
        #btn-search { width: 80px; background: #636e72; color: white; border: none; border-radius: 10px; font-weight: bold; }

        /* ì¹´ë“œ ë””ìì¸ (ê¹”ë”í•œ ê·¸ë¦¬ë“œ) */
        .card { 
            background: white; padding: 20px; margin-top: 20px; border-radius: 16px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-left: 5px solid #ddd;
        }
        .card.urgent { border-left-color: #ff6b6b; }
        .card.normal { border-left-color: #54a0ff; }

        .card-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9em; color: #636e72; }
        .region-badge { background: #eee; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        .d-day { color: #d63031; font-weight: bold; }

        .card-title { font-size: 1.3em; font-weight: 800; color: #2d3436; display: block; margin-bottom: 15px; text-decoration: none; }

        /* ì •ë³´ ê·¸ë¦¬ë“œ (í•µì‹¬) */
        .info-grid { 
            display: grid; grid-template-columns: 80px 1fr; gap: 6px; font-size: 0.95em; 
            background: #fafafa; padding: 15px; border-radius: 10px;
        }
        .label { color: #b2bec3; font-weight: 600; }
        .value { font-weight: 500; color: #2d3436; word-break: break-all; }
        .highlight { color: #0984e3; font-weight: 800; }
        
        .ai-box { 
            background: #f3e5f5; padding: 12px; border-radius: 8px; margin-top: 15px; 
            font-size: 0.9em; color: #6a1b9a; line-height: 1.5;
        }

        .card-footer { display: flex; justify-content: flex-end; gap: 8px; margin-top: 15px; }
        .btn-sm { padding: 8px 12px; border-radius: 6px; border: none; font-size: 0.85em; cursor: pointer; font-weight: bold; text-decoration: none; }
        .btn-link { background: #dfe6e9; color: #333; }
        .btn-cal { background: #e3f2fd; color: #0984e3; }

        /* ëª¨ë‹¬ */
        #add-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; justify-content:center; align-items:center; }
        .modal-content { background:white; padding:25px; border-radius:15px; width:90%; max-width:500px; }
        textarea { width:100%; height:150px; padding:10px; margin:10px 0; border-radius:8px; border:1px solid #ddd; font-size:14px; resize: none; }
        .modal-btns { display:flex; justify-content:flex-end; gap:10px; }
    </style>
</head>
<body>

    <div class="control-box-bg">
        <div class="content-wrapper">
            <div class="button-row">
                <button id="btn-voice">ğŸ¤ ìŒì„±</button>
                <button id="btn-refresh">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                <button id="btn-add">ğŸ“ ì§ì ‘ë“±ë¡</button> 
                <button id="btn-login">ğŸ“… ë¡œê·¸ì¸</button>
            </div>
            <h1>ğŸ’§ í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬</h1>
            <div class="input-group">
                <input type="text" id="search-input" placeholder="ì˜ˆ: ìš©ì¸ì‹œ, 5ì–µ ì´ìƒ, ë¹—ë¬¼">
                <button id="btn-search">ê²€ìƒ‰</button>
            </div>
            <div id="voice-result" style="text-align:center; color:#e17055; font-size:0.9em; margin-top:5px;"></div>
            <div id="user-info" style="text-align:right; font-size:0.8em; color:#aaa;"></div>
        </div>
    </div>

    <div id="status" style="text-align:center; margin-top:30px; color:#888;"></div>
    <div id="bid-list" class="content-wrapper"></div>

    <div id="add-modal">
        <div class="modal-content">
            <h3>ğŸ“ ê³µê³ ë¬¸ ìŠ¤ë§ˆíŠ¸ ë“±ë¡</h3>
            <p style="font-size:0.9em; color:#666;">ê³µê³  ë‚´ìš©ì„ ë³µì‚¬í•´ ë¶™ì—¬ë„£ìœ¼ë©´ AIê°€ í•­ëª©ë³„ë¡œ ì •ë¦¬í•´ì¤ë‹ˆë‹¤.</p>
            <textarea id="paste-area" placeholder="ê³µê³  ë‚´ìš©ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
            <div class="modal-btns">
                <button onclick="closeModal()" style="background:#ccc; color:white; border:none; padding:10px; border-radius:8px;">ì·¨ì†Œ</button>
                <button onclick="processSmartAdd()" style="background:#a29bfe; color:white; border:none; padding:10px; border-radius:8px; font-weight:bold;">ë¶„ì„ ë° ì €ì¥</button>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        // ğŸš¨ ì„¤ì •ê°’ (ê³ ê°ë‹˜ ì •ë³´ë¡œ ìˆ˜ì • í•„ìš”)
        const GEMINI_API_KEY = 'AIzaSyDu8QKqqTRxutvYqr8GWOUKJLAoT2lZS1k';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxi0Bfdty9LuMJyxCGTqTkyJQJrevz3AqRunbhNmePCh68tta-Fu8w1Lw4E_DROWB99zw/exec';
        const CLIENT_ID = '1049915608396-i3jn8jrm24bc9mkagdtokk3rfa3li513.apps.googleusercontent.com';
        const BID_CALENDAR_ID = 'd51a10e0014dcbd83e98d0da91cda4f52f629c19652c15fc693ee4529bbbab04@group.calendar.google.com';
        
        let allData = [];
        let tokenClient;

        // ë°ì´í„° ë¡œë“œ
        async function loadData() {
            document.getElementById('status').innerText = "â³ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
            try {
                const res = await fetch(SCRIPT_URL);
                const json = await res.json();
                allData = json;
                renderList(allData);
                document.getElementById('status').innerText = `âœ… ì´ ${allData.length}ê±´ ì¡°íšŒë¨`;
            } catch (e) {
                document.getElementById('status').innerText = "âŒ ë¡œë“œ ì‹¤íŒ¨ (Apps Script ë°°í¬ í™•ì¸)";
            }
        }

        // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (16ê°œ í•­ëª© ë°˜ì˜)
        function renderList(data) {
            const list = document.getElementById('bid-list');
            list.innerHTML = "";
            if (data.length === 0) { list.innerHTML = "<div style='text-align:center; padding:50px;'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>"; return; }

            data.forEach(item => {
                const today = new Date();
                const end = new Date(item.deadline);
                const diff = Math.ceil((end - today) / (1000*60*60*24));
                let dDay = diff < 0 ? "ë§ˆê°ë¨" : `D-${diff}`;
                if (diff === 0) dDay = "ì˜¤ëŠ˜ë§ˆê°";

                const div = document.createElement('div');
                div.className = `card ${diff <= 3 ? 'urgent' : 'normal'}`;
                div.innerHTML = `
                    <div class="card-header">
                        <span>No. ${item.no} | <span class="region-badge">${item.region}</span></span>
                        <span class="d-day">${dDay}</span>
                    </div>
                    <a href="${item.link}" target="_blank" class="card-title">${item.title}</a>
                    
                    <div class="info-grid">
                        <span class="label">ë°œì£¼/ìˆ˜ìš”</span> <span class="value">${item.client} / ${item.agency}</span>
                        <span class="label">ìš©ì—­ê¸°ê°„</span> <span class="value">${item.period}</span>
                        <span class="label">ê¸ˆì•¡</span> <span class="value highlight">${item.amount}</span>
                        <span class="label">ì‚¬ì—…ë¹„</span> <span class="value">${item.budget}</span>
                        <span class="label">ë‹´ë‹¹ì</span> <span class="value">${item.manager}</span>
                        <span class="label">ë§ˆê°ì¼</span> <span class="value" style="color:#d63031">${item.deadline}</span>
                        <span class="label">ëŒ€ì§€/í†¤ìˆ˜</span> <span class="value">${item.area} / ${item.ton}</span>
                    </div>

                    ${item.aiResult ? `<div class="ai-box">ğŸ¤– <b>AI ë¶„ì„:</b> ${item.aiResult}</div>` : ''}

                    <div class="card-footer">
                        <a href="${item.link}" target="_blank" class="btn-sm btn-link">ğŸ“„ ê³µê³ ë¬¸</a>
                        <button onclick="addToCal('${item.title}', '${item.deadline}')" class="btn-sm btn-cal">ğŸ“… ìº˜ë¦°ë”</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // ì§ì ‘ë“±ë¡ ì²˜ë¦¬ (AIë¡œ í•„ë“œ ì¶”ì¶œ)
        async function processSmartAdd() {
            const text = document.getElementById('paste-area').value;
            if(!text) return;
            
            const btn = document.querySelector('#add-modal button:last-child');
            btn.innerText = "ë¶„ì„ ì¤‘...";
            
            // 16ê°œ í•­ëª© ì¶”ì¶œ í”„ë¡¬í”„íŠ¸
            const prompt = `í…ìŠ¤íŠ¸ì—ì„œ ë‹¤ìŒ ì •ë³´ë¥¼ ì¶”ì¶œí•´ JSONìœ¼ë¡œ ì¤˜:
            {"title":"ê³µê³ ëª…", "no":"ê³µê³ ë²ˆí˜¸", "region":"ì§€ì—­", "date":"ê³µê³ ì¼(YYYY-MM-DD)", "deadline":"ë§ˆê°ì¼(YYYY-MM-DD HH:mm)", "client":"ë°œì£¼ì²˜", "agency":"ìˆ˜ìš”ê¸°ê´€", "period":"ìš©ì—­ê¸°ê°„", "amount":"ìš©ì—­ê¸ˆì•¡", "budget":"ì‚¬ì—…ë¹„", "manager":"ë‹´ë‹¹ì", "area":"ëŒ€ì§€ë©´ì ", "ton":"ì˜ˆìƒí†¤ìˆ˜", "link":"ë§í¬", "aiResult":"ì´ ê³µì‚¬ì˜ ë¹—ë¬¼ì €ë¥˜ì¡° ê´€ë ¨ì„± ë¶„ì„(1ë¬¸ì¥)"}
            í…ìŠ¤íŠ¸: ${text}`;
            
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const json = await res.json();
                const result = JSON.parse(json.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim());
                
                // Apps Scriptë¡œ ì „ì†¡ (ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ ì¡°ë¦½)
                let url = `${SCRIPT_URL}?action=add`;
                for (let key in result) url += `&${key}=${encodeURIComponent(result[key])}`;
                
                await fetch(url, { mode: 'no-cors' });
                alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                closeModal();
                loadData();
            } catch(e) {
                alert("ì˜¤ë¥˜: " + e.message);
            } finally {
                btn.innerText = "ë¶„ì„ ë° ì €ì¥";
            }
        }

        // ê¸°íƒ€ í•„ìˆ˜ í•¨ìˆ˜ë“¤ (ëª¨ë‹¬, ê²€ìƒ‰, ë¡œê·¸ì¸ ë“±)
        document.getElementById('btn-refresh').onclick = loadData;
        document.getElementById('btn-add').onclick = () => document.getElementById('add-modal').style.display = 'flex';
        function closeModal() { document.getElementById('add-modal').style.display = 'none'; }
        
        // (ìº˜ë¦°ë”, ë¡œê·¸ì¸ ë¡œì§ì€ ê¸°ì¡´ ì½”ë“œ ìœ ì§€ - ì§€ë©´ìƒ ìƒëµí–ˆìœ¼ë‚˜ ì‹¤ì œ íŒŒì¼ì—” í¬í•¨ë˜ì–´ì•¼ í•¨)
        
        // ì´ˆê¸° ì‹¤í–‰
        loadData();
    </script>
</body>
</html>
